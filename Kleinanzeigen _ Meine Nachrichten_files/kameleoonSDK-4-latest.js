!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).KameleoonSDK={})}(this,function(e){"use strict";var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function i(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function a(e){if(Object.prototype.hasOwnProperty.call(e,"__esModule"))return e;var t=e.default;if("function"==typeof t){var i=function e(){var i=!1;try{i=this instanceof e}catch{}return i?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};i.prototype=t.prototype}else i={};return Object.defineProperty(i,"__esModule",{value:!0}),Object.keys(e).forEach(function(t){var a=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(i,t,a.get?a:{enumerable:!0,get:function(){return e[t]}})}),i}var n,o,r,s={},u={},l=(o||(o=1,function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.Err=e.Ok=void 0;var t=function(){if(n)return u;function e(e){if(!this.ok){if("string"==typeof this.error||void 0===this.error)throw new Error(e||this.error||"There was an error! No specific error message was provided.");throw e&&(this.error.message=e),this.error}return this.data}function t(e){return this.ok?this.data:e(this.error)}function i(e){return this.ok?this.data:e}function a(e){return this.ok&&e(this.data),this}return n=1,Object.defineProperty(u,"__esModule",{value:!0}),u.Err=u.Ok=void 0,u.Ok=function(n){return{ok:!0,data:n,throw:e,else:t,or:i,and:a}},u.Err=function(n){return{ok:!1,error:n,throw:e,else:t,or:i,and:a}},u}();Object.defineProperty(e,"Ok",{enumerable:!0,get:function(){return t.Ok}}),Object.defineProperty(e,"Err",{enumerable:!0,get:function(){return t.Err}})}(s)),s);function d(e,t,i,a){return new(i||(i=Promise))(function(t,n){function o(e){try{s(a.next(e))}catch(e){n(e)}}function r(e){try{s(a.throw(e))}catch(e){n(e)}}function s(e){var a;e.done?t(e.value):(a=e.value,a instanceof i?a:new i(function(e){e(a)})).then(o,r)}s((a=a.apply(e,[])).next())})}"function"==typeof SuppressedError&&SuppressedError,e.KameleoonException=void 0,(r=e.KameleoonException||(e.KameleoonException={})).Credentials="Credentials",r.EventSourceInitialization="EventSourceInitialization",r.FeatureFlagConfigurationNotFound="FeatureFlagConfigurationNotFound",r.FeatureFlagVariableNotFound="FeatureFlagVariableNotFound",r.FeatureFlagVariationNotFound="FeatureFlagVariationNotFound",r.FeatureFlagExperimentNotFound="FeatureFlagExperimentNotFound",r.FeatureFlagEnvironmentDisabled="FeatureFlagEnvironmentDisabled",r.VisitAmount="VisitAmount",r.VisitorCodeMaxLength="VisitorCodeMaxLength",r.VisitorCodeEmpty="VisitorCodeEmpty",r.StorageInitialization="StorageInitialization",r.StorageWrite="StorageWrite",r.StorageRead="StorageRead",r.StorageParse="StorageParse",r.StorageEmpty="StorageEmpty",r.ClientConfiguration="ClientConfiguration",r.TargetingCondition="TargetingCondition",r.AmongValuesCheck="AmongValuesCheck",r.RangeCheck="RangeCheck",r.Initialization="Initialization",r.JSONParse="JSONParse",r.NumberParse="NumberParse",r.VersionParse="VersionParse",r.CookieParse="CookieParse",r.SemanticVersionParse="SemanticVersionParse",r.RemoteData="RemoteData",r.MaximumRetriesReached="MaximumRetriesReached";const c={[e.KameleoonException.CookieParse]:e=>`Couldn't parse cookie string: ${e}`,[e.KameleoonException.JSONParse]:e=>`Couldn't parse JSON variable: ${e}`,[e.KameleoonException.NumberParse]:e=>`It's not possible to parse value ${e} to Number`,[e.KameleoonException.VersionParse]:e=>`It's not possible to parse a version value ${e} to Number, version should be in format x.x`,[e.KameleoonException.SemanticVersionParse]:e=>`It's not possible to parse a version value ${e} to Number, version should be in format x.x.x`,[e.KameleoonException.Initialization]:()=>"It seems that the client wasn't properly initialized, make sure to run `initialize` method before invoking other methods",[e.KameleoonException.Credentials]:()=>"KameleoonClient can not be created without credentials",[e.KameleoonException.StorageInitialization]:()=>"There was an error while initializing React Native SDK storage, it seems that the storage library dependency wasn't installed",[e.KameleoonException.EventSourceInitialization]:()=>"There was an error while initializing Real Time Update service, it seems that the event source library dependency wasn't installed",[e.KameleoonException.FeatureFlagConfigurationNotFound]:e=>`No feature flag with key ${e} was found.`,[e.KameleoonException.FeatureFlagEnvironmentDisabled]:(e,t)=>`Feature flag with key ${e} is disabled in ${t} environment.`,[e.KameleoonException.FeatureFlagVariableNotFound]:(e,t)=>`No feature flag variable with key ${e} was found for ${t} visitorCode.`,[e.KameleoonException.FeatureFlagVariationNotFound]:(e,t)=>`No feature flag variation with key ${e} was found for ${t} visitorCode.`,[e.KameleoonException.FeatureFlagExperimentNotFound]:(e,t)=>`No feature flag experiment with id ${e} was found for ${t} visitorCode.`,[e.KameleoonException.VisitAmount]:()=>"Visit amount must be a number between 1 and 25",[e.KameleoonException.VisitorCodeMaxLength]:()=>"Visitor code can not be more than 255 characters long",[e.KameleoonException.VisitorCodeEmpty]:()=>"Visitor code can not be empty",[e.KameleoonException.StorageWrite]:e=>`Couldn't update storage for kameleoonClient: ${e}`,[e.KameleoonException.StorageRead]:e=>`No data found in storage under ${e} key`,[e.KameleoonException.StorageEmpty]:()=>"No data found in storage",[e.KameleoonException.StorageParse]:(e,t)=>`Couldn't parse ${t} storage data, the data may be corrupted. Error: ${e}`,[e.KameleoonException.ClientConfiguration]:e=>`Couldn't retrieve client configuration from Kameleoon Api. Error: ${e}`,[e.KameleoonException.TargetingCondition]:e=>`${e} targeting condition is not yet supported.`,[e.KameleoonException.AmongValuesCheck]:(e,t)=>`Couldn't parse value "${t}": ${e}`,[e.KameleoonException.RangeCheck]:e=>`Couldn't parse value "${e}" as a range, value should be in format [x: number, y: number]`,[e.KameleoonException.RemoteData]:e=>`Couldn't retrieve data from Kameleoon server. Error: ${e}`,[e.KameleoonException.MaximumRetriesReached]:e=>`Maximum retries reached, request failed. Reason: ${e}`};function g(e){throw new Error(`Reaching an impossible state because of ${e}`)}class h extends Error{constructor(t,i,a){switch(super(`Error: ${t}`),this.name="KameleoonError",this.errorType=t,t){case e.KameleoonException.Initialization:case e.KameleoonException.Credentials:case e.KameleoonException.VisitorCodeMaxLength:case e.KameleoonException.VisitorCodeEmpty:case e.KameleoonException.StorageInitialization:case e.KameleoonException.VisitAmount:case e.KameleoonException.EventSourceInitialization:case e.KameleoonException.StorageEmpty:this.message=c[t]();break;case e.KameleoonException.CookieParse:case e.KameleoonException.FeatureFlagConfigurationNotFound:case e.KameleoonException.NumberParse:case e.KameleoonException.ClientConfiguration:case e.KameleoonException.MaximumRetriesReached:case e.KameleoonException.RemoteData:case e.KameleoonException.VersionParse:case e.KameleoonException.SemanticVersionParse:this.message=c[t](i);break;case e.KameleoonException.FeatureFlagExperimentNotFound:case e.KameleoonException.FeatureFlagVariationNotFound:case e.KameleoonException.FeatureFlagVariableNotFound:this.message=c[t](i,a);break;case e.KameleoonException.FeatureFlagEnvironmentDisabled:this.message=void 0!==a?c[t](i,a):i;break;case e.KameleoonException.StorageWrite:case e.KameleoonException.JSONParse:case e.KameleoonException.StorageRead:this.message=c[t](i);break;case e.KameleoonException.StorageParse:this.message=c[t](i,a);break;case e.KameleoonException.TargetingCondition:this.message=c[t](i);break;case e.KameleoonException.AmongValuesCheck:this.message=c[t](i,a);break;case e.KameleoonException.RangeCheck:this.message=c[t](i);break;default:g(t)}}get type(){return this.errorType}}var p,v,m,f,C;!function(e){e.DataApi="dataApi",e.Events="events",e.ClientConfiguration="clientConfiguration"}(p||(p={})),e.HttpMethod=void 0,(v=e.HttpMethod||(e.HttpMethod={})).Get="GET",v.Post="POST",function(e){e[e.VisitEvent=0]="VisitEvent",e[e.VisitData=1]="VisitData",e[e.DataMap=2]="DataMap"}(m||(m={})),e.RequestType=void 0,(f=e.RequestType||(e.RequestType={})).Configuration="configuration",f.Tracking="tracking",f.RemoteData="remoteData",e.Header=void 0,(C=e.Header||(e.Header={})).UserAgent="User-Agent",C.ContentType="Content-Type",C.SdkVersion="X-Kameleoon-SDK-Version",C.SdkType="X-Kameleoon-SDK-Type",C.Authorization="Authorization",C.AcceptEncoding="Accept-Encoding",C.IfModifiedSince="If-Modified-Since",C.LastModified="Last-Modified";const y="eventType=staticData",D="&browserIndex=",E="&browserVersion=",T="&deviceType=",I="&visitorCode=",k="&nonce=",S="&id=",V="&maxNumberPreviousVisits=",w="&os=",R="&osIndex=",b="&browser=",K="&mappingValue=",A="visit/",x={[p.DataApi]:"data.kameleoon.io",[p.Events]:"events.kameleoon.eu",[p.ClientConfiguration]:"sdk-config.kameleoon.eu"};var O;e.LogLevel=void 0,(O=e.LogLevel||(e.LogLevel={}))[O.NONE=0]="NONE",O[O.ERROR=1]="ERROR",O[O.WARNING=2]="WARNING",O[O.INFO=3]="INFO",O[O.DEBUG=4]="DEBUG";const $={[e.LogLevel.NONE]:"NONE",[e.LogLevel.ERROR]:"ERROR",[e.LogLevel.WARNING]:"WARNING",[e.LogLevel.INFO]:"INFO",[e.LogLevel.DEBUG]:"DEBUG"},N=(e,t)=>"credentials"===e?{clientId:"****",clientSecret:"****"}:t instanceof Map?Array.from(t.entries()):t;class M{static setLogger(e){M.logger=e}static setLogLevel(e){M.logLevel=e}static log({level:e,strings:t,keys:i}){if(!M.checkLevel(e))return;let a;if("string"==typeof t)a=t;else if("function"==typeof t)try{a=t()}catch(e){a="Failed to log message"}else a=function(e,t){let i="";if(t)for(let a=0;a<t.length;a++){let n=t[a];if("object"==typeof n)try{i+=e[a]+JSON.stringify(n,N)}catch(t){i+=e[a]+"{object}"}else i+="string"==typeof n?e[a]+"'"+n+"'":e[a]+n}return i+=e[e.length-1],i}(t,i);M.writeMessage(e,a)}static info(t,...i){M.log({level:e.LogLevel.INFO,strings:t,keys:i})}static error(t,...i){M.log({level:e.LogLevel.ERROR,strings:t,keys:i})}static warning(t,...i){M.log({level:e.LogLevel.WARNING,strings:t,keys:i})}static debug(t,...i){M.log({level:e.LogLevel.DEBUG,strings:t,keys:i})}static checkLevel(t){return t<=M.logLevel&&t!==e.LogLevel.NONE}static writeMessage(e,t){M.logger.log(e,`Kameleoon [${$[e]}]: ${t}`)}}M.logger=new class{log(t,i){switch(t){case e.LogLevel.DEBUG:console.debug(i);break;case e.LogLevel.INFO:console.info(i);break;case e.LogLevel.WARNING:console.warn(i);break;case e.LogLevel.ERROR:console.error(i)}}},M.logLevel=e.LogLevel.WARNING;let F=class{constructor({urlProvider:e,packageInfo:t,externalRequester:i,requestTimeout:a,trackRetryDelay:n,useAbortController:o}){M.debug`CALL: new Requester(urlProvider, packageInfo: ${t}, externalRequester, requestTimeout: ${a}, trackRetryDelay: ${n}, useAbortController: ${o})`,this.urlProvider=e,this.useAbortController=o,this.externalRequester=i,this.trackRetryDelay=n,this.packageInfo=t,this.timeout=a,M.debug`RETURN: new Requester(urlProvider, packageInfo: ${t}, externalRequester, requestTimeout: ${a}, trackRetryDelay: ${n}, useAbortController: ${o})`}getClientConfiguration(t,i){return d(this,0,void 0,function*(){const a=this.urlProvider.getClientConfigurationUrl(t);let n=Object.assign({[e.Header.SdkType]:this.packageInfo.type.toLowerCase(),[e.Header.SdkVersion]:this.packageInfo.version},i&&{[e.Header.IfModifiedSince]:i});try{let t={message:""};M.debug`Running configuration request Method: ${e.HttpMethod.Get}, Url: ${a}, Headers: ${n}, with retry limit ${2}`;for(let i=0;i<2;i++){const o=yield this.sendRequest({url:a,requestType:e.RequestType.Configuration,retryCount:i,parameters:{method:e.HttpMethod.Get,headers:n}});if(o.ok){const e=yield o.json();this.logReceivedConfigurationResponse(o.status,a,n);const t=this.getLastModifiedHeader(o),i=e;return l.Ok({configuration:i,lastModified:t})}if(304===o.status)return this.logReceivedConfigurationResponse(o.status,a,n),l.Ok({});if(1===i){if(o.text){const e=yield o.text();t=JSON.parse(e)}M.error`Failed to get configuration response ${{status:o.status,message:t.message}} for request Method: ${e.HttpMethod.Get}, Url: ${a}, Headers: ${n}`}else yield this.logRequestError({logLevel:e.LogLevel.WARNING,message:"Failed to get configuration response",response:o,method:e.HttpMethod.Get,url:a})}return l.Err(new h(e.KameleoonException.MaximumRetriesReached,t.message))}catch(t){return yield this.logRequestError({logLevel:e.LogLevel.ERROR,message:"Failed to get configuration response",error:t,method:e.HttpMethod.Get,url:a,headers:n}),l.Err(new h(e.KameleoonException.ClientConfiguration,t))}})}getRemoteData(t){var i;return d(this,0,void 0,function*(){const a=this.urlProvider.getRemoteDataUrl(t);M.debug`Running remote data request Method: ${e.HttpMethod.Get}, Url: ${a}`;try{const t=yield this.sendRequest({url:a,requestType:e.RequestType.RemoteData,retryCount:0,parameters:{method:e.HttpMethod.Get}});if(!t.ok){if(yield this.logRequestError({logLevel:e.LogLevel.ERROR,message:"Failed to get remote data response",response:t,method:e.HttpMethod.Get,url:a}),t.text){const a=yield t.text(),n=null===(i=JSON.parse(a))||void 0===i?void 0:i.message;return l.Err(new h(e.KameleoonException.RemoteData,n))}return l.Err(new h(e.KameleoonException.RemoteData,"Unknown Reason - no `text()` was found for a response"))}const n=yield t.json();return M.debug`Received remote data response: ${{status:t.status}} for request Method: ${e.HttpMethod.Get}, Url: ${a}`,l.Ok(n)}catch(t){return yield this.logRequestError({logLevel:e.LogLevel.ERROR,message:"Failed to get remote data response",error:t,method:e.HttpMethod.Get,url:a}),l.Err(new h(e.KameleoonException.RemoteData,t))}})}getVisitorData({visitorCode:t,filters:i,isMappingIdentifier:a}){var n;return d(this,0,void 0,function*(){const o=this.urlProvider.getVisitorDataUrl({visitorCode:t,filters:i,isMappingIdentifier:a});M.debug`Running visitor data request Method: ${e.HttpMethod.Get}, Url: ${o}`;try{const t=yield this.sendRequest({url:o,requestType:e.RequestType.RemoteData,retryCount:0,parameters:{method:e.HttpMethod.Get}});if(!t.ok){if(yield this.logRequestError({logLevel:e.LogLevel.ERROR,message:"Failed to get visitor data response",response:t,method:e.HttpMethod.Get,url:o}),"function"==typeof t.text){const i=yield t.text();if(i){const t=null===(n=JSON.parse(i))||void 0===n?void 0:n.message;return l.Err(new h(e.KameleoonException.RemoteData,t))}}return t.status?l.Err(new h(e.KameleoonException.RemoteData,`No error message. Error status: ${t.status}`)):l.Err(new h(e.KameleoonException.RemoteData,"Unknown Reason - no text message or error status was found for a response"))}const i=yield t.json();return M.debug`Received visitor data response: ${{status:t.status}} for request Method: ${e.HttpMethod.Get}, Url: ${o}`,l.Ok(i)}catch(t){return yield this.logRequestError({logLevel:e.LogLevel.ERROR,message:"Failed to get visitor data response",error:t,method:e.HttpMethod.Get,url:o}),l.Err(new h(e.KameleoonException.RemoteData,t))}})}track(t,i){return d(this,0,void 0,function*(){const a=this.urlProvider.getTrackingUrl(i);M.debug`Running tracking request Method: ${e.HttpMethod.Post}, Url: ${a}, Body: ${t}, with retry limit ${2}, retry delay ${this.trackRetryDelay} ms`;for(let i=0;i<2;i++){let n;try{if(n=yield this.sendRequest({url:a,retryCount:i,requestType:e.RequestType.Tracking,parameters:{body:t,method:e.HttpMethod.Post,headers:{[e.Header.ContentType]:"*/*"}}}),n.ok)return M.debug`Received tracking response: ${{status:n.status}} for request Method: ${e.HttpMethod.Post}, Url: ${a}, Body: ${t}`,l.Ok();yield this.logRequestError({logLevel:1==i?e.LogLevel.ERROR:e.LogLevel.WARNING,message:"Failed to get tracking response",response:n,method:e.HttpMethod.Post,url:a})}catch(t){yield this.logRequestError({logLevel:1==i?e.LogLevel.ERROR:e.LogLevel.WARNING,message:"Failed to get tracking response",error:t,method:e.HttpMethod.Post,url:a})}i<2&&(yield new Promise(e=>setTimeout(e,this.trackRetryDelay)))}return l.Err()})}sendRequest({url:e,requestType:t,retryCount:i,parameters:a}){return d(this,0,void 0,function*(){let n;if(this.useAbortController){const o=new AbortController,r=setTimeout(()=>o.abort(),this.timeout);n=yield this.externalRequester.sendRequest({url:e,retryCount:i,requestType:t,parameters:Object.assign(Object.assign({},a),{signal:o.signal})}),clearTimeout(r)}else n=yield this.externalRequester.sendRequest({url:e,retryCount:i,requestType:t,parameters:a});return n})}logRequestError({logLevel:e,message:t,error:i,method:a,url:n,response:o,headers:r}){return d(this,0,void 0,function*(){if(i){let o="Unknown error";i instanceof Error&&(o=i.message),M.log({level:e,strings:()=>`${t} with error: ${o} for request Method: ${a}, Url: ${n}`})}else if(o&&M.checkLevel(e)){const i=yield this.parseResponse(o);M.log({level:e,strings:()=>`${t} response: Status: '${i.status}' Message: '${i.message}' for request Method: ${a}, Url: '${n}'`+(r?`, Headers: ${r}`:"")})}})}parseResponse(e){return d(this,0,void 0,function*(){let t="";try{if("function"==typeof e.text){const i=yield e.text();i&&(t=i)}}catch(e){}return{status:e.status,message:t}})}getLastModifiedHeader(t){if(t.headers){const i=e.Header.LastModified.toLowerCase();for(const[e,a]of t.headers)if(e.toLowerCase()===i)return a}}logReceivedConfigurationResponse(t,i,a){M.debug`Received configuration response: ${{status:t}} for request Method: ${e.HttpMethod.Get}, Url: ${i}, Headers: ${a}`}};var L,_,U,P,B,G,z,j,q,H,W,Y;e.Environment=void 0,(L=e.Environment||(e.Environment={})).Production="production",L.Staging="staging",L.Development="development";class J{constructor(){this.ready=!1,this.isCustomDomain=!1,this.domains=x}initialize({domain:e,siteCode:t,packageInfo:i,environment:a}){this.siteCode=t,this.environment=a,this.packageInfo=i,this.ready=!0,this.setDomains(e)}set dataApiDomain(e){if(!this.isCustomDomain)return void(this.domains[p.DataApi]=e);const t=e.split(".")[0],i=this.domains[p.DataApi];this.domains[p.DataApi]=i.replace(/^[^.]+/,t)}get dataApiDomain(){return this.domains[p.DataApi]}getClientConfigurationUrl(t){this.isInitialized();const i=`https://${this.domains[p.ClientConfiguration]}/v3/`,a=this.environment===e.Environment.Production?"":"?environment="+encodeURIComponent(this.environment);let n="";return t&&(n=a?"&ts="+t:"?ts="+t),i+this.siteCode+a+n}getEventSourceUrl(){return this.isInitialized(),`https://${this.domains[p.Events]}:8110/sse?siteCode=${this.siteCode}`}getRemoteDataUrl(e){return this.isInitialized(),this.getDataApiUrl(m.DataMap)+this.siteCode+"&key="+encodeURI(e)}getVisitorDataUrl({visitorCode:e,filters:t,isMappingIdentifier:i}){this.isInitialized();const{customData:a,previousVisitAmount:n,currentVisit:o,conversions:r,geolocation:s,experiments:u,pageViews:l,device:d,browser:c,operatingSystem:g,kcs:h,personalization:p,visitorCode:v,cbs:f}=t,C=i?K:I,y=a||v?"&customData="+!0:"",D=r?"&conversion="+!0:"",E=s?"&geolocation="+!0:"",T=u?"&experiment="+!0:"",k=l?"&page="+!0:"",S="&staticData="+!0,w=o?"&currentVisit="+!0:"",R=h?"&kcs="+!0:"",b=p?"&personalization="+!0:"",A="number"!=typeof n?V+1:V+n,x=f?"&cbs="+!0:"";return this.getDataApiUrl(m.VisitData)+this.siteCode+C+e+A+y+D+E+T+k+S+w+R+b+x}getTrackingUrl(e){this.isInitialized();const{type:t,version:i}=this.packageInfo;let a=this.getDataApiUrl(m.VisitEvent)+this.siteCode+"&sdkName="+t.toLowerCase()+"&sdkVersion="+i;return e&&(a+="&bodyUa="+!0),a}isInitialized(){if(!this.ready)throw new Error("UrlProvider is not initialized")}getDataApiUrl(e){if(!this.domains[p.DataApi])throw new Error("Data API domain is not set");const t=`https://${this.domains[p.DataApi]}`;switch(e){case m.VisitEvent:return`${t}/${A+"events?siteCode="}`;case m.VisitData:return`${t}/${A+"visitor?siteCode="}`;case m.DataMap:return`${t}/map/map?siteCode=`}}setDomains(e){e&&(this.isCustomDomain=!0,this.domains[p.DataApi]="data."+e,this.domains[p.Events]="events."+e,this.domains[p.ClientConfiguration]="sdk-config."+e)}}e.VariableType=void 0,(_=e.VariableType||(e.VariableType={})).BOOLEAN="BOOLEAN",_.NUMBER="NUMBER",_.STRING="STRING",_.JSON="JSON",_.JS="JS",_.CSS="CSS",e.TrackingStatus=void 0,(U=e.TrackingStatus||(e.TrackingStatus={})).Sent="sent",U.Unsent="unsent",U.Pending="pending",e.Milliseconds=void 0,(P=e.Milliseconds||(e.Milliseconds={}))[P.Second=1e3]="Second",P[P.Minute=6e4]="Minute",P[P.Hour=36e5]="Hour",P[P.Day=864e5]="Day",P[P.Week=6048e5]="Week",P[P.Month=2592e6]="Month";class X{constructor(t){this.cacheMap=new Map,this.intervalId=null,this.cleanupTimeout=t*e.Milliseconds.Second}add({key:t,data:i,lifetime:a}){M.debug`CALL: CacheManager.add(key: ${t}, data: ${i}, lifetime: ${a})`,null===this.intervalId&&this.activate();const n=a*e.Milliseconds.Second,o={data:i,expirationTime:Date.now()+n};this.cacheMap.set(t,o),M.debug`RETURN: CacheManager.add(key: ${t}, data: ${i}, lifetime: ${a})`}getAliveItem(e){M.debug`CALL: CacheManager.getAliveItem(key: ${e})`;const t=this.cacheMap.get(e);if(t&&t.expirationTime>=Date.now()){const i=t.data;return M.debug`RETURN: CacheManager.getAliveItem(key: ${e}) -> (item: ${i})`,i}return t&&this.cacheMap.delete(e),M.debug`RETURN: CacheManager.getAliveItem(key: ${e}) -> (item: null)`,null}activate(){this.intervalId=setInterval(()=>{const e=Date.now();for(const[t,i]of this.cacheMap)i.expirationTime<e&&this.cacheMap.delete(t);this.cacheMap.size||this.cleanupInterval()},this.cleanupTimeout)}cleanupInterval(){this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null)}}!function(e){e[e.Polling=0]="Polling",e[e.RealTime=1]="RealTime"}(B||(B={})),function(e){e.TARGETED_DELIVERY="TARGETED_DELIVERY",e.EXPERIMENTATION="EXPERIMENTATION"}(G||(G={})),function(e){e.ANDROID="ANDROID",e.SWIFT="SWIFT",e.JAVA="JAVA",e.CSHARP="CSHARP",e.NODEJS="NODEJS",e.PHP="PHP",e.RUBY="RUBY",e.GO="GO",e.FLUTTER="FLUTTER",e.REACTJS="REACTJS"}(z||(z={})),function(e){e.ACTIVATED="ACTIVATED",e.DEACTIVATED="DEACTIVATED",e.SCHEDULED="SCHEDULED"}(j||(j={})),e.CustomDataScope=void 0,(q=e.CustomDataScope||(e.CustomDataScope={})).Visit="VISIT",q.Visitor="VISITOR",q.Page="Page",function(e){e.Required="REQUIRED",e.NotRequired="NOT_REQUIRED"}(H||(H={})),function(e){e.PartiallyBlocked="PARTIALLY_BLOCK",e.CompletelyBlocked="FULLY_BLOCK"}(W||(W={}));class Q{addEventHandler(e,t){this.eventHandlers||(this.eventHandlers=new Map),this.eventHandlers.set(e,t)}fireEvent(e,t){var i;const a=null===(i=this.eventHandlers)||void 0===i?void 0:i.get(e);a&&t&&a(t)}}e.EventType=void 0,(Y=e.EventType||(e.EventType={})).Evaluation="evaluation",Y.ConfigurationUpdate="configurationUpdate";const Z={customData:[],featureFlags:[],configuration:{realTimeUpdate:!1,consentType:H.NotRequired,dataApiDomain:"data.kameleoon.io",consentOptOutBehavior:W.PartiallyBlocked}};class ee{constructor(e){this._featureFlags=e.slice().sort((e,t)=>e.id-t.id)}getFeatureFlagByHash(e){let t=Math.floor(e*this._featureFlags.length);return t=Math.min(t,this._featureFlags.length-1),this._featureFlags[t]}get featureFlags(){return this._featureFlags}}class te{constructor({updateInterval:t,urlProvider:i,storage:a,requester:n,dataManager:o,eventSource:r,externalVisitorCodeManager:s,eventManager:u,externalPackageInfo:l,defaultDataFile:d}){this.updateConfigurationIntervalId=null,this.updateType=B.Polling,this.configurationData=Z,this.featureFlagsData=new Map,this.isTargetedDeliveryRule=null,this.segmentsData=null,this.holdoutData=null,this.meGroupsData=new Map,this.mappedRules=null,this.mappedExperiments=null,this.usedDefaultDataFile=!1,this.blockingBehaviourMode=W.PartiallyBlocked,this.CACHE_REVALIDATE_PERIOD=90*e.Milliseconds.Minute,this.urlProvider=i,this.requester=n,this.updateInterval=t,this.lastUpdate=new Date,this.storage=a,this.dataManager=o,this.eventManager=u,this.visitorCodeManager=s,this.eventSource=r,this.externalPackageInfo=l,this.defaultDataFile=d}initialize(){return d(this,0,void 0,function*(){if(M.debug("CALL: ClientConfiguration.initialize()"),this.readStorageData(),this.checkShouldUpdate()){const e=yield this.updateClientConfiguration();if(!e.ok)return M.error("Error occurred during client configuration update"),e;if(e.data)return M.debug("RETURN: ClientConfiguration.initialize()"),l.Ok()}return this.updateType!==B.RealTime||this.eventSource.isOpen?(this.updateType===B.Polling&&this.handlePollingUpdates(),M.debug("RETURN: ClientConfiguration.initialize()"),l.Ok()):(this.handleRealTimeUpdates(),M.debug("RETURN: ClientConfiguration.initialize()"),l.Ok())})}cleanupHandlers(){this.eventSource.isOpen&&this.eventSource.close(),this.updateConfigurationIntervalId&&clearInterval(this.updateConfigurationIntervalId)}handleRealTimeUpdates(){this.cleanupHandlers(),this.eventSource.open(t=>{this.updateClientConfiguration(t).then(i=>{i.ok&&this.eventManager.fireEvent(e.EventType.ConfigurationUpdate,{timestamp:t})})}),this.eventSource.onError(e=>{M.error`Error occurred during real-time update: ${e}. Switching to polling updates while the connection is not restored.`,this.updateType=B.Polling,this.handlePollingUpdates()})}handlePollingUpdates(){this.cleanupHandlers();try{const e=this.lastUpdate.getTime(),t=Date.now(),i=Math.max(this.updateInterval-(t-e),0);setTimeout(()=>d(this,0,void 0,function*(){yield this.updateClientConfiguration(),this.updateConfigurationIntervalId=setInterval(this.updateClientConfiguration.bind(this),this.updateInterval)}),i)}catch(e){throw this.updateConfigurationIntervalId&&clearInterval(this.updateConfigurationIntervalId),e}}get featureFlags(){return this.featureFlagsData}get configuration(){return this.configurationData.configuration}get segments(){if(this.segmentsData)return this.segmentsData;const e=new Map;return this.featureFlagsData.forEach(t=>{t.rules.forEach(t=>{t.segment&&!e.has(t.segment.id.toString())&&e.set(t.segment.id.toString(),t.segment)})}),this.segmentsData=e,e}get ruleMap(){var e;if(null===(e=this.mappedRules)||void 0===e?void 0:e.size)return this.mappedRules;const t=new Map;for(const e of this.featureFlags.values())for(const i of e.rules){const{id:a,experimentId:n,variationByExposition:o}=i,r=new Map;o.forEach(({variationKey:e,variationId:t})=>{"number"==typeof t&&r.set(e,t)}),t.set(a,{featureId:e.id,experimentId:n,variations:r})}return this.mappedRules=t,t}get experimentMap(){var e;if(null===(e=this.mappedExperiments)||void 0===e?void 0:e.size)return this.mappedExperiments;const t=new Map;for(const e of this.featureFlags.values())for(const i of e.rules){const{experimentId:e,variationByExposition:a}=i,n=new Map;a.forEach(({variationKey:e,variationId:t})=>{"number"==typeof t&&n.set(e,t)}),t.set(e,{type:i.type,variations:n})}return this.mappedExperiments=t,t}get holdout(){return this.holdoutData}get meGroups(){return this.meGroupsData}get isConsentRequired(){return this.configuration.consentType===H.Required}get consentBlockingBehaviour(){return this.blockingBehaviourMode}get hasAnyTargetedDeliveryRule(){if(null!==this.isTargetedDeliveryRule)return this.isTargetedDeliveryRule;for(const e of this.featureFlags.values())if(e.environmentEnabled&&e.rules.some(e=>e.type===G.TARGETED_DELIVERY))return!0;return!1}checkShouldUpdate(){const{configuration:e}=this.configurationData;return this.updateType=e.realTimeUpdate?B.RealTime:B.Polling,!this.featureFlags.size||this.lastUpdate.getTime()<Date.now()-this.updateInterval}readStorageData(){var e,t,i;M.debug("CALL: ClientConfiguration.readStorageData()");const a=this.storage.read();if(a.ok){let{data:n,lastUpdate:o,lastModified:r,requestTime:s}=a.data,u=!1;if(this.defaultDataFile)try{const a=JSON.parse(this.defaultDataFile);this.defaultDataFile=void 0,this.usedDefaultDataFile=!0;const o=null!==(t=null!==(e=n.dateModified)&&void 0!==e?e:s)&&void 0!==t?t:-1,r=null!==(i=a.dateModified)&&void 0!==i?i:0;(!s||r>o)&&(n=a,u=!0)}catch(e){M.error`Error parsing default data file: ${String(e)}`}this.updateConfigurationData(n,u),this.lastUpdate=this.usedDefaultDataFile?new Date(0):new Date(Date.parse(o)),this.lastModified=r,this.requestTime=s}M.debug`RETURN: ClientConfiguration.readStorageData() -> (result: ${a.ok})`}updateClientConfiguration(e){return d(this,0,void 0,function*(){const t=Date.now();if(this.usedDefaultDataFile)return this.updateClientConfigurationInBackground(),l.Ok(!1);if(this.requestTime&&!e&&!this.externalPackageInfo.isServer){if(t-this.requestTime<=this.CACHE_REVALIDATE_PERIOD)return this.updateClientConfigurationInBackground(),l.Ok(!1);M.debug`Cached configuration data has expired. Fetching fresh data.`}const i=yield this.requester.getClientConfiguration(e,this.lastModified);return this.applyNewConfigurationDataFromResponse(i)})}updateClientConfigurationInBackground(){setTimeout(()=>d(this,0,void 0,function*(){const e=yield this.requester.getClientConfiguration(void 0,this.lastModified);yield this.applyNewConfigurationDataFromResponse(e)}),0)}applyNewConfigurationDataFromResponse(e){var t,i;return d(this,0,void 0,function*(){if(this.requestTime=Date.now(),!e.ok)return this.featureFlags.size?(M.error("Error occurred while updating configuration. Existing configuration will be used as a fallback."),l.Ok(!0)):e;if(void 0===e.data.configuration)return this.updateStorageData(),l.Ok(!1);const a=e.data.configuration;this.updateConfigurationData(a,!0),this.dataManager.clearTrees(),null===(t=this.mappedRules)||void 0===t||t.clear(),null===(i=this.experimentMap)||void 0===i||i.clear(),this.isTargetedDeliveryRule=null,e.data.lastModified&&(this.lastModified=e.data.lastModified);const n=this.updateStorageData();if(!n.ok)return n;const o=a.configuration.realTimeUpdate?B.RealTime:B.Polling,r=o!==this.updateType;return r&&(this.updateType=o,M.info`Configuration update type was toggled to ${B[o]}`,yield this.initialize()),this.blockingBehaviourMode=this.consentBlockingBehaviourFromStr(a.configuration.consentOptOutBehavior),l.Ok(r)})}updateConfigurationData(e,t=!0){const{configuration:i,featureFlags:a,customData:n,holdout:o,segments:r,dateModified:s}=e;let u=r?new Map(r.map(e=>[e.id.toString(),e])):null,l=null;if(t&&(null==n?void 0:n.length)){l=new Map;for(let e of n){if(void 0===e.id){l=null;break}l.set(e.id,e.index)}}const d=new Map;for(const e of a)d.set(e.featureKey,e),t&&(this.updateFeatureFlagSegments(e,u),this.updateFeatureFlagBucketingCustomDataId(e,l));this.featureFlagsData=d,(null==n?void 0:n.length)&&(this.dataManager.customDataIndexes=n),this.meGroupsData=this.makeMEGroups(a),this.holdoutData=null!=o?o:null,this.configurationData={configuration:i,customData:n,holdout:o,dateModified:s},this.urlProvider.dataApiDomain=e.configuration.dataApiDomain,this.updateConsentRequired(),this.segmentsData=u}updateFeatureFlagSegments(e,t){null!==t&&e.rules.forEach(e=>{var i;const a=e.segmentId;e.segment=null!=a&&null!==(i=t.get(a.toString()))&&void 0!==i?i:null})}updateFeatureFlagBucketingCustomDataId(e,t){const i=e.bucketingCustomDataId;null!=i&&t&&(e.bucketingCustomDataIndex=t.get(i))}makeMEGroups(e){const t=new Map;e.forEach(e=>{const i=e.mutuallyExclusiveGroup;if(i){let a=t.get(i);a?a.push(e):t.set(i,[e])}});const i=new Map;return t.forEach((e,t)=>{i.set(t,new ee(e))}),i}updateStorageData(){this.lastUpdate=new Date;const e={data:Object.assign(Object.assign({},this.configurationData),{featureFlags:Array.from(this.featureFlags.values()),segments:this.segmentsData?Array.from(this.segmentsData.values()):void 0}),lastUpdate:this.lastUpdate.toString(),lastModified:this.lastModified,requestTime:this.requestTime};return this.storage.write(e)}updateConsentRequired(){this.visitorCodeManager.consentRequired=this.isConsentRequired&&!this.hasAnyTargetedDeliveryRule}consentBlockingBehaviourFromStr(e){return e===W.PartiallyBlocked||e===W.CompletelyBlocked?e:(M.error(`Unexpected consent blocking type '${e}'`),W.PartiallyBlocked)}}function ie(e){return Object.fromEntries(Object.entries(e).map(([e,t])=>[t,e]))}var ae,ne,oe,re;e.KameleoonData=void 0,(ae=e.KameleoonData||(e.KameleoonData={})).UniqueIdentifier="uniqueIdentifier",ae.CustomData="customData",ae.PageView="pageView",ae.GeolocationData="geolocation",ae.Browser="browser",ae.Conversion="conversion",ae.Cookie="cookie",ae.Device="device",ae.OperatingSystem="operatingSystem",ae.UserAgent="userAgent",ae.ApplicationVersion="applicationVersion",ae.VisitsData="visitsData",ae.KameleoonConversionScore="kameleoonConversionScore",ae.Personalization="personalization",ae.CBScores="cbScores",ae.TargetedSegment="targetedSegment",e.DeviceType=void 0,(ne=e.DeviceType||(e.DeviceType={})).Phone="PHONE",ne.Tablet="TABLET",ne.Desktop="DESKTOP",e.OperatingSystemType=void 0,(oe=e.OperatingSystemType||(e.OperatingSystemType={})).WindowsPhone="WINDOWS_PHONE",oe.Windows="WINDOWS",oe.Android="ANDROID",oe.Linux="LINUX",oe.Mac="MAC",oe.IOS="IOS",e.BrowserType=void 0,(re=e.BrowserType||(e.BrowserType={})).Chrome="CHROME",re.InternetExplorer="IE",re.Firefox="FIREFOX",re.Safari="SAFARI",re.Opera="OPERA",re.Other="OTHER";const se={[e.OperatingSystemType.Windows]:0,[e.OperatingSystemType.Mac]:1,[e.OperatingSystemType.IOS]:2,[e.OperatingSystemType.Linux]:3,[e.OperatingSystemType.Android]:4,[e.OperatingSystemType.WindowsPhone]:5},ue=ie(se),le={[e.BrowserType.Chrome]:0,[e.BrowserType.InternetExplorer]:1,[e.BrowserType.Firefox]:2,[e.BrowserType.Safari]:3,[e.BrowserType.Opera]:4,[e.BrowserType.Other]:5},de=ie(le),ce="off",ge="warehouseAudiences";var he;e.SdkLanguageType=void 0,(he=e.SdkLanguageType||(e.SdkLanguageType={})).ANDROID="ANDROID",he.IOS="IOS",he.JAVA="JAVA",he.CSHARP="CSHARP",he.NODEJS="NODEJS",he.PHP="PHP",he.RUBY="RUBY",he.GO="GO",he.FLUTTER="FLUTTER",he.REACT="REACT",he.PYTHON="PYTHON",he.JAVASCRIPT="JAVASCRIPT",he.RUST="RUST";const pe={previousVisitAmount:1,currentVisit:!0,customData:!0,pageViews:!1,geolocation:!1,device:!1,browser:!1,operatingSystem:!1,conversions:!1,experiments:!1,kcs:!1,visitorCode:!0,personalization:!1};var ve,me,fe,Ce,ye,De,Ee,Te,Ie,ke,Se,Ve;!function(e){e.And="AND",e.Or="OR"}(ve||(ve={})),function(e){e.TRUE="TRUE",e.FALSE="FALSE",e.EXACT="EXACT",e.CONTAINS="CONTAINS",e.REGULAR_EXPRESSION="REGULAR_EXPRESSION",e.EQUAL="EQUAL",e.LOWER="LOWER",e.GREATER="GREATER",e.UNDEFINED="UNDEFINED",e.AMONG_VALUES="AMONG_VALUES",e.RANGE="RANGE"}(me||(me={})),function(e){e.NEW="NEW",e.RETURNING="RETURNING"}(fe||(fe={})),function(e){e.ANY="ANY",e.EXACT="EXACT"}(Ce||(Ce={})),function(e){e.ALL="ALL",e.TEST="TEST",e.PERSO="PERSO"}(ye||(ye={})),function(e){e.Experiment="EXPERIMENT",e.Personalization="PERSONALIZATION",e.Any="ANY"}(De||(De={})),function(e){e.EXACT="EXACT",e.CONTAINS="CONTAINS",e.REGULAR_EXPRESSION="REGULAR_EXPRESSION",e.GREATER="GREATER",e.EQUAL="EQUAL",e.LOWER="LOWER"}(Ee||(Ee={})),function(e){e.GREATER="GREATER",e.EQUAL="EQUAL",e.LOWER="LOWER"}(Te||(Te={})),function(e){e.EXACT="EXACT",e.CONTAINS="CONTAINS",e.REGULAR_EXPRESSION="REGULAR_EXPRESSION",e.OPTIONAL="OPTIONAL"}(Ie||(Ie={})),function(e){e.PAGE_URL="PAGE_URL",e.PAGE_TITLE="PAGE_TITLE",e.LANDING_PAGE="LANDING_PAGE",e.ORIGIN="ORIGIN",e.ORIGIN_TYPE="ORIGIN_TYPE",e.REFERRERS="REFERRERS",e.NEW_VISITORS="NEW_VISITORS",e.INTERESTS="INTERESTS",e.BROWSER_LANGUAGE="BROWSER_LANGUAGE",e.GEOLOCATION="GEOLOCATION",e.DEVICE_TYPE="DEVICE_TYPE",e.SCREEN_DIMENSION="SCREEN_DIMENSION",e.VISITOR_IP="VISITOR_IP",e.AD_BLOCKER="AD_BLOCKER",e.PREVIOUS_PAGE="PREVIOUS_PAGE",e.KEY_PAGES="KEY_PAGES",e.PAGE_VIEWS="PAGE_VIEWS",e.FIRST_VISIT="FIRST_VISIT",e.LAST_VISIT="LAST_VISIT",e.ACTIVE_SESSION="ACTIVE_SESSION",e.TIME_SINCE_PAGE_LOAD="TIME_SINCE_PAGE_LOAD",e.SAME_DAY_VISITS="SAME_DAY_VISITS",e.VISITS="VISITS",e.VISITS_BY_PAGE="VISITS_BY_PAGE",e.VISITOR_CODE="VISITOR_CODE",e.SDK_LANGUAGE="SDK_LANGUAGE",e.INTERNAL_SEARCH_KEYWORDS="INTERNAL_SEARCH_KEYWORDS",e.TABS_ON_SITE="TABS_ON_SITE",e.CONVERSION_PROBABILITY="CONVERSION_PROBABILITY",e.HEAT_SLICE="HEAT_SLICE",e.SKY_STATUS="SKY_STATUS",e.TEMPERATURE="TEMPERATURE",e.DAY_NIGHT="DAY_NIGHT",e.FORECAST_SKY_STATUS="FORECAST_SKY_STATUS",e.FORECAST_TEMPERATURE="FORECAST_TEMPERATURE",e.DAY_OF_WEEK="DAY_OF_WEEK",e.TIME_RANGE="TIME_RANGE",e.HOUR_MINUTE_RANGE="HOUR_MINUTE_RANGE",e.JS_CODE="JS_CODE",e.COOKIE="COOKIE",e.EVENT="EVENT",e.BROWSER="BROWSER",e.OPERATING_SYSTEM="OPERATING_SYSTEM",e.DOM_ELEMENT="DOM_ELEMENT",e.MOUSE_OUT="MOUSE_OUT",e.TARGET_EXPERIMENT="TARGET_EXPERIMENT",e.TARGET_FEATURE_FLAG="TARGET_FEATURE_FLAG",e.TARGET_PERSONALIZATION="TARGET_PERSONALIZATION",e.EXCLUSIVE_EXPERIMENT="EXCLUSIVE_EXPERIMENT",e.CONVERSIONS="CONVERSIONS",e.CUSTOM_DATUM="CUSTOM_DATUM",e.YSANCE_SEGMENT="YSANCE_SEGMENT",e.SEGMENT="SEGMENT",e.YSANCE_ATTRIBUT="YSANCE_ATTRIBUT",e.TEALIUM_BADGE="TEALIUM_BADGE",e.TEALIUM_AUDIENCE="TEALIUM_AUDIENCE",e.PRICE_OF_DISPLAYED_PAGE="PRICE_OF_DISPLAYED_PAGE",e.NUMBER_OF_VISITED_PAGES="NUMBER_OF_VISITED_PAGES",e.VISITED_PAGES="VISITED_PAGES",e.CUSTOM="CUSTOM",e.EXPLICIT_TRIGGER="EXPLICIT_TRIGGER",e.APPLICATION_VERSION="APPLICATION_VERSION"}(ke||(ke={})),function(e){e.Minute="MINUTE",e.Hour="HOUR",e.Day="DAY",e.Week="WEEK",e.Month="MONTH"}(Se||(Se={})),function(e){e.Ascending="asc",e.Descending="desc"}(Ve||(Ve={}));const we="localhost",Re=/^(\.?(([a-zA-Z\d][a-zA-Z\d-]*[a-zA-Z\d])|[a-zA-Z\d]))(\.(([a-zA-Z\d][a-zA-Z\d-]*[a-zA-Z\d])|[a-zA-Z\d])){1,126}$/;class be{static validateVersion(t){const i=t.split(".").map(e=>parseInt(e,10));for(;i.length<3;)i.push(0);return i.some(e=>isNaN(e))?l.Err(new h(e.KameleoonException.SemanticVersionParse,t)):l.Ok(i.slice(0,3))}static validateDomain(e){return e?(e=be.checkAndTrimProtocol(e.toLowerCase()),Re.test(e)||e===we||M.error`The top-level domain ${e} is invalid. The value has been set as provided, but it does not meet the required format for proper SDK functionality. Please check the domain for correctness.`,l.Ok(e)):l.Err()}static validateNetworkDomain(e){return e?(e=(e=be.checkAndTrimProtocol(e.toLowerCase())).replace(/^\.+|\.+$/g,""),Re.test(e)||e===we?l.Ok(e):(M.error`The network domain ${e} is invalid.`,l.Err())):l.Err()}static checkAndTrimProtocol(e){const t=["http://","https://"];for(const i of t)if(e.startsWith(i)){e=e.substring(i.length),M.warning`The domain contains ${i}. Domain after protocol trimming: ${e}`;break}return e}}class Ke{static getNonce(e){let t="";for(let i=0;i<16;i++){const i=e.getRandomNumber(),a=Math.floor(16*i);t+="0123456789ABCDEF".charAt(a)}return t}static checkTargeting({segment:t,visitorCode:i,targetingData:a,experimentId:n,variationConfiguration:o,clientConfiguration:r,packageInfo:s,dataManager:u}){if(M.debug`CALL: checkTargeting(segment, visitorCode: ${i}, targetingData: ${a}, experimentId: ${n}, variationConfiguration, clientConfiguration, packageInfo, dataManager)`,!t||!t.conditionsData.firstLevel.length){const e=l.Ok(!0);return M.debug`RETURN checkTargeting(segment, visitorCode: ${i}, targetingData: ${a}, experimentId: ${n}, variationConfiguration, clientConfiguration, packageInfo, dataManager) -> (result: ${e})`,e}if(!o){const t=l.Err(new h(e.KameleoonException.Initialization));return M.debug`RETURN checkTargeting(segment, visitorCode: ${i}, targetingData: ${a}, experimentId: ${n}, variationConfiguration, clientConfiguration, packageInfo, dataManager) -> (result: ${t})`,t}let d={};const c=o.getStoredVariations(i);c.ok&&(d=c.data);const g=u.getTree(t);let p,v,m;g.hasTargetingType(ke.SEGMENT)&&(p=u.trees,m=r.segments),g.hasTargetingType(ke.TARGET_FEATURE_FLAG)&&(v=r.ruleMap);const f=g.evaluate({variationData:d,sdkInfo:s,segments:m,ruleMap:v,trees:p,targetingData:a,experimentId:n,visitorCode:i});return M.debug`RETURN checkTargeting(segment, visitorCode: ${i}, targetingData: ${a}, experimentId: ${n}, variationConfiguration, clientConfiguration, packageInfo, dataManager) -> (result: ${f})`,f}static convertTimeUnit(t,i){return t/{[Se.Minute]:e.Milliseconds.Minute,[Se.Hour]:e.Milliseconds.Hour,[Se.Day]:e.Milliseconds.Day,[Se.Week]:e.Milliseconds.Week,[Se.Month]:e.Milliseconds.Month}[i]}static isCustomData(t){return t.data.type===e.KameleoonData.CustomData}static updateCache({hasJsCssVariables:t,cacheManager:i,visitorCode:a,experimentId:n,variationId:o}){const r=i.getAliveItem(a),s=r?Object.assign({},r):{};s[n]={variationId:o,hasJsCssVariables:t,expirationTime:Date.now()+5*e.Milliseconds.Second},i.add({key:a,data:s,lifetime:5})}static getTrackingCode(e,t){let i="window.kameleoonQueue=window.kameleoonQueue||[];";const a=e.getAliveItem(t);if(!a)return i;const n={};return Object.entries(a).forEach(([e,{variationId:t,expirationTime:a,hasJsCssVariables:o}])=>{const r=!o;a>Date.now()&&(i+=`window.kameleoonQueue.push(['Experiments.assignVariation',${e},${t},true]);`,i+=`window.kameleoonQueue.push(['Experiments.trigger',${e},${r}]);`,n[Number(e)]={variationId:t,expirationTime:a,hasJsCssVariables:o})}),e.add({key:t,data:n,lifetime:5}),i}static compareSemVer({version:e,compareVersion:t,operator:i}){const a=be.validateVersion(e),n=be.validateVersion(t);if(!a.ok)return l.Err(a.error);if(!n.ok)return l.Err(n.error);const[o,r,s]=a.data,[u,d,c]=n.data,[h,p,v]=[o===u,r===d,s===c];switch(i){case Te.EQUAL:return l.Ok(h&&p&&v);case Te.GREATER:return l.Ok(o>u||h&&r>d||h&&p&&s>c);case Te.LOWER:return l.Ok(o<u||h&&r<d||h&&p&&s<c);default:M.error`Unknown version match type: ${i}`,g(i)}}static getVariationByHash(e,t){let i=0;for(const a of e)if(i+=a.exposition,i>=t)return a;return null}}class Ae{static insertInOrderedListMutably({list:e,element:t,order:i}){if(e.includes(t))return;const a=e.findIndex(e=>i===Ve.Ascending?e>=t:e<=t);-1===a?e.push(t):e.splice(a,0,t)}static insertVisitInOrderedListMutably({list:e,visit:t}){if(e.find(e=>"number"==typeof e?e===t.timeStarted:e.timeStarted===t.timeStarted))return;const i=e.findIndex(e=>"number"==typeof e?e>=t.timeStarted:e.timeStarted>=t.timeStarted);-1===i?e.push(t):e.splice(i,0,t),e.length>26&&e.splice(0,e.length-26)}}class xe{constructor({urlAddress:t,title:i,referrers:a}){this.urlAddress=t,this.title=i,this.referrers=a,this.timestamps=[{time:Date.now(),status:e.TrackingStatus.Unsent}]}get url(){var e;if(!this.urlAddress)return"";const t=this.title?"&title="+encodeURIComponent(this.title):"",i=(null===(e=this.referrers)||void 0===e?void 0:e.length)?"&referrersIndices="+JSON.stringify(this.referrers):"";return"eventType=page&href="+encodeURIComponent(this.urlAddress)+t+i}get status(){const{[e.TrackingStatus.Sent]:t,[e.TrackingStatus.Unsent]:i,[e.TrackingStatus.Pending]:a}=this.timestamps.reduce((e,{status:t})=>(e[t]=!0,e),{[e.TrackingStatus.Sent]:!1,[e.TrackingStatus.Unsent]:!1,[e.TrackingStatus.Pending]:!1});return!t||i||a?a&&!i?e.TrackingStatus.Pending:e.TrackingStatus.Unsent:e.TrackingStatus.Sent}set status(e){this.timestamps=this.timestamps.map(t=>Object.assign(Object.assign({},t),{status:e}))}set _nonce(e){this.nonce=e}get data(){return{urlAddress:this.urlAddress,title:this.title,referrers:this.referrers,type:e.KameleoonData.PageView,timestamps:this.timestamps,status:this.status,nonce:this.nonce}}static _fromRaw(e){const{urlAddress:t,title:i,referrers:a,timestamps:n,nonce:o}=e,r=new xe({urlAddress:t,title:i,referrers:a});return r.timestamps=n,o&&(r._nonce=o),r}static _updateFromVisit(t,i){const a=t.pageEvents;if(a)for(const t of a){let a=[];const{time:n}=t,{href:o,title:r,referrersIndices:s}=t.data;let u;if("number"==typeof s[0]&&(a=s),i.has(o)){const t=i.get(o).timestamps;u=new xe({urlAddress:o,title:r,referrers:a}),u.timestamps=[...t,{time:n,status:e.TrackingStatus.Sent}]}else u=new xe({urlAddress:o,title:r,referrers:a}),u.timestamps=[{time:n,status:e.TrackingStatus.Sent}];i.set(o,u)}}}let Oe=class t{constructor(i,a,...n){this._status=e.TrackingStatus.Unsent,this.isIdentifier=!1;const o="boolean"==typeof a;"number"==typeof i?this._index=i:(this._name=i,this._index=t.UNDEFINED_INDEX),this.overwrite=!o||a,this.value=o?n:[a,...n].filter(e=>null!=e)}get url(){if("number"!=typeof this._index)return"";const e=[...new Set(this.value)];let t={};e.forEach(e=>{t[e]=1});let i="";return this.isIdentifier&&(i="&mappingIdentifier="+String(!0)),"eventType=customData&index="+this._index+"&valuesCountMap="+encodeURIComponent(JSON.stringify(t))+"&overwrite="+String(this.overwrite)+i}get data(){return Object.assign(Object.assign({index:this._index},void 0!==this._name?{name:this._name}:{}),{value:this.value,type:e.KameleoonData.CustomData,isIdentifier:this.isIdentifier,status:this.status,overwrite:this.overwrite})}get status(){return this._isMappingIdentifier?e.TrackingStatus.Unsent:this._status}static _fromRaw(e){const{index:i,value:a,status:n,isIdentifier:o,name:r,overwrite:s}=e;let u;return r?(u=new t(r,null==s||s,...a),u.index=i):u=new t(i,null==s||s,...a),u.status=n,u._isMappingIdentifier=o,u}set _isMappingIdentifier(e){this.isIdentifier=e}set status(e){this._status=e}static _updateFromVisit(e,i){var a;if(null===(a=e.customDataEvents)||void 0===a?void 0:a.length)for(let a=e.customDataEvents.length-1;a>=0;a--){const{index:n,valuesCountMap:o}=e.customDataEvents[a].data;i.has(n)||i.set(n,new t(n,...Object.keys(o)))}}set index(e){this._index=e}get index(){return this._index}get name(){return this._name}get values(){return this.value}};Oe.UNDEFINED_INDEX=-1;let $e=class t{constructor({goalId:t,revenue:i=0,negative:a=!1,metadata:n}){this.goalId=t,this.revenue=i,this.negative=a,this.status=e.TrackingStatus.Unsent,this.id=Math.floor(1e6*Math.random()),this._metadata=n}set _id(e){this.id=e}set _nonce(e){this.nonce=e}get url(){var e;return"eventType=conversion&goalId="+String(this.goalId)+"&revenue="+String(this.revenue)+"&negative="+String(this.negative)+((null===(e=this.metadata)||void 0===e?void 0:e.length)?"&metadata="+this._encodeMetadata():"")}get _metadata(){return this.metadata}set _metadata(e){this.metadata=e}get data(){var t;return{goalId:this.goalId,nonce:this.nonce,revenue:this.revenue,negative:this.negative,type:e.KameleoonData.Conversion,status:this.status,id:this.id,metadata:(null===(t=this.metadata)||void 0===t?void 0:t.map(e=>e.data))||void 0}}_encodeMetadata(){var e;if(!(null===(e=this.metadata)||void 0===e?void 0:e.length))return"";const t=new Set;return encodeURIComponent(JSON.stringify(this.metadata.reduce((e,i)=>(t.has(i.data.index)||(t.add(i.data.index),e[i.data.index]=i.data.value),e),{})))}static _fromRaw(e){const{goalId:i,revenue:a,negative:n,status:o,id:r,nonce:s,metadata:u}=e,l=new t({goalId:i,revenue:a,negative:n,metadata:t.parseMetadata(u)});return l._id=r,l.status=o,s&&(l._nonce=s),l}static parseMetadata(e){return(null==e?void 0:e.map(e=>Oe._fromRaw(e)))||void 0}static _listFromVisit(i){var a,n;const o=[];if(!(null===(a=i.conversionEvents)||void 0===a?void 0:a.length))return[];if(null===(n=i.conversionEvents)||void 0===n?void 0:n.length)for(const a of i.conversionEvents){const{goalId:i,revenue:n,negative:r}=a.data,s=new t({goalId:i,revenue:n,negative:r});s.status=e.TrackingStatus.Sent,o.push(s)}return o}static _updateFromVisit(i,a){var n;if(null===(n=i.conversionEvents)||void 0===n?void 0:n.length)for(const n of i.conversionEvents){const{goalId:i}=n.data;if(!a.has(i)){const n=new t({goalId:i});n.status=e.TrackingStatus.Sent,a.set(i,n)}}}},Ne=class t{constructor(t,i){this.browser=t,this.version=i,this.status=e.TrackingStatus.Unsent}get url(){if(!this.browser)return"";const e=this.version?E+this.version:"";return y+b+this.browser+D+le[this.browser]+e}get data(){return{browser:this.browser,type:e.KameleoonData.Browser,version:this.version,status:this.status}}static _fromRaw(e){const{browser:i,version:a,status:n}=e,o=new t(i,a);return o.status=n,o}static _fromVisit(e){if(!e.staticDataEvent)return;const{browser:i,browserIndex:a,browserVersion:n}=e.staticDataEvent.data;if(i||"number"==typeof a){const e=null!=i?i:de[a];return n?new t(e,n):new t(e)}}},Me=class t{constructor(t){this.device=t,this.status=e.TrackingStatus.Unsent}get url(){return this.device?y+T+this.device:""}get data(){return{device:this.device,type:e.KameleoonData.Device,status:this.status}}static _fromRaw(e){const{device:i,status:a}=e,n=new t(i);return n.status=a,n}static _fromVisit(e){var i;if(null===(i=e.staticDataEvent)||void 0===i?void 0:i.data.deviceType)return new t(e.staticDataEvent.data.deviceType)}},Fe=class t{constructor(t){this.operatingSystem=t,this.status=e.TrackingStatus.Unsent}get url(){return this.operatingSystem?y+w+this.operatingSystem+R+se[this.operatingSystem]:""}get data(){return{operatingSystem:this.operatingSystem,type:e.KameleoonData.OperatingSystem,status:this.status}}static _fromRaw(e){const{operatingSystem:i,status:a}=e,n=new t(i);return n.status=a,n}static _fromVisit(e){if(!e.staticDataEvent)return;const{os:i,osIndex:a}=e.staticDataEvent.data;if(i||"number"==typeof a){const e=null!=i?i:ue[a];return new t(e)}}};class Le{constructor({country:t,region:i,city:a,postalCode:n,coordinates:o}){this.country=t,this.region=i,this.city=a,this.postalCode=n,this.coordinates=o,this.status=e.TrackingStatus.Unsent}get url(){const e=this.region?"&region="+encodeURIComponent(this.region):"",t=this.city?"&city="+encodeURIComponent(this.city):"",i=this.postalCode?"&postalCode="+encodeURIComponent(this.postalCode):"",a=this.coordinates?"&latitude="+this.coordinates[0]+"&longitude="+this.coordinates[1]:"";return"eventType=geolocation&country="+encodeURIComponent(this.country)+e+t+i+a}get data(){return{type:e.KameleoonData.GeolocationData,country:this.country,region:this.region,city:this.city,postalCode:this.postalCode,coordinates:this.coordinates,status:this.status}}static _fromRaw(e){const{country:t,region:i,city:a,postalCode:n,coordinates:o,status:r}=e,s=new Le({country:t,region:i,city:a,postalCode:n,coordinates:o});return s.status=r,s}static _fromVisit(e){var t;if(!(null===(t=e.geolocationEvents)||void 0===t?void 0:t.length))return;let i;for(const t of e.geolocationEvents){const{data:e}=t;e.country&&(i=e)}const{country:a,region:n,city:o}=i||{};return a?new Le(n&&o?{country:a,region:n,city:o}:n?{country:a,region:n}:{country:a}):void 0}}class _e{constructor(t){this.status=e.TrackingStatus.Sent,this.visits=t,this._visitNumber=t.length?t.length-1:0}get visitNumber(){return this._visitNumber}get url(){return""}get data(){return{visits:this.visits,visitNumber:this._visitNumber,type:e.KameleoonData.VisitsData,status:this.status}}get isSent(){return!0}set timestamp(e){Ae.insertVisitInOrderedListMutably({list:this.visits,visit:e}),this._visitNumber=this.visits.length?this.visits.length-1:0}updateVisitNumber(e){e>this._visitNumber&&(this._visitNumber=e)}}class Ue{constructor(t){this.kcs=t,this.status=e.TrackingStatus.Sent}get url(){return""}get data(){return{kcs:this.kcs,type:e.KameleoonData.KameleoonConversionScore,status:this.status}}}class Pe{constructor(t,i){this.id=t,this.variationId=i,this.status=e.TrackingStatus.Sent}get url(){return""}get data(){return{id:this.id,variationId:this.variationId,type:e.KameleoonData.Personalization,status:e.TrackingStatus.Sent}}static _fromRaw(e){return new Pe(e.id,e.variationId)}static _updateFromVisit(e,t){var i;if(null===(i=e.personalizationEvents)||void 0===i?void 0:i.length)for(const i of e.personalizationEvents){const{id:e,variationId:a}=i.data;if(!t.has(e)){const i=new Pe(e,a);t.set(e,i)}}}}class Be{constructor(t){this.values=new Map(Object.entries(t).map(([e,t])=>[Number(e),this.extractVarIds(t)])),this.cbs=t,this.status=e.TrackingStatus.Sent}extractVarIds(e){const t=new Map;return Object.entries(e).forEach(([e,i])=>{t.has(i)||t.set(i,[]),t.get(i).push(Number(e))}),Array.from(t.entries()).sort(([e],[t])=>t-e).map(([,e])=>({ids:e.sort((e,t)=>e-t)}))}getValues(){return this.values}get url(){return""}get data(){return{cbs:this.cbs,type:e.KameleoonData.CBScores,status:this.status}}static _fromRaw(e){const t=new Be(e.cbs);return t.status=e.status,t}}class Ge{constructor({filters:t,dataManager:i,visitorCode:a}){this.visitsData=new _e([]),this.visitorData=[],this.storageVisitorData=[],this.experimentData={},this.singleDataTypes={[e.KameleoonData.Device]:null,[e.KameleoonData.Browser]:null,[e.KameleoonData.GeolocationData]:null,[e.KameleoonData.OperatingSystem]:null,[e.KameleoonData.KameleoonConversionScore]:null,[e.KameleoonData.CBScores]:null},this.multipleDataTypes={[e.KameleoonData.CustomData]:new Map,[e.KameleoonData.PageView]:new Map,[e.KameleoonData.Conversion]:new Map,[e.KameleoonData.Personalization]:new Map},this.filters=t,this.dataManager=i,this.visitorDataTypes=i.getVisitorStoredDataTypes(a)}get data(){return{visitorData:this.visitorData,storageVisitorData:this.storageVisitorData,visitsData:this.visitsData,experimentData:this.experimentData}}processVisit(e){this.processBrowser(e),this.processDevice(e),this.processOperatingSystem(e),this.processGeolocationData(e),this.processCustomData(e),this.processConversion(e),this.processPageView(e),this.processExperiments(e),this.processPersonalization(e)}processMultipleDataTypes(){for(const[t,i]of Object.entries(this.multipleDataTypes))if(i.size)switch(t){case e.KameleoonData.PageView:this.visitorData.push(...i.values()),this.storageVisitorData.push(...i.values());break;case e.KameleoonData.Personalization:case e.KameleoonData.Conversion:this.storageVisitorData.push(...i.values());break;case e.KameleoonData.CustomData:i.forEach(e=>{this.visitorData.push(e),this.dataManager.storedCustomDataIndexes.has(e.data.index)||this.storageVisitorData.push(e)})}}processKcs(e){if(this.filters.kcs&&e){const t=new Ue(e);this.storageVisitorData.push(t)}}processVisitsData(e){var t;this.visitsData.timestamp={timeStarted:e.timeStarted,timeLastActivity:null!==(t=e.timeLastEvent)&&void 0!==t?t:e.timeStarted}}processVisitNumber(e,t){var i,a,n;if(this.visitsData.visitNumber<=t&&(null===(i=e.staticDataEvent)||void 0===i?void 0:i.data.visitNumber)){const i=null!==(n=null===(a=e.staticDataEvent)||void 0===a?void 0:a.data.visitNumber)&&void 0!==n?n:0;this.visitsData.updateVisitNumber(i+t)}}processCbs(e){if(this.filters.cbs&&e){const t=new Be(e);this.storageVisitorData.push(t)}}processBrowser(t){if(this.filters.browser&&!this.singleDataTypes[e.KameleoonData.Browser]){const i=Ne._fromVisit(t);i&&(this.visitorDataTypes.has(e.KameleoonData.Browser)||this.storageVisitorData.push(i),this.visitorData.push(i),this.singleDataTypes[e.KameleoonData.Browser]=i)}}processDevice(t){if(this.filters.device&&!this.singleDataTypes[e.KameleoonData.Device]){const i=Me._fromVisit(t);i&&(this.visitorDataTypes.has(e.KameleoonData.Device)||this.storageVisitorData.push(i),this.visitorData.push(i),this.singleDataTypes[e.KameleoonData.Device]=i)}}processOperatingSystem(t){if(this.filters.operatingSystem&&!this.singleDataTypes[e.KameleoonData.OperatingSystem]){const i=Fe._fromVisit(t);i&&(this.visitorDataTypes.has(e.KameleoonData.OperatingSystem)||this.storageVisitorData.push(i),this.visitorData.push(i),this.singleDataTypes[e.KameleoonData.OperatingSystem]=i)}}processGeolocationData(t){if(this.filters.geolocation&&!this.singleDataTypes[e.KameleoonData.GeolocationData]){const i=Le._fromVisit(t);i&&(this.visitorDataTypes.has(e.KameleoonData.GeolocationData)||this.storageVisitorData.push(i),this.visitorData.push(i),this.singleDataTypes[e.KameleoonData.GeolocationData]=i)}}processCustomData(t){this.filters.customData&&Oe._updateFromVisit(t,this.multipleDataTypes[e.KameleoonData.CustomData])}processConversion(t){if(this.filters.conversions){$e._updateFromVisit(t,this.multipleDataTypes[e.KameleoonData.Conversion]);const i=$e._listFromVisit(t);i.length&&this.visitorData.push(...i)}}processPageView(t){this.filters.pageViews&&xe._updateFromVisit(t,this.multipleDataTypes[e.KameleoonData.PageView])}processExperiments(t){if(this.filters.experiments&&t.experimentEvents)for(const i of t.experimentEvents){const{id:t,variationId:a}=i.data;this.experimentData[t]={variationId:a,isTargetedRule:!1,status:e.TrackingStatus.Unsent}}}processPersonalization(t){this.filters.personalization&&Pe._updateFromVisit(t,this.multipleDataTypes[e.KameleoonData.Personalization])}processMappingIdentifier(e){var t,i;if(!e)return;const a=null===(i=null===(t=e.customDataEvents)||void 0===t?void 0:t.find(e=>e.data.mappingIdentifier))||void 0===i?void 0:i.time;return a&&e.visitorCode?{mappingIdentifier:e.visitorCode,timestamp:a}:void 0}}class ze{static parseFeatureVariable(t){const{key:i,type:a,value:n}=t;switch(a){case e.VariableType.BOOLEAN:return l.Ok({key:i,type:a,value:Boolean(n)});case e.VariableType.JS:case e.VariableType.CSS:case e.VariableType.STRING:return l.Ok({key:i,type:a,value:String(n)});case e.VariableType.NUMBER:const o=Number(n);return Number.isNaN(o)?l.Err(new h(e.KameleoonException.NumberParse,String(n))):l.Ok({key:i,type:a,value:o});case e.VariableType.JSON:try{const e=JSON.parse(String(t.value));return l.Ok({key:i,type:a,value:e})}catch(t){return l.Err(new h(e.KameleoonException.JSONParse,t))}default:g(a)}}static parseVisitorData({data:e,filters:t,visitorCode:i,dataManager:a,variationConfiguration:n}){const o=new Ge({filters:t,dataManager:a,visitorCode:i}),{currentVisit:r,previousVisits:s,kcs:u,cbs:l}=e;if(!(null==s?void 0:s.length)&&!r)return{visitorData:[],storageVisitorData:[],visitsData:new _e([])};r&&(o.processVisit(r),o.processVisitNumber(r,0)),null==s||s.forEach((e,t)=>{o.processVisit(e),o.processVisitsData(e),o.processVisitNumber(e,t+1)}),o.processKcs(u),o.processCbs(l),o.processMultipleDataTypes();const d=o.processMappingIdentifier(null!=r?r:null==s?void 0:s[0]),{visitorData:c,storageVisitorData:g,visitsData:h,experimentData:p}=o.data;return n.updateStoredVariations(i,p),{visitorData:c,storageVisitorData:g,visitsData:h,mappingIdentifier:d}}static parseRegExp(e){if("/"===e[0]){const[t,i,a]=e.split("/");return new RegExp(i,a)}return new RegExp(e)}static parseSecret(e){if(null===e)return"null";const t=e.length;if(t<=4)return"*".repeat(t);const i=Math.max(t-4,4);return e.substring(0,t-i)+"*".repeat(i)}}class je{constructor(t,i){M.debug`CALL: new ClientSettings(siteCode: ${t}, configuration: ${i})`,this.siteCode=t,this.environment=this.getEnvironment(i),this.networkDomain=this.getNetworkDomain(i),this.updateInterval=this.getUpdateInterval(i),this.cleanupInterval=this.getCleanupInterval(i),this.requestTimeout=this.getRequestTimeout(i),this.trackingInterval=this.getTrackingInterval(i),this.trackRetryDelay=5*e.Milliseconds.Second,M.debug`RETURN: new ClientSettings(siteCode: ${t}, configuration: ${i})`}getTrackingInterval(e){return"number"==typeof(null==e?void 0:e.trackingInterval)?e.trackingInterval<100?(M.warning("Tracking interval must not be shorter than 100 ms. Minimum possible interval was applied."),100):e.trackingInterval>1e3?(M.warning("Tracking interval must not be longer than 1000 ms. Maximum possible interval was applied."),1e3):e.trackingInterval:1e3}getEnvironment(t){return(null==t?void 0:t.environment)?t.environment:e.Environment.Production}getCleanupInterval(t){return"number"==typeof(null==t?void 0:t.targetingDataCleanupInterval)?t.targetingDataCleanupInterval<1?(M.warning("Targeting data cleanup interval must not be shorter than 1 minute. Minimum possible interval was applied."),1*e.Milliseconds.Minute):t.targetingDataCleanupInterval*e.Milliseconds.Minute:null}getUpdateInterval(t){return"number"==typeof(null==t?void 0:t.updateInterval)?t.updateInterval<1?(M.warning("Update interval must not be shorter than 1 minute. Minimum possible interval was applied."),1*e.Milliseconds.Minute):t.updateInterval*e.Milliseconds.Minute:60*e.Milliseconds.Minute}getNetworkDomain(e){const t=be.validateNetworkDomain(null==e?void 0:e.networkDomain);return t.ok?t.data:null}getRequestTimeout(t){return"number"==typeof(null==t?void 0:t.requestTimeout)?t.requestTimeout:10*e.Milliseconds.Second}get settings(){return{trackingInterval:this.trackingInterval,trackRetryDelay:this.trackRetryDelay,cleanupInterval:this.cleanupInterval,updateInterval:this.updateInterval,requestTimeout:this.requestTimeout,networkDomain:this.networkDomain,environment:this.environment,siteCode:this.siteCode}}}let qe=class t{constructor(t){this.cookie=t,this.status=e.TrackingStatus.Sent}static fromString(e){if(!e)return new t([]);const i=e.split(";").map(t=>{const[i,a]=t.trim().split("=");return i?{key:i,value:a}:(M.warning`Cookie string has an empty key: ${e}`,null)}).filter(e=>null!==e);return new t(i)}get url(){return""}get data(){return{cookie:this.cookie,type:e.KameleoonData.Cookie,status:this.status}}};class He{constructor(t){this._value=t,this.status=e.TrackingStatus.Sent}get url(){return""}get data(){return{value:this._value,type:e.KameleoonData.UniqueIdentifier,status:e.TrackingStatus.Sent}}static _fromRaw(e){return new He(e.value)}}class We{constructor(e=null,t){this.cleanupInterval=e,this.packageInfo=t}mutUpdateData({infoData:t,visitorCode:i,mutData:a,dataItem:n,extendTtl:o}){let r,{visitorReference:s,data:u,isReference:l}=this.dereferenceData(a,i);switch(this.packageInfo.isServer&&l&&!a[s]&&(t.mappingIdentifiers&&delete t.mappingIdentifiers[i],delete a[i],s=i),o&&(r=this.cleanupInterval?Date.now()+this.cleanupInterval:0),n.data.type){case e.KameleoonData.CustomData:this.updateCustomData({expirationTime:r,customData:n,visitorCode:s,mutData:u});break;case e.KameleoonData.PageView:this.updatePageView({expirationTime:r,pageView:n,visitorCode:s,mutData:u});break;case e.KameleoonData.Conversion:this.updateConversion({expirationTime:r,conversion:n,visitorCode:s,mutData:u});break;case e.KameleoonData.VisitsData:this.updateVisitsData({expirationTime:r,visitsData:n,visitorCode:s,mutData:u});break;case e.KameleoonData.Personalization:this.updatePersonalization({expirationTime:r,personalization:n,visitorCode:s,mutData:u});break;case e.KameleoonData.TargetedSegment:this.updateTargetedSegment({expirationTime:r,targetedSegment:n,visitorCode:s,mutData:u});break;default:this.updateCommonData({expirationTime:r,commonData:n,visitorCode:s,mutData:u})}return r}mutCleanupData(t,i){var a;if(!this.cleanupInterval)return null;let n=0;for(const[o,r]of Object.entries(t)){if("string"==typeof r){this.removeReference({mutData:t,visitorCode:o,linkedVisitor:r,infoData:i});continue}let s=0;for(const t of Object.keys(r)){const i=t;let a;switch(i){case e.KameleoonData.CustomData:case e.KameleoonData.PageView:case e.KameleoonData.Conversion:case e.KameleoonData.Personalization:a=this.deleteNestedExpiredField(r,i);break;default:a=this.deleteExpiredField(r,i)}(!s||a&&a<s)&&(s=a)}Object.keys(t[o]).length?(!n||s&&s<n)&&(n=s):(delete t[o],this.packageInfo.isServer&&(null!==(a=i.mappingIdentifiers)&&void 0!==a||(i.mappingIdentifiers={}),delete i.mappingIdentifiers[o]))}return n}mutAddUnsentData({mutData:e,visitorCode:t,dataType:i}){const a=e.unsentData[t];if(a&&a.length){const n=new Set([...a]);n.add(i),e.unsentData[t]=Array.from(n)}else e.unsentData[t]=[i]}createReference({mutData:e,visitorCode:t,linkedVisitor:i}){e[i]=t}removeReference({mutData:e,visitorCode:t,linkedVisitor:i,infoData:a}){this.packageInfo.isServer&&(e[i]||(delete e[t],a.mappingIdentifiers&&delete a.mappingIdentifiers[t]))}updatePageView({visitorCode:t,mutData:i,pageView:a,expirationTime:n}){const{data:o}=a,r=i[t]&&e.KameleoonData.PageView in i[t]&&o.urlAddress in i[t][e.KameleoonData.PageView],s={expirationTime:n,visitorCode:t,data:i,key:e.KameleoonData.PageView,nestedKey:o.urlAddress,value:o};if(r){const a=i[t][e.KameleoonData.PageView][o.urlAddress].timestamps;for(const e of a){const{time:t}=e;if(o.timestamps.some(({time:e})=>e===t))continue;const i=o.timestamps.findIndex(({time:e})=>e>=t);-1===i?o.timestamps.push(e):o.timestamps.splice(i,0,e)}this.updateNestedField(s)}else this.createNestedField(s)}updateCustomData({visitorCode:t,customData:i,mutData:a,expirationTime:n}){const{data:o}=i,r=a[t]&&e.KameleoonData.CustomData in a[t],s={expirationTime:n,visitorCode:t,data:a,key:e.KameleoonData.CustomData,nestedKey:o.index.toString(),value:o};r?this.updateNestedField(s):this.createNestedField(s)}updateConversion({conversion:t,mutData:i,visitorCode:a,expirationTime:n}){const{data:o}=t,r=i[a]&&e.KameleoonData.Conversion in i[a],s={expirationTime:n,visitorCode:a,data:i,key:e.KameleoonData.Conversion,nestedKey:o.id.toString(),value:o};r?this.updateNestedField(s):this.createNestedField(s)}updateVisitsData({visitorCode:t,mutData:i,visitsData:a,expirationTime:n}){var o,r;const{data:s}=a,u=i[t]&&e.KameleoonData.VisitsData in i[t],l={expirationTime:n,data:i,key:e.KameleoonData.VisitsData,value:s,visitorCode:t};if(u){const a=i[t][e.KameleoonData.VisitsData];a.visits.forEach(e=>{Ae.insertVisitInOrderedListMutably({list:s.visits,visit:e})});const n=Math.max(null!==(o=s.visitNumber)&&void 0!==o?o:s.visits.length-1,s.visits.length-1,null!==(r=a.visitNumber)&&void 0!==r?r:0);this.updateField(Object.assign(Object.assign({},l),{value:Object.assign(Object.assign({},s),{visits:s.visits,visitNumber:n})}))}else this.createField(l)}updatePersonalization({visitorCode:t,mutData:i,personalization:a,expirationTime:n}){const{data:o}=a,r=i[t]&&e.KameleoonData.Personalization in i[t],s={expirationTime:n,visitorCode:t,data:i,key:e.KameleoonData.Personalization,nestedKey:o.id.toString(),value:o};r?this.updateNestedField(s):this.createNestedField(s)}updateTargetedSegment({visitorCode:t,mutData:i,targetedSegment:a,expirationTime:n}){const{data:o}=a,r=i[t]&&e.KameleoonData.TargetedSegment in i[t],s={expirationTime:n,visitorCode:t,data:i,key:e.KameleoonData.TargetedSegment,nestedKey:o.id.toString(),value:o};r?this.updateNestedField(s):this.createNestedField(s)}updateCommonData({visitorCode:e,mutData:t,commonData:i,expirationTime:a}){const{data:n}=i,o=t[e]&&n.type in t[e],r={expirationTime:a,data:t,key:n.type,visitorCode:e,value:n};o?this.updateField(r):this.createField(r)}dereferenceData(e,t){return"string"==typeof e[t]?{visitorReference:e[t],data:e,isReference:!0}:{visitorReference:t,data:e,isReference:!1}}deleteExpiredField(e,t){if(!e)return 0;const i=t;return e[i].expirationTime<Date.now()?(delete e[i],0):e[i].expirationTime}deleteNestedExpiredField(e,t){if(!e[t])return 0;const i=e[t];let a;for(const[e,t]of Object.entries(i))t&&(t.expirationTime<Date.now()?delete i[e]:(!a||t.expirationTime<a)&&(a=t.expirationTime));return Object.keys(i).length||delete e[t],a}updateField({key:e,value:t,data:i,visitorCode:a,expirationTime:n}){var o;const r=i[a][e];i[a][e]=Object.assign(Object.assign({},t),{expirationTime:null!==(o=null!=n?n:r.expirationTime&&r.expirationTime)&&void 0!==o?o:Date.now()})}createField({key:e,value:t,data:i,visitorCode:a,expirationTime:n}){i[a]=Object.assign(Object.assign({},i[a]),{[e]:Object.assign(Object.assign({},t),{expirationTime:n})})}updateNestedField({key:e,nestedKey:t,value:i,data:a,visitorCode:n,expirationTime:o}){var r;const s=a[n][e][t];a[n][e][t]=Object.assign(Object.assign({},i),{expirationTime:null!==(r=null!=o?o:null==s?void 0:s.expirationTime)&&void 0!==r?r:Date.now()})}createNestedField({key:e,nestedKey:t,value:i,data:a,visitorCode:n,expirationTime:o}){var r;(null===(r=a[n])||void 0===r?void 0:r[e])?a[n]=Object.assign(Object.assign({},a[n]),{[e]:Object.assign(Object.assign({},a[n][e]),{[t]:Object.assign(Object.assign({},i),{expirationTime:o})})}):a[n]=Object.assign(Object.assign({},a[n]),{[e]:{[t]:Object.assign(Object.assign({},i),{expirationTime:o})}})}}class Ye{constructor({browserType:e,visitNumber:t,timeSincePreviousVisit:i,os:a,deviceType:n,browserVersion:o}){this.browserType=e,this.visitNumber=t,this.timeSincePreviousVisit=i,this.os=a,this.deviceType=n,this.browserVersion=o}get url(){const e=this.browserVersion?E+this.browserVersion:"",t=this.browserType?b+this.browserType:"",i=this.browserType?D+le[this.browserType]:"",a=this.os?w+this.os:"",n=this.os?R+se[this.os]:"",o=this.deviceType?T+this.deviceType:"",r=void 0!==this.visitNumber?"&visitNumber="+this.visitNumber:"",s=void 0!==this.timeSincePreviousVisit?"&timeSincePreviousVisit="+this.timeSincePreviousVisit:"";return y+t+i+e+r+s+a+n+o}}class Je{static setConditionFactoryInstance(e){this.conditionFactoryInstance=e}static createCondition(e){return this.conditionFactoryInstance.createCondition(e)}}class Xe{constructor(e,t,i){var a;if(this.inverseResult=!1,this.isOperator(e))this.nodeValue=e;else{const t=Je.createCondition(e);this.inverseResult=!(null===(a=e.isInclude)||void 0===a||a),t.ok?this.nodeValue=t.data:this.nodeError=t.error}this.leftChild=t,this.rightChild=i}get value(){return this.nodeValue}get error(){return this.nodeError}get left(){return this.leftChild}get right(){return this.rightChild}get inverse(){return this.inverseResult}isOperator(e){return e===ve.And||e===ve.Or}}class Qe{constructor(e){this.error=null,this.targetingTypes=new Set,M.debug`CALL: new Tree(segment: ${e})`;const{nestedConditions:t,topLevelOperators:i}=this.flattenSegment(e),a=t.map(({conditions:e,operators:t})=>{const i=e.map(e=>(this.targetingTypes.add(e.targetingType),new Xe(e)));return this.buildTree(i,t)});this.tree=this.buildTree(a,i),M.debug`RETURN: new Tree(segment: ${e})`}evaluate(e){const t=this.evaluateNode(this.tree,e);return this.error?l.Err(this.error):l.Ok(t)}hasTargetingType(e){return this.targetingTypes.has(e)}evaluateNode(t,i){if(this.isLeafNode(t)){if(t.error)return t.error.type===e.KameleoonException.TargetingCondition;const a=t.value.evaluate(i);return a.ok?t.inverse?!a.data:a.data:(this.error=a.error,!1)}if(this.isNonLeafNode(t))switch(t.value){case ve.And:return this.evaluateNode(t.left,i)&&this.evaluateNode(t.right,i);case ve.Or:return this.evaluateNode(t.left,i)||this.evaluateNode(t.right,i)}return!1}isLeafNode(e){return!Boolean(e.left&&e.right)}isNonLeafNode(e){return Boolean(e.left&&e.right&&(e.value===ve.Or||e.value===ve.And))}buildTree(e,t){if(1===e.length)return e[0];for(const i of t){const t=e.shift(),a=e.shift(),n=new Xe(i,t,a);e.unshift(n)}return e[0]}flattenSegment(e){const{firstLevel:t,firstLevelOrOperators:i}=e.conditionsData,a=[];return t.forEach(e=>{const{conditions:t,orOperators:i}=e,n={operators:this.convertOperators(i),conditions:t};a.push(n)}),{topLevelOperators:this.convertOperators(i),nestedConditions:a}}convertOperators(e){return e.map(e=>e?ve.Or:ve.And)}}class Ze{constructor({device:e}){this.device=e}evaluate({targetingData:t}){const i=null==t?void 0:t[e.KameleoonData.Device];if(i){const{device:e}=i;return l.Ok(e===this.device)}return l.Ok(!1)}}class et{constructor({browser:e,version:t,versionMatchType:i}){this.browser=e,this.version=t,this.versionMatchType=i}evaluate({targetingData:t}){const i=null==t?void 0:t[e.KameleoonData.Browser];if(i){const e=this.checkCondition(i);return this.error?l.Err(this.error):l.Ok(e)}return l.Ok(!1)}checkCondition(t){const{browser:i,version:a}=t;if("string"!=typeof this.browser)return!1;if(!this.version)return i===this.browser;if(!this.versionMatchType||"number"!=typeof a)return!1;const n=parseFloat(this.version);switch(isNaN(n)&&(M.error`Failed to parse version: ${this.version} in Browser condition`,this.error=new h(e.KameleoonException.VersionParse,this.version)),this.versionMatchType){case Te.EQUAL:return i===this.browser&&a===n;case Te.GREATER:return i===this.browser&&a>n;case Te.LOWER:return i===this.browser&&a<n;default:M.error`Unexpected comparing operation for Browser condition: ${this.versionMatchType}`,g(this.versionMatchType)}}}class tt{constructor({goalId:e}){this.conditionValue=e}evaluate({targetingData:t}){const i=null==t?void 0:t[e.KameleoonData.Conversion];if(!this.conditionValue)return l.Ok(!1);if(i){if(Object.keys(i).length&&-1===this.conditionValue)return l.Ok(!0);const e=Object.values(i);return l.Ok(e.some(e=>!!e&&e.goalId===this.conditionValue))}return l.Ok(!1)}}class it{constructor({customDataIndex:e,valueMatchType:t,value:i,range:a}){this.customDataIndex=e?Number(e):-1,this.matchType=t,this.conditionValue=i,this.range=a}evaluate({targetingData:t}){var i;const a=null===(i=null==t?void 0:t[e.KameleoonData.CustomData])||void 0===i?void 0:i[this.customDataIndex];if(this.matchType===me.UNDEFINED)return l.Ok(!a);if(a){const{value:e}=a,t=this.checkCondition(e);return this.error?l.Err(this.error):l.Ok(t)}return l.Ok(!1)}checkCondition(e){if("string"!=typeof this.conditionValue&&this.matchType!==me.TRUE&&this.matchType!==me.FALSE&&this.matchType!==me.RANGE)return M.error`Unexpected condition value for CustomData condition: ${this.conditionValue}`,!1;const t=this.conditionValue;if(this.matchType===me.AMONG_VALUES){const i=this.parseArray(t);if(!i.ok)return this.error=i.error,!1;const a=new Set(i.data);return Array.isArray(e)?e.some(e=>a.has(e)):i.data.includes(e)}if(this.matchType===me.RANGE){const t=this.parseRange(this.range);if(!t.ok)return this.error=t.error,!1;const[i,a]=t.data,n=e=>e>=i&&e<=a;return Array.isArray(e)?e.some(e=>n(Number(e))):n(Number(e))}if(Array.isArray(e))return e.some(e=>this.checkCondition(e));switch(this.matchType){case me.CONTAINS:return e.includes(t);case me.EXACT:return e===this.conditionValue;case me.REGULAR_EXPRESSION:return ze.parseRegExp(t).test(e);case me.LOWER:return Number(e)<Number(this.conditionValue);case me.EQUAL:return Number(e)===Number(this.conditionValue);case me.GREATER:return Number(e)>Number(this.conditionValue);case me.TRUE:return"true"===e.toLowerCase();case me.FALSE:return"false"===e.toLowerCase();default:return M.error`Unexpected comparing operation for CustomData condition: ${this.matchType}`,!1}}parseArray(t){try{const e=JSON.parse(t);if(Array.isArray(e))return l.Ok(e)}catch(i){return M.error`Failed to parse array: ${t} in CustomData condition`,l.Err(new h(e.KameleoonException.AmongValuesCheck,i,t))}return l.Ok([])}parseRange(t){return t&&2===t.length?l.Ok(t):(M.error`Failed to parse range: ${t} in CustomData condition`,l.Err(new h(e.KameleoonException.RangeCheck,t)))}}class at{static getLatest(e){return Object.values(e).reduce((e,t)=>e.timestamps[e.timestamps.length-1].time>t.timestamps[t.timestamps.length-1].time?e:t)}}class nt{constructor({matchType:e,title:t}){this.matchType=e,this.conditionValue=t}evaluate({targetingData:t}){const i=null==t?void 0:t[e.KameleoonData.PageView];if(!i)return l.Ok(!1);const a=at.getLatest(i);return l.Ok(this.checkCondition(a.title))}checkCondition(e){if(!this.matchType||!this.conditionValue)return!1;switch(this.matchType){case Ee.CONTAINS:return e.includes(this.conditionValue);case Ee.EXACT:return e===this.conditionValue;case Ee.REGULAR_EXPRESSION:return ze.parseRegExp(this.conditionValue).test(e);default:return M.error`Unexpected comparing operation for PageTitle condition: ${this.matchType}`,!1}}}class ot{constructor({matchType:e,url:t}){this.matchType=e,this.conditionValue=t}evaluate({targetingData:t}){const i=null==t?void 0:t[e.KameleoonData.PageView];if(!i)return l.Ok(!1);const a=at.getLatest(i);return l.Ok(this.checkCondition(a.urlAddress))}checkCondition(e){if(!this.matchType||!this.conditionValue)return!1;switch(this.matchType){case Ee.CONTAINS:return e.includes(this.conditionValue);case Ee.EXACT:return e===this.conditionValue;case Ee.REGULAR_EXPRESSION:return ze.parseRegExp(this.conditionValue).test(e);default:return M.error`Unexpected comparing operation for PageUrl condition: ${this.matchType}`,!1}}}class rt{constructor({sdkLanguage:e,version:t,versionMatchType:i}){this.sdkLanguage=e,this.conditionValue=t,this.versionMatchType=i}evaluate({sdkInfo:e}){return this.checkCondition(e)}checkCondition(e){const{type:t,version:i}=e;if(!this.sdkLanguage)return l.Ok(!1);if("string"!=typeof this.conditionValue)return l.Ok(t===this.sdkLanguage);if(!this.versionMatchType)return l.Ok(!1);if(t!==this.sdkLanguage)return l.Ok(!1);const a=Ke.compareSemVer({version:i,compareVersion:this.conditionValue,operator:this.versionMatchType});return a.ok?l.Ok(a.data):l.Err(a.error)}}class st{constructor({visitorCode:e,matchType:t}){this.matchType=t,this.conditionValue=e}evaluate({visitorCode:e}){return l.Ok(this.checkCondition(e))}checkCondition(e){if(!this.matchType||!this.conditionValue)return!1;switch(this.matchType){case Ee.CONTAINS:return e.includes(this.conditionValue);case Ee.EXACT:return e===this.conditionValue;case Ee.REGULAR_EXPRESSION:return ze.parseRegExp(this.conditionValue).test(e);default:return M.error`Unexpected comparing operation for VisitorCode condition: ${this.matchType}`,!1}}}class ut{constructor({name:e,value:t,nameMatchType:i,valueMatchType:a}){this.cookie={key:null!=e?e:void 0,value:null!=t?t:void 0},this.keyMatchType=i,this.valueMatchType=a}evaluate({targetingData:t}){var i;const a=!this.cookie.key&&!this.cookie.value,n=Boolean(this.valueMatchType)&&Boolean(this.keyMatchType);if(a||!n)return l.Ok(!1);const o=this.extractCookie(),r=(null===(i=null==t?void 0:t[e.KameleoonData.Cookie])||void 0===i?void 0:i.cookie)||[];return l.Ok(o.some(e=>this.checkCondition(e))||r.some(e=>this.checkCondition(e)))}extractCookie(){return"undefined"!=typeof document&&document.cookie?qe.fromString(document.cookie).data.cookie:[]}checkCondition(e){const t=this.keyMatchType,{key:i,value:a}=e;if(t===Ie.OPTIONAL){const e=this.cookie;return!!this.isOptionalCookie(e)&&this.compareCookieValue(a,e.value)}const{key:n,value:o}=this.cookie;let r;switch(t){case Ie.EXACT:r=i===n;break;case Ie.CONTAINS:r=i.includes(n);break;case Ie.REGULAR_EXPRESSION:r=ze.parseRegExp(n).test(i);break;default:M.error`Unexpected comparing operation for Cookie condition: ${t}`,g(t)}return r&&this.compareCookieValue(a,o)}compareCookieValue(e,t){const i=this.valueMatchType;switch(i){case me.EXACT:return e===t;case me.CONTAINS:return e.includes(t);case me.REGULAR_EXPRESSION:return ze.parseRegExp(t).test(e);default:return M.error`Unexpected comparing operation for Cookie condition: ${i}`,!1}}isOptionalCookie(e){const{value:t}=e;return void 0!==t}}class lt{constructor({os:e}){this.operatingSystem=e}evaluate({targetingData:t}){const i=null==t?void 0:t[e.KameleoonData.OperatingSystem];if(i){const{operatingSystem:e}=i;return l.Ok(e===this.operatingSystem)}return l.Ok(!1)}}class dt{constructor({country:e,region:t,city:i}){this.country=e,this.region=t,this.city=i}evaluate({targetingData:t}){const i=null==t?void 0:t[e.KameleoonData.GeolocationData];if(i){const{country:e,region:t,city:a}=i,[n,o,r]=[this.country,this.region,this.city];if(!n||!e)return l.Ok(!1);const s=!(e.toLowerCase()!==n.toLowerCase()||o&&(null==t?void 0:t.toLowerCase())!==o.toLowerCase()||r&&(null==a?void 0:a.toLowerCase())!==r.toLowerCase());return l.Ok(s)}return l.Ok(!1)}}class ct{constructor({segmentId:e}){this.segmentId=e}evaluate(e){const{segments:t,trees:i}=e;if(!this.segmentId)return l.Ok(!1);const a=null==t?void 0:t.get(this.segmentId.toString());if(!a)return l.Ok(!1);const n=null==i?void 0:i.get(this.segmentId.toString());return n?n.evaluate(e):new Qe(a).evaluate(e)}}class gt{constructor({featureFlagId:e,variationKey:t,ruleId:i}){this.featureId=e,this.ruleId=i,this.variationKey=t}evaluate({variationData:e,ruleMap:t}){var i,a,n,o;if(!this.featureId||!t)return l.Ok(!1);if(this.featureId&&!this.ruleId&&!this.variationKey){for(const[a,n]of t){const{featureId:t,experimentId:a}=n;if(t===this.featureId&&"number"==typeof(null===(i=e[a])||void 0===i?void 0:i.variationId))return l.Ok(!0)}return l.Ok(!1)}if(this.featureId&&this.ruleId){const i=t.get(this.ruleId);if(!i)return l.Ok(!1);const{experimentId:o,variations:r}=i;if(this.variationKey){const t=r.get(this.variationKey);return l.Ok(Boolean(t)&&(null===(a=e[o])||void 0===a?void 0:a.variationId)===t)}return l.Ok(Boolean(null===(n=e[i.experimentId])||void 0===n?void 0:n.variationId))}if(this.featureId&&!this.ruleId&&this.variationKey)for(const[i,a]of t){const{featureId:t,experimentId:i,variations:n}=a;if(t===this.featureId&&n.has(this.variationKey)){const t=n.get(this.variationKey);return l.Ok(Boolean(t)&&(null===(o=e[i])||void 0===o?void 0:o.variationId)===t)}}return l.Ok(!1)}}class ht{constructor({matchType:e,url:t}){this.conditionValue=t,this.matchType=e}evaluate({targetingData:t}){const i=null==t?void 0:t[e.KameleoonData.PageView];if(!i)return l.Ok(!1);const a=this.getSecondLatestPageView(Object.values(i));if(!a)return l.Ok(!1);const n=a.urlAddress;return l.Ok(this.checkCondition(n))}checkCondition(e){if(!this.matchType||!this.conditionValue)return!1;switch(this.matchType){case Ee.CONTAINS:return e.includes(this.conditionValue);case Ee.EXACT:return e===this.conditionValue;case Ee.REGULAR_EXPRESSION:return ze.parseRegExp(this.conditionValue).test(e);default:return M.error`Unexpected comparing operation for PreviousPage condition: ${this.matchType}`,!1}}getSecondLatestPageView(e){if(e.length<2)return;let t,i;return e.forEach(e=>{const a=e.timestamps[e.timestamps.length-1].time;if(t)return a>t.timestamps[t.timestamps.length-1].time?(i=t,void(t=e)):void(a>(i?i.timestamps[i.timestamps.length-1].time:0)&&(i=e));t=e}),i}}class pt{constructor({matchType:e,pageCount:t}){this.matchType=e,this.conditionValue=t}evaluate({targetingData:t}){const i=null==t?void 0:t[e.KameleoonData.PageView];if(!i)return l.Ok(!1);let a=0;return Object.values(i).forEach(e=>{a+=e.timestamps.length}),l.Ok(this.checkCondition(a))}checkCondition(e){if(!this.matchType||"number"!=typeof this.conditionValue)return!1;switch(this.matchType){case Ee.EQUAL:return e===this.conditionValue;case Ee.GREATER:return e>this.conditionValue;case Ee.LOWER:return e<this.conditionValue;default:return M.error`Unexpected comparing operation for VisitedPages condition: ${this.matchType}`,!1}}}class vt{constructor({matchType:e,count:t,unitOfTime:i}){this.matchType=e,this.conditionValue=t,this.timeUnit=i}evaluate({targetingData:t,sdkInfo:i}){const a=null==t?void 0:t[e.KameleoonData.VisitsData];if(i.isServer?!(null==a?void 0:a.visits.length):!(null==a?void 0:a.visits)||a.visits.length<2)return l.Ok(!1);const n=a.visits[0];return l.Ok(this.checkCondition("number"==typeof n?n:n.timeStarted))}checkCondition(e){if(!this.matchType||"number"!=typeof this.conditionValue||!this.timeUnit)return!1;const t=Date.now()-e,i=Ke.convertTimeUnit(t,this.timeUnit);switch(this.matchType){case Ee.GREATER:return i>this.conditionValue;case Ee.LOWER:return i<this.conditionValue;default:return M.error`Unexpected comparing operation for FirstVisit condition: ${this.matchType}`,!1}}}class mt{constructor({matchType:e,count:t,unitOfTime:i}){this.matchType=e,this.conditionValue=t,this.timeUnit=i}evaluate({targetingData:t,sdkInfo:i}){const a=null==t?void 0:t[e.KameleoonData.VisitsData];if(i.isServer?!(null==a?void 0:a.visits.length):!(null==a?void 0:a.visits)||a.visits.length<2)return l.Ok(!1);const n=a.visits,o=n[i.isServer?n.length-1:n.length-2];return l.Ok(this.checkCondition("number"==typeof o?o:o.timeStarted))}checkCondition(e){if(!this.matchType||"number"!=typeof this.conditionValue||!this.timeUnit)return!1;const t=Date.now()-e,i=Ke.convertTimeUnit(t,this.timeUnit);switch(this.matchType){case Ee.GREATER:return i>this.conditionValue;case Ee.LOWER:return i<this.conditionValue;default:return M.error`Unexpected comparing operation for LastVisit condition: ${this.matchType}`,!1}}}class ft{constructor({matchType:e,visitCount:t}){this.matchType=e,this.conditionValue=t}evaluate({targetingData:t,sdkInfo:i}){const a=null==t?void 0:t[e.KameleoonData.VisitsData];if(!a)return l.Ok(!1);let n=0;const o=(new Date).setHours(0,0,0,0),{visits:r}=a;return r.forEach(e=>{let t;t="number"==typeof e?e:e.timeStarted,t>=o&&n++}),i.isServer&&(n+=1),l.Ok(this.checkCondition(n))}checkCondition(e){if(!this.matchType||"number"!=typeof this.conditionValue)return!1;switch(this.matchType){case Ee.EQUAL:return e===this.conditionValue;case Ee.GREATER:return e>this.conditionValue;case Ee.LOWER:return e<this.conditionValue;default:return M.error`Unexpected comparing operation for SameDayVisits condition: ${this.matchType}`,!1}}}class Ct{constructor({matchType:e,visitCount:t}){this.matchType=e,this.conditionValue=t}evaluate({targetingData:t,sdkInfo:i}){const a=null==t?void 0:t[e.KameleoonData.VisitsData];if(!a)return l.Ok(!1);const n=a.visits.length+(i.isServer?1:0);return l.Ok(this.checkCondition(n))}checkCondition(e){if(!this.matchType||"number"!=typeof this.conditionValue)return!1;switch(this.matchType){case Ee.EQUAL:return e===this.conditionValue;case Ee.GREATER:return e>this.conditionValue;case Ee.LOWER:return e<this.conditionValue;default:return M.error`Unexpected comparing operation for Visits condition: ${this.matchType}`,!1}}}class yt{constructor({visitorType:e}){this.visitorType=e}evaluate({targetingData:t,sdkInfo:i}){const a=null==t?void 0:t[e.KameleoonData.VisitsData];if(!a||!this.visitorType)return l.Ok(!1);const{visits:n}=a,o=i.isServer?!n.length:n.length<=1;switch(this.visitorType){case fe.NEW:return l.Ok(o);case fe.RETURNING:return l.Ok(!o);default:M.error`Unexpected visitor type for NewVisitor condition: ${this.visitorType}`,g(this.visitorType)}}}class Dt{constructor({version:e,versionMatchType:t}){this.conditionValue=e,this.versionMatchType=t}evaluate({targetingData:t}){var i;const a=null===(i=null==t?void 0:t[e.KameleoonData.ApplicationVersion])||void 0===i?void 0:i.version;if(!a||!this.conditionValue||!this.versionMatchType)return l.Ok(!1);const n=Ke.compareSemVer({version:a,compareVersion:this.conditionValue,operator:this.versionMatchType});return n.ok?l.Ok(n.data):l.Err(n.error)}}class Et{constructor({lowerBound:e,upperBound:t,keyMomentId:i,goalId:a}){this.lowerBound=e,this.upperBound=t,this.keyMomentId=i,this.goalId=a}evaluate({targetingData:t}){var i;const a=null==t?void 0:t[e.KameleoonData.KameleoonConversionScore];if("number"!=typeof this.keyMomentId||"number"!=typeof this.goalId||"number"!=typeof this.lowerBound||"number"!=typeof this.upperBound||!a)return l.Ok(!1);const n=null===(i=a.kcs[this.keyMomentId.toString()])||void 0===i?void 0:i[this.goalId.toString()];return"number"!=typeof n?l.Ok(!1):l.Ok(n>=this.lowerBound&&n<=this.upperBound)}}class Tt{constructor({campaignType:e}){this.campaignType=e}evaluate(e){return l.Ok(this.checkCondition(e))}checkCondition(e){var t;const i=Object.values(e.variationData),a=Object.values((null===(t=e.targetingData)||void 0===t?void 0:t.personalization)||{}),n=1===i.length&&null!==e.experimentId&&void 0!==e.variationData[e.experimentId],o=0===i.length,r=0===a.length;switch(this.campaignType){case De.Experiment:return o||n;case De.Personalization:return r;case De.Any:return r&&(o||n);default:return!1}}}class It{constructor({variationMatchType:e,variation:t,experiment:i}){this.variationMatchType=e,this.variationId=t||-1,this.experimentId=i||-1}evaluate(e){return l.Ok(this.checkCondition(e))}checkCondition(e){const t=e.variationData[this.experimentId];if(!t)return!1;switch(this.variationMatchType){case Ce.ANY:return!0;case Ce.EXACT:return t.variationId===this.variationId;default:return!1}}}class kt{constructor({personalizationId:e}){this.personalizationId=e}evaluate(e){return e.targetingData?l.Ok(this.checkCondition(e)):l.Ok(!1)}checkCondition(t){var i;if(!this.personalizationId)return!1;const a=null===(i=t.targetingData)||void 0===i?void 0:i[e.KameleoonData.Personalization];return void 0!==(null==a?void 0:a[this.personalizationId])}}class St{createCondition(t){const{targetingType:i}=t;switch(i){case ke.CUSTOM_DATUM:return l.Ok(new it(t));case ke.EXCLUSIVE_EXPERIMENT:return l.Ok(new Tt(t));case ke.TARGET_EXPERIMENT:return l.Ok(new It(t));case ke.TARGET_FEATURE_FLAG:return l.Ok(new gt(t));case ke.TARGET_PERSONALIZATION:return l.Ok(new kt(t));case ke.DEVICE_TYPE:return l.Ok(new Ze(t));case ke.BROWSER:return l.Ok(new et(t));case ke.PAGE_URL:return l.Ok(new ot(t));case ke.PAGE_TITLE:return l.Ok(new nt(t));case ke.CONVERSIONS:return l.Ok(new tt(t));case ke.VISITOR_CODE:return l.Ok(new st(t));case ke.SDK_LANGUAGE:return l.Ok(new rt(t));case ke.COOKIE:return l.Ok(new ut(t));case ke.OPERATING_SYSTEM:return l.Ok(new lt(t));case ke.GEOLOCATION:return l.Ok(new dt(t));case ke.SEGMENT:return l.Ok(new ct(t));case ke.APPLICATION_VERSION:return l.Ok(new Dt(t));case ke.PREVIOUS_PAGE:return l.Ok(new ht(t));case ke.PAGE_VIEWS:return l.Ok(new pt(t));case ke.LAST_VISIT:return l.Ok(new mt(t));case ke.FIRST_VISIT:return l.Ok(new vt(t));case ke.SAME_DAY_VISITS:return l.Ok(new ft(t));case ke.VISITS:return l.Ok(new Ct(t));case ke.NEW_VISITORS:return l.Ok(new yt(t));case ke.HEAT_SLICE:return l.Ok(new Et(t));default:return M.info`Unsupported targeted condition type found: ${i}`,l.Err(new h(e.KameleoonException.TargetingCondition,i))}}}var Vt;e.KameleoonStorageKey=void 0,(Vt=e.KameleoonStorageKey||(e.KameleoonStorageKey={})).ClientData="kameleoonClientData",Vt.TargetingData="kameleoonTargetingData",Vt.TrackingData="kameleoonTrackingData",Vt.VariationData="kameleoonVariationData",Vt.VisitorCode="kameleoonVisitorCode",Vt.ConsentData="kameleoonConsentData",Vt.DataInfo="kameleoonDataInfo",Vt.KameleoonSimulationFFData="kameleoonSimulationFFData",Vt.ForcedFeatureVariation="kameleoonForcedFeatureVariation",Vt.ForcedExperimentVariation="kameleoonForcedExperimentVariation";const wt={data:Z,lastUpdate:""},Rt=29*e.Milliseconds.Minute;class bt{constructor(e){this.key=e}isDataValid(t){switch(this.key){case e.KameleoonStorageKey.ClientData:return this.checkClientDataIntegrity(t);case e.KameleoonStorageKey.TargetingData:return this.checkTargetingDataIntegrity(t);case e.KameleoonStorageKey.DataInfo:return this.checkDataInfoIntegrity(t);case e.KameleoonStorageKey.VariationData:return this.checkVariationDataIntegrity(t);case e.KameleoonStorageKey.TrackingData:return this.checkTrackingDataIntegrity(t);default:return!0}}getDefaultData(){switch(this.key){case e.KameleoonStorageKey.ClientData:return this.getDefaultClientData();case e.KameleoonStorageKey.DataInfo:return{unsentData:{},nextVisitTime:0,mappingIdentifiers:{}};case e.KameleoonStorageKey.TrackingData:return{scheduledVisitors:{}};case e.KameleoonStorageKey.TargetingData:case e.KameleoonStorageKey.VariationData:case e.KameleoonStorageKey.ConsentData:return{};case e.KameleoonStorageKey.VisitorCode:case e.KameleoonStorageKey.KameleoonSimulationFFData:return"";case e.KameleoonStorageKey.ForcedExperimentVariation:case e.KameleoonStorageKey.ForcedFeatureVariation:return{};default:g(this.key)}}checkTrackingDataIntegrity(e){return this.hasFields(e,["scheduledVisitors"])}checkDataInfoIntegrity(e){return this.hasFields(e,["unsentData","nextVisitTime"])}checkVariationDataIntegrity(e){const t=Object.values(e);if(!t.length)return!0;const i=e=>!this.hasFields(e,["status"])||this.hasFields(e,["isSent"]);for(const e of t)for(const t of Object.values(e))if(i(t))return!1;return!0}checkClientDataIntegrity(e){return this.hasFields(e,Object.keys(wt))}checkTargetingDataIntegrity(t){const i=Object.values(t);if(!i.length)return!0;for(const t of i){if("string"==typeof t)continue;const i=e=>!this.hasFields(e,["status"])||this.hasFields(e,["sent"])||this.hasFields(e,["timestampList"]);for(const[a,n]of Object.entries(t)){if(Array.isArray(n))return!1;switch(a){case e.KameleoonData.PageView:case e.KameleoonData.Conversion:case e.KameleoonData.Personalization:case e.KameleoonData.TargetedSegment:case e.KameleoonData.CustomData:if(Object.values(n).some(e=>i(e)))return!1;continue;default:if(i(n))return!1}}}return!0}getDefaultClientData(){return Object.assign(Object.assign({},wt),{lastUpdate:(new Date).toString()})}hasFields(e,t){const i=Object.keys(e);return!(!i.length||!t.length)&&t.every(e=>i.includes(e))}}let Kt=class{constructor(t,i){this.externalStorage=t,this.storageKey=i;const a=new bt(i),n=this.read();if(!n.ok){if(n.error.type===e.KameleoonException.StorageEmpty){const e=a.getDefaultData();this.write(e)}return}const o=n.data;if(!a.isDataValid(o)){const e=a.getDefaultData();this.write(e)}}read(){try{const t=this.externalStorage.read(this.storageKey);return null===t?l.Err(new h(e.KameleoonException.StorageEmpty)):l.Ok(t)}catch(t){return M.error`Failed to read data from storage: ${this.storageKey}`,l.Err(new h(e.KameleoonException.StorageRead,this.storageKey))}}write(t){try{return this.externalStorage.write(this.storageKey,t),l.Ok()}catch(t){return M.error`Failed to write data to storage: ${this.storageKey}`,l.Err(new h(e.KameleoonException.StorageWrite,this.storageKey))}}update(t){const i=this.read();if(!i.ok)return i.error.type===e.KameleoonException.StorageEmpty?this.write(t):i;const a=i.data;let n;return n="string"==typeof a?t:Object.assign(Object.assign({},a),t),this.write(n)}};class At{constructor(e,t){this.externalStorage=e,this.cleanupInterval=t,t>0&&this.initCleanupInterval()}initCleanupInterval(){for(const t of Object.values(e.KameleoonStorageKey)){let i=null;try{switch(t){case e.KameleoonStorageKey.ForcedFeatureVariation:case e.KameleoonStorageKey.ForcedExperimentVariation:case e.KameleoonStorageKey.VariationData:case e.KameleoonStorageKey.ConsentData:M.info`Starting cleanup for ${t} with interval ${this.cleanupInterval}`,i=setInterval(()=>this.cleanupData(t),this.cleanupInterval);break;case e.KameleoonStorageKey.ClientData:case e.KameleoonStorageKey.TargetingData:case e.KameleoonStorageKey.TrackingData:case e.KameleoonStorageKey.VisitorCode:case e.KameleoonStorageKey.DataInfo:case e.KameleoonStorageKey.KameleoonSimulationFFData:break;default:M.error`Unknown storage key: ${t} for initCleanupInterval.`}}catch(e){i&&clearInterval(i),M.error`Error while starting cleanup for ${t} with interval ${this.cleanupInterval}`}}}cleanupData(t){const i=this.externalStorage.read(t);if(!i)return;const a=Date.now();switch(t){case e.KameleoonStorageKey.VariationData:this.cleanupVariationData(i,a);break;case e.KameleoonStorageKey.ForcedFeatureVariation:this.cleanupForcedFeatureVariationData(i,a);break;case e.KameleoonStorageKey.ForcedExperimentVariation:this.cleanupForcedExperimentVariationData(i,a);break;case e.KameleoonStorageKey.ConsentData:this.cleanupConsentData(i,a);break;case e.KameleoonStorageKey.ClientData:case e.KameleoonStorageKey.TargetingData:case e.KameleoonStorageKey.TrackingData:case e.KameleoonStorageKey.VisitorCode:case e.KameleoonStorageKey.DataInfo:case e.KameleoonStorageKey.KameleoonSimulationFFData:break;default:M.error`Unknown storage key: ${t} for cleanupData.`}this.externalStorage.write(t,i)}cleanupConsentData(e,t){for(const[i,a]of Object.entries(e)){if("boolean"==typeof a){e[i]={consent:a,expirationTime:t+this.cleanupInterval};continue}const n=a;"number"==typeof n.expirationTime?n.expirationTime<t&&delete e[i]:n.expirationTime=t+this.cleanupInterval}}cleanupVariationData(e,t){for(const[i,a]of Object.entries(e))this.cleanupObjectValues(a,t),0===Object.keys(e[i]).length&&delete e[i]}cleanupForcedFeatureVariationData(e,t){for(const[i,a]of Object.entries(e))for(const[n,o]of Object.entries(a))this.cleanupObjectValues(o,t),0===Object.keys(e[Number(i)][n]).length&&delete e[Number(i)][n]}cleanupForcedExperimentVariationData(e,t){for(const[i,a]of Object.entries(e))this.cleanupObjectValues(a,t),0===Object.keys(e[i]).length&&delete e[i]}cleanupObjectValues(e,t){for(const[i,a]of Object.entries(e))"number"==typeof a.expirationTime?a.expirationTime<t&&delete e[i]:a.expirationTime=t+this.cleanupInterval}}var xt;!function(e){e[e.Unknown=0]="Unknown",e[e.Given=1]="Given",e[e.NotGiven=2]="NotGiven"}(xt||(xt={}));class Ot{constructor(t){this.id=t,this.status=e.TrackingStatus.Unsent}get url(){return"eventType=targetingSegment"+S+this.id}get data(){return{id:this.id,type:e.KameleoonData.TargetedSegment,status:this.status}}static _fromRaw(e){const{id:t,status:i}=e,a=new Ot(t);return a.status=i,a}}class $t{constructor({dataStorage:e,infoStorage:t,cleanupInterval:i,packageInfo:a}){if(this.targetingTrees=new Map,this.mappingIdentifierCustomDataIndex=null,this.persistentCustomDataIndexes=new Set,this.localCustomDataIndexes=new Set,this.customDataIndexByName=new Map,this.cleanupIntervalId=null,M.debug`CALL: new DataManager(dataStorage, infoStorage, cleanupInterval: ${i})`,this.dataStorage=e,this.infoStorage=t,this.dataProcessor=new We(i,a),this.packageInfo=a,i){const e=()=>{this.cleanupData()};try{this.cleanupIntervalId=setInterval(e,i)}catch(e){throw this.cleanupIntervalId&&clearInterval(this.cleanupIntervalId),M.error`Failed to set cleanup interval: ${i}`,e}}M.debug`RETURN: new DataManager(dataStorage, infoStorage, cleanupInterval: ${i})`}getUnsentData(t){const i=this.infoStorage.read();if(!i.ok)return[];const a=i.data,n=this.getVisitorData(t);if(!a.unsentData[t]||!n)return[];const o=a.unsentData[t],r=a.nextVisitTime<=Date.now();return r&&(a.nextVisitTime=Date.now()+Rt,this.infoStorage.write(a)),this.getDataFromRaw(n,({status:t,key:i,cdIndex:a})=>!("number"!=typeof a||!this.persistentCustomDataIndexes.has(a)||!r)||o.includes(i)&&t===e.TrackingStatus.Unsent)}getPendingData(t){const i=this.getVisitorData(t);return i?this.getDataFromRaw(i,({status:t})=>t===e.TrackingStatus.Pending):[]}getDataFromRaw(t,i){const a=[];for(const[n,o]of Object.entries(t))if(o)switch(n){case e.KameleoonData.CustomData:for(const e of Object.values(o)){if(!e)continue;const{status:t,index:o}=e;if(i({status:t,key:n,cdIndex:o})){const t=Oe._fromRaw(e);a.push(t)}}break;case e.KameleoonData.Conversion:for(const e of Object.values(o))if(e&&i({status:e.status,key:n})){const t=$e._fromRaw(e);a.push(t)}break;case e.KameleoonData.PageView:{const e=o;for(const t of Object.values(e))if(i({status:t.status,key:n})){const e=xe._fromRaw(t);a.push(e)}break}case e.KameleoonData.TargetedSegment:{const e=o;for(const t of Object.values(e))if(i({status:t.status,key:n})){const e=Ot._fromRaw(t);a.push(e)}break}case e.KameleoonData.GeolocationData:{const e=o;if(!o)continue;if(i({status:e.status,key:n})){const t=Le._fromRaw(e);a.push(t)}break}case e.KameleoonData.Browser:{const e=o;if(i({status:e.status,key:n})){const t=Ne._fromRaw(e);a.push(t)}break}case e.KameleoonData.Device:{const e=o;if(i({status:e.status,key:n})){const t=Me._fromRaw(e);a.push(t)}break}case e.KameleoonData.OperatingSystem:{const e=o;if(i({status:e.status,key:n})){const t=Fe._fromRaw(e);a.push(t)}}}return a}storeTrackedData(t){this.storeData(t,!1);const i=this.infoStorage.read();if(!i.ok)return;const a=i.data.unsentData;for(const[i,n]of Object.entries(t)){if(!a[i])return;const t=new Set(a[i]);n.forEach(({data:e})=>{t.has(e.type)&&t.delete(e.type)});const o=n.some(({data:t})=>{if(t.type!==e.KameleoonData.CustomData)return!1;const{index:i}=t;return this.persistentCustomDataIndexes.has(i)||this.mappingIdentifierCustomDataIndex===i});o&&t.add(e.KameleoonData.CustomData),a[i]=Array.from(t),a[i].length||delete a[i]}this.infoStorage.write(i.data)}storeData(e,...t){M.debug`CALL: DataManager.storeData(visitorCode: ${e}, data: ${t})`;const i=this.dataStorage.read(),a=this.infoStorage.read();if(!i.ok)return i;if(!a.ok)return a;const n=i.data,o=a.data;if("string"==typeof e)this.mutUpdateTargetingData({infoData:o,targetingData:n,visitorCode:e,kameleoonData:t,extendTtl:!0});else for(const[i,a]of Object.entries(e)){const e="boolean"!=typeof t[0]||t[0];this.mutUpdateTargetingData({infoData:o,targetingData:n,visitorCode:i,kameleoonData:a,extendTtl:e})}this.cleanupData(),this.infoStorage.write(a.data);const r=this.dataStorage.write(n);return M.debug`RETURN: DataManager.storeData(visitorCode: ${e}, data: ${t}) -> (writeResult: ${r})`,r}getTree(e){if(this.targetingTrees.has(e.id))return this.targetingTrees.get(e.id);const t=new Qe(e);return this.targetingTrees.set(e.id,t),t}clearTrees(){this.targetingTrees.clear()}isPersistentCustomData(e){return!!this.persistentCustomDataIndexes.size&&!!Ke.isCustomData(e)&&this.persistentCustomDataIndexes.has(e.data.index)}isUniqueIdentifier(t){var i;const a=this.getVisitorData(t),n=null==a?void 0:a[e.KameleoonData.UniqueIdentifier];return null!==(i=null==n?void 0:n.value)&&void 0!==i&&i}getVisitorIdentifier(e){var t,i,a;const n=this.infoStorage.read();if(!n.ok)return e;const o=n.data;return null!==(t=o.mappingIdentifiers)&&void 0!==t||(o.mappingIdentifiers={}),null!==(a=null===(i=o.mappingIdentifiers[e])||void 0===i?void 0:i.mappingIdentifier)&&void 0!==a?a:e}getMappingIdentifier(e){const t=this.infoStorage.read();if(!t.ok)return;const i=t.data;return i.mappingIdentifiers?i.mappingIdentifiers[e]:void 0}setMappingIdentifier(e,t){var i;const a=this.infoStorage.read();if(!a.ok)return;const n=a.data;null!==(i=n.mappingIdentifiers)&&void 0!==i||(n.mappingIdentifiers={});const o=n.mappingIdentifiers[e];(!o||o.timestamp<t.timestamp)&&(n.mappingIdentifiers[e]=t,this.infoStorage.write(n))}getVisitorData(e){this.cleanupData();const t=this.dataStorage.read();if(!t.ok)return;let{visitorReference:i,data:a,isReference:n}=this.dataProcessor.dereferenceData(t.data,e);if(this.packageInfo.isServer&&n&&!a[i]){const t=this.infoStorage.read();t.ok&&t.data.mappingIdentifiers&&delete t.data.mappingIdentifiers[e],delete a[e],i=e}return a[i]}getVisitorStoredDataTypes(e){const t=this.getVisitorData(e);return t?new Set(Object.keys(t)):new Set}getLinkedVisitor(t){const i=this.dataStorage.read();if(!i.ok)return null;if("string"==typeof i.data[t])return i.data[t];if(null===this.mappingIdentifierCustomDataIndex)return null;const a=i.data[t];if(!a)return null;const n=a[e.KameleoonData.CustomData];return n&&n[this.mappingIdentifierCustomDataIndex]?n[this.mappingIdentifierCustomDataIndex].value[0]:null}mutUpdateTargetingData({infoData:t,visitorCode:i,kameleoonData:a,targetingData:n,extendTtl:o}){var r,s,u;for(const l of a){if(l.data.type===e.KameleoonData.CustomData&&!this.processCustomData({infoData:t,customData:l,mutData:n,visitorCode:i}))continue;if(l.data.type===e.KameleoonData.Conversion){const e=l;(null!==(s=null===(r=e._metadata)||void 0===r?void 0:r.length)&&void 0!==s?s:0)>0&&(e._metadata=null===(u=e._metadata)||void 0===u?void 0:u.filter(e=>this.trySetCustomDataIndexByName(e)))}const a=this.dataProcessor.mutUpdateData({infoData:t,visitorCode:i,mutData:n,dataItem:l,extendTtl:o}),d=t.nextDataCleanup;(!d||d&&a&&a<d)&&(t.nextDataCleanup=a),l.data.status===e.TrackingStatus.Unsent&&this.dataProcessor.mutAddUnsentData({mutData:t,visitorCode:i,dataType:l.data.type})}}cleanupData(){const e=this.dataStorage.read(),t=this.infoStorage.read();if(!e.ok||!t.ok)return;const i=e.data,a=t.data,n=a.nextDataCleanup;if(n&&n<Date.now()){const e=this.dataProcessor.mutCleanupData(i,a);a.nextDataCleanup=e||void 0,this.infoStorage.write(a),this.dataStorage.write(i)}}processCustomData({infoData:t,mutData:i,customData:a,visitorCode:n}){var o;const{data:r}=a,s=Boolean(r.value.length&&r.value[0].length);if(!this.trySetCustomDataIndexByName(a))return!1;if(r.index==Oe.UNDEFINED_INDEX&&(r.index=a.index),this.mappingIdentifierCustomDataIndex===r.index&&s){a._isMappingIdentifier=!0;const e=r.value[0];n!==e&&(M.info`Linked anonymous visitor ${n} with user ${e}`,this.dataProcessor.createReference({infoData:t,mutData:i,visitorCode:n,linkedVisitor:r.value[0]}),null!==(o=t.mappingIdentifiers)&&void 0!==o||(t.mappingIdentifiers={}),t.mappingIdentifiers[e]={mappingIdentifier:n,timestamp:Date.now()})}return this.localCustomDataIndexes.has(r.index)&&(a.status=e.TrackingStatus.Sent),!0}trySetCustomDataIndexByName(e){if(e.index!==Oe.UNDEFINED_INDEX)return!0;if(!e.name)return!1;const t=this.customDataIndexByName.get(e.name);return null!=t&&(e.index=t,!0)}get unsentDataVisitors(){const e=this.infoStorage.read();return e.ok?Object.keys(e.data.unsentData):[]}get identifierCustomDataIndex(){return this.mappingIdentifierCustomDataIndex}get trees(){return this.targetingTrees}get storedCustomDataIndexes(){const t=this.dataStorage.read();if(!t.ok)return new Set;const i=t.data;if(!(e.KameleoonData.CustomData in i))return new Set;const a=new Set;for(const t in Object.keys(i[e.KameleoonData.CustomData]))a.add(Number(t));return a}set customDataIndexes(t){var i;const[a,n]=[[],[]],o=new Map;t.forEach(t=>{t.localOnly&&a.push(t.index),t.scope===e.CustomDataScope.Visitor&&n.push(t.index),t.name&&o.set(t.name,t.index)}),this.mappingIdentifierCustomDataIndex=(null===(i=t.find(e=>e.isMappingIdentifier))||void 0===i?void 0:i.index)||null,this.localCustomDataIndexes=new Set(a),this.persistentCustomDataIndexes=new Set(n),this.customDataIndexByName=o}getCustomDataIndexByName(e){return this.customDataIndexByName.get(e)}}var Nt,Mt,Ft={exports:{}},Lt={exports:{}},_t=a(Object.freeze({__proto__:null,default:{}}));var Ut=(Mt||(Mt=1,function(e){var i;e.exports=(Nt||(Nt=1,function(e){var i;e.exports=(i=i||function(e){var i;if("undefined"!=typeof window&&window.crypto&&(i=window.crypto),"undefined"!=typeof self&&self.crypto&&(i=self.crypto),"undefined"!=typeof globalThis&&globalThis.crypto&&(i=globalThis.crypto),!i&&"undefined"!=typeof window&&window.msCrypto&&(i=window.msCrypto),!i&&void 0!==t&&t.crypto&&(i=t.crypto),!i)try{i=_t}catch(e){}var a=function(){if(i){if("function"==typeof i.getRandomValues)try{return i.getRandomValues(new Uint32Array(1))[0]}catch(e){}if("function"==typeof i.randomBytes)try{return i.randomBytes(4).readInt32LE()}catch(e){}}throw new Error("Native crypto module could not be used to get secure random number.")},n=Object.create||function(){function e(){}return function(t){var i;return e.prototype=t,i=new e,e.prototype=null,i}}(),o={},r=o.lib={},s=r.Base={extend:function(e){var t=n(this);return e&&t.mixIn(e),t.hasOwnProperty("init")&&this.init!==t.init||(t.init=function(){t.$super.init.apply(this,arguments)}),t.init.prototype=t,t.$super=this,t},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}},u=r.WordArray=s.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=null!=t?t:4*e.length},toString:function(e){return(e||d).stringify(this)},concat:function(e){var t=this.words,i=e.words,a=this.sigBytes,n=e.sigBytes;if(this.clamp(),a%4)for(var o=0;o<n;o++){var r=i[o>>>2]>>>24-o%4*8&255;t[a+o>>>2]|=r<<24-(a+o)%4*8}else for(var s=0;s<n;s+=4)t[a+s>>>2]=i[s>>>2];return this.sigBytes+=n,this},clamp:function(){var t=this.words,i=this.sigBytes;t[i>>>2]&=4294967295<<32-i%4*8,t.length=e.ceil(i/4)},clone:function(){var e=s.clone.call(this);return e.words=this.words.slice(0),e},random:function(e){for(var t=[],i=0;i<e;i+=4)t.push(a());return new u.init(t,e)}}),l=o.enc={},d=l.Hex={stringify:function(e){for(var t=e.words,i=e.sigBytes,a=[],n=0;n<i;n++){var o=t[n>>>2]>>>24-n%4*8&255;a.push((o>>>4).toString(16)),a.push((15&o).toString(16))}return a.join("")},parse:function(e){for(var t=e.length,i=[],a=0;a<t;a+=2)i[a>>>3]|=parseInt(e.substr(a,2),16)<<24-a%8*4;return new u.init(i,t/2)}},c=l.Latin1={stringify:function(e){for(var t=e.words,i=e.sigBytes,a=[],n=0;n<i;n++){var o=t[n>>>2]>>>24-n%4*8&255;a.push(String.fromCharCode(o))}return a.join("")},parse:function(e){for(var t=e.length,i=[],a=0;a<t;a++)i[a>>>2]|=(255&e.charCodeAt(a))<<24-a%4*8;return new u.init(i,t)}},g=l.Utf8={stringify:function(e){try{return decodeURIComponent(escape(c.stringify(e)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(e){return c.parse(unescape(encodeURIComponent(e)))}},h=r.BufferedBlockAlgorithm=s.extend({reset:function(){this._data=new u.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=g.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var i,a=this._data,n=a.words,o=a.sigBytes,r=this.blockSize,s=o/(4*r),l=(s=t?e.ceil(s):e.max((0|s)-this._minBufferSize,0))*r,d=e.min(4*l,o);if(l){for(var c=0;c<l;c+=r)this._doProcessBlock(n,c);i=n.splice(0,l),a.sigBytes-=d}return new u.init(i,d)},clone:function(){var e=s.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0});r.Hasher=h.extend({cfg:s.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){h.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,i){return new e.init(i).finalize(t)}},_createHmacHelper:function(e){return function(t,i){return new p.HMAC.init(e,i).finalize(t)}}});var p=o.algo={};return o}(Math),i)}(Lt)),i=Lt.exports,function(e){var t=i,a=t.lib,n=a.WordArray,o=a.Hasher,r=t.algo,s=[],u=[];!function(){function t(t){for(var i=e.sqrt(t),a=2;a<=i;a++)if(!(t%a))return!1;return!0}function i(e){return 4294967296*(e-(0|e))|0}for(var a=2,n=0;n<64;)t(a)&&(n<8&&(s[n]=i(e.pow(a,.5))),u[n]=i(e.pow(a,1/3)),n++),a++}();var l=[],d=r.SHA256=o.extend({_doReset:function(){this._hash=new n.init(s.slice(0))},_doProcessBlock:function(e,t){for(var i=this._hash.words,a=i[0],n=i[1],o=i[2],r=i[3],s=i[4],d=i[5],c=i[6],g=i[7],h=0;h<64;h++){if(h<16)l[h]=0|e[t+h];else{var p=l[h-15],v=(p<<25|p>>>7)^(p<<14|p>>>18)^p>>>3,m=l[h-2],f=(m<<15|m>>>17)^(m<<13|m>>>19)^m>>>10;l[h]=v+l[h-7]+f+l[h-16]}var C=a&n^a&o^n&o,y=(a<<30|a>>>2)^(a<<19|a>>>13)^(a<<10|a>>>22),D=g+((s<<26|s>>>6)^(s<<21|s>>>11)^(s<<7|s>>>25))+(s&d^~s&c)+u[h]+l[h];g=c,c=d,d=s,s=r+D|0,r=o,o=n,n=a,a=D+(y+C)|0}i[0]=i[0]+a|0,i[1]=i[1]+n|0,i[2]=i[2]+o|0,i[3]=i[3]+r|0,i[4]=i[4]+s|0,i[5]=i[5]+d|0,i[6]=i[6]+c|0,i[7]=i[7]+g|0},_doFinalize:function(){var t=this._data,i=t.words,a=8*this._nDataBytes,n=8*t.sigBytes;return i[n>>>5]|=128<<24-n%32,i[14+(n+64>>>9<<4)]=e.floor(a/4294967296),i[15+(n+64>>>9<<4)]=a,t.sigBytes=4*i.length,this._process(),this._hash},clone:function(){var e=o.clone.call(this);return e._hash=this._hash.clone(),e}});t.SHA256=o._createHelper(d),t.HmacSHA256=o._createHmacHelper(d)}(Math),i.SHA256)}(Ft)),Ft.exports),Pt=i(Ut);class Bt{static getHashDoubleForMEGroup(e,t){return this.calculateHash(e+t)}static getHashDouble({visitorIdentifier:e,id:t,respoolTime:i}){let a="";return i&&(a+=String(i)),this.calculateHash(e+t+a)}static calculateHash(e){const t=Pt(e).toString();return parseInt(t,16)/Math.pow(2,256)}}class Gt{constructor(e,t,i,a,n){this.storage=e,this.storageForcedExperimentVariations=t,this.storageForcedFeatureVariations=i,this.visitorCodeManager=a,this.clientConfiguration=n,a.setVariationConfiguration(this)}updateDataStatus({visitorCode:e,experimentIdList:t,status:i}){const a=this.storage.read();if(!a.ok)return a;let n=a.data;n[e]||(n[e]={});for(const a of t)n[e][a]=Object.assign(Object.assign({},n[e][a]),{status:i});return this.storage.write(n)}getUnsentData(t){return this.getVariationData(t,t=>t===e.TrackingStatus.Unsent)}getVisitorsWithUnsentData(){M.debug`CALL: VariationConfiguration.unsentDataVisitors()`;const t=this.storage.read();if(!t.ok)return M.debug`RETURN: VariationConfiguration.unsentDataVisitors() -> (result: ${t})`,[];const i=[];for(const[a,n]of Object.entries(t.data))Object.values(n).some(t=>t.status===e.TrackingStatus.Unsent)&&i.push(a);return M.debug`RETURN: VariationConfiguration.unsentDataVisitors() -> (visitors: ${i})`,i}getPendingData(t){return this.getVariationData(t,t=>t===e.TrackingStatus.Pending)}getStoredVariations(t){const i=this.storage.read();if(!i.ok)return i;const a=i.data[t];return a?l.Ok(a):l.Err(new h(e.KameleoonException.StorageRead,t))}getVariation({visitorCode:t,visitorIdentifier:i,featureFlag:a,targetingData:n,packageInfo:o,clientConfiguration:r,dataManager:s,legalConsent:u,track:d=!0,withAssignment:c=!1}){M.debug`CALL: VariationConfiguration.getVariation(visitorCode: ${t}, visitorIdentifier: ${i}, featureFlag: ${a}, targetingData: ${n}, packageInfo: ${o}, clientConfiguration, dataManager, withAssignment: ${c})`;const{rules:g,featureKey:p,id:v,defaultVariationKey:m}=a,f=r.isConsentRequired?u:xt.Given;for(const u of g){const{segment:g,experimentId:C,id:y,exposition:D,respoolTime:E,variationByExposition:T}=u,I=this.getForcedExperimentVariation(t,u.experimentId);let k=null;if(I.ok&&(k=I.data,k&&k.forceTargeting)){M.info`Visitor ${t} has been forced targeted for ${u}`;const e=this.createAndSaveForcedTargetedVariation(t,a,u,k,d,c);return M.debug`RETURN: VariationConfiguration.getVariation(visitorCode: ${t}, visitorIdentifier: ${i}, featureFlag: ${a}, targetingData: ${n}, packageInfo: ${o}, clientConfiguration, dataManager, withAssignment: ${c}) -> (targetedVariation: ${e})`,l.Ok(e)}const S=Ke.checkTargeting({segment:g,visitorCode:t,experimentId:C,targetingData:n,packageInfo:o,clientConfiguration:r,dataManager:s,variationConfiguration:this});if(!S.ok)return M.debug`RETURN: VariationConfiguration.getVariation(visitorCode: ${t}, visitorIdentifier: ${i}, featureFlag: ${a}, targetingData: ${n}, packageInfo: ${o}, clientConfiguration, dataManager, withAssignment: ${c}) -> (targetedVariation: ${S})`,S;if(!S.data)continue;if(M.info`Visitor ${t} has been targeted for ${u}`,k){const e=this.createAndSaveForcedTargetedVariation(t,a,u,k,d,c);return M.debug`RETURN: VariationConfiguration.getVariation(visitorCode: ${t}, visitorIdentifier: ${i}, featureFlag: ${a}, targetingData: ${n}, packageInfo: ${o}, clientConfiguration, dataManager, withAssignment: ${c}) -> (targetedVariation: ${e})`,l.Ok(e)}const V=Bt.getHashDouble({visitorIdentifier:i,respoolTime:E,id:String(y)});if(M.debug`Calculated ruleHash: ${V} for code: ${i}`,V<=D){if(f==xt.NotGiven&&u.type==G.EXPERIMENTATION){if(r.consentBlockingBehaviour==W.PartiallyBlocked)break;return l.Err(new h(e.KameleoonException.FeatureFlagEnvironmentDisabled,`Evaluation of ${u} is blocked because consent is not provided for visitor '${t}'`))}let s=this.evaluateCBScores(u,i,n);if(!s){const e=Bt.getHashDouble({visitorIdentifier:i,respoolTime:E,id:String(C)});M.debug`Calculated variationHash: ${e} for code: ${i}`,s=Ke.getVariationByHash(T,e)}if(s){c&&this.updateStoredVariations(t,{[C]:{variationId:s.variationId,isTargetedRule:u.type===G.TARGETED_DELIVERY,status:d?e.TrackingStatus.Unsent:e.TrackingStatus.Sent}});const r={variationId:s.variationId,variationKey:s.variationKey,rule:u,featureFlagId:v,featureKey:p,experimentId:C,isTargetedRule:u.type===G.TARGETED_DELIVERY};return M.debug`RETURN: VariationConfiguration.getVariation(visitorCode: ${t}, visitorIdentifier: ${i}, featureFlag: ${a}, targetingData: ${n}, packageInfo: ${o}, clientConfiguration, dataManager, withAssignment: ${c}) -> (targetedVariation: ${r})`,l.Ok(r)}}if(u.type===G.TARGETED_DELIVERY){const e={featureKey:p,featureFlagId:v,experimentId:null,variationKey:m,variationId:null,rule:null,isTargetedRule:!0};return M.debug`RETURN: VariationConfiguration.getVariation(visitorCode: ${t}, visitorIdentifier: ${i}, featureFlag: ${a}, targetingData: ${n}, packageInfo: ${o}, clientConfiguration, dataManager, withAssignment: ${c}) -> (targetedVariation: ${e})`,l.Ok(e)}}const C={featureKey:p,featureFlagId:v,experimentId:null,variationKey:m,variationId:null,rule:null,isTargetedRule:!1};return M.debug`RETURN: VariationConfiguration.getVariation(visitorCode: ${t}, visitorIdentifier: ${i}, featureFlag: ${a}, targetingData: ${n}, packageInfo: ${o}, clientConfiguration, dataManager, withAssignment: ${c}) -> (targetedVariation: ${C})`,l.Ok(C)}createAndSaveForcedTargetedVariation(t,i,a,n,o,r){const s={variationKey:n.varByExp.variationKey,variationId:n.varByExp.variationId,rule:a,featureFlagId:i.id,featureKey:i.featureKey,experimentId:a.experimentId,isTargetedRule:a.type===G.TARGETED_DELIVERY};return r&&this.updateStoredVariations(t,{[a.experimentId]:{variationId:s.variationId,isTargetedRule:a.type===G.TARGETED_DELIVERY,status:o?e.TrackingStatus.Unsent:e.TrackingStatus.Sent}}),s}updateStoredVariations(e,t){M.debug`CALL: VariationConfiguration.updateStoredVariations(visitorCode: ${e}, variationData: ${t})`;const i=this.storage.read();if(!i.ok)return M.debug`RETURN: VariationConfiguration.updateStoredVariations(visitorCode: ${e}, variationData: ${t}) -> (result: ${i})`,i;let a=i.data;a[e]||(a[e]={});for(const i in t)a[e][i]=t[i];const n=this.storage.write(a);return M.debug`RETURN: VariationConfiguration.updateStoredVariations(visitorCode: ${e}, variationData: ${t}) -> (resultWrite: ${n})`,n}getVariationData(e,t){const i=this.getStoredVariations(e);if(!i.ok)return[];const a=[];for(const[e,n]of Object.entries(i.data))t(n.status)&&a.push({experimentId:Number(e),variationId:n.variationId,isTargetedRule:n.isTargetedRule});return a}updateForcedExperimentVariation(e,t,i){M.debug`CALL: VariationConfiguration.updateForcedExperimentVariation(visitorCode: ${e}, experimentId: ${t}, forcedExperimentVariation: ${i})`;const a=this.storageForcedExperimentVariations.read();if(!a.ok)return M.debug`RETURN: VariationConfiguration.updateForcedExperimentVariation(visitorCode: ${e}, experimentId: ${t}, forcedExperimentVariation: ${i}) -> (result: ${a})`,a;let n=a.data;n[e]||(n[e]={}),i?n[e][t]=i:delete n[e][t];const o=this.storageForcedExperimentVariations.write(n);return M.debug`RETURN: VariationConfiguration.updateForcedExperimentVariation(visitorCode: ${e}, experimentId: ${t}, forcedExperimentVariation: ${i}) -> (resultWrite: ${o})`,o}updateForcedFeatureVariations(e,t){M.debug`CALL: VariationConfiguration.updateForcedFeatureVariations(visitorCode: ${e}, forcedFeatureVariations: ${t})`;const i=this.storageForcedFeatureVariations.read();if(!i.ok)return M.debug`RETURN: VariationConfiguration.updateForcedFeatureVariations(visitorCode: ${e}, forcedFeatureVariations: ${t}) -> (result: ${i})`,i;let a=i.data;a[0]||(a[0]={}),a[1]||(a[1]={});const n=a[0],o=a[1];n[e]||(n[e]={}),o[e]||(o[e]={}),t.forEach(t=>{(t.simulated?o[e]:n[e])[t.featureKey]=t});const r=this.storageForcedFeatureVariations.write(a);return M.debug`RETURN: VariationConfiguration.updateForcedFeatureVariations(visitorCode: ${e}, forcedFeatureVariations: ${t}) -> (resultWrite: ${r})`,r}clearSimulatedVariations(e){var t;M.debug`CALL: VariationConfiguration.clearSimulatedVariations(visitorCode: ${e})`;const i=this.storageForcedFeatureVariations.read();if(!i.ok)return M.debug`RETURN: VariationConfiguration.clearSimulatedVariations(visitorCode: ${e}) -> (result: ${i})`,i;let a;const n=i.data;return(null===(t=null==n?void 0:n[1])||void 0===t?void 0:t[e])?(delete n[1][e],a=this.storageForcedFeatureVariations.write(n)):a=l.Ok(),M.debug`RETURN: VariationConfiguration.clearSimulatedVariations(visitorCode: ${e}) -> (resultWrite: ${a})`,a}getForcedFeatureVariation(e,t){var i,a,n,o;M.debug`CALL: VariationConfiguration.getForcedFeatureVariation(visitorCode: ${e}, featureKey: ${t})`;const r=this.storageForcedFeatureVariations.read();if(!r.ok)return M.debug`RETURN: VariationConfiguration.getForcedFeatureVariation(visitorCode: ${e}, featureKey: ${t}) -> (simulatedResult: ${r})`,r;const s=null===(a=null===(i=r.data[1])||void 0===i?void 0:i[e])||void 0===a?void 0:a[t];if(s)return M.debug`RETURN: VariationConfiguration.getForcedFeatureVariation(visitorCode: ${e}, featureKey: ${t}) -> (simulatedData: ${s})`,l.Ok(s);const u=null===(o=null===(n=r.data[0])||void 0===n?void 0:n[e])||void 0===o?void 0:o[t];return M.debug`RETURN: VariationConfiguration.getForcedFeatureVariation(visitorCode: ${e}, featureKey: ${t}) -> (forcedData: ${u})`,l.Ok(u)}getForcedExperimentVariation(e,t){var i;M.debug`CALL: VariationConfiguration.getForcedExperimentVariation(visitorCode: ${e}, experimentId: ${t})`;const a=this.storageForcedExperimentVariations.read();if(!a.ok)return M.debug`RETURN: VariationConfiguration.getForcedExperimentVariation(visitorCode: ${e}, experimentId: ${t}) -> (forcedResult: ${a})`,a;const n=null===(i=a.data[e])||void 0===i?void 0:i[t];return M.debug`RETURN: VariationConfiguration.getForcedExperimentVariation(visitorCode: ${e}, experimentId: ${t}) -> (forcedExperiment: ${n})`,l.Ok(n)}parseForcedVariationData(e,t=!1){const i=this.clientConfiguration.featureFlags.get(e.featureKey);if(!i)return M.error`Simulated feature flag '${e.featureKey}' not found`,null;let a=null;if(0===e.experimentId)return a={featureKey:e.featureKey,rule:null,varByExp:null,simulated:t},a;for(const n of i.rules){if(e.experimentId!==n.experimentId)continue;const i=n.variationByExposition.find(t=>t.variationId===e.variationId);if(i)return a={featureKey:e.featureKey,rule:{type:n.type,experimentId:n.experimentId},varByExp:{variationKey:i.variationKey,variationId:i.variationId},simulated:t},a}return M.error`Simulated variation ${e.variationId} not found`,null}simulatedVariationFromJson(e,t){if(M.debug`CALL: VariationConfiguration.simulatedVariationFromJson(featureKey: ${e}, data: ${t})`,!this.isSimulatedVariationJson(t))return null;const i=this.parseForcedVariationData({featureKey:e,variationId:t.varId,experimentId:t.expId},!0);return M.debug`RETURN: VariationConfiguration.simulatedVariationFromJson(featureKey: ${e}, data: ${t}) -> (forcedVariation: ${i})`,i}isSimulatedVariationJson(e){return e&&("number"==typeof e.expId||null===e.expId)}evaluateCBScores(e,t,i){if(!i||!i.cbScores)return null;M.debug`CALL: KameleoonClientImpl.evaluateCBScores(rule: ${e}, targetingData: ${i}, visitorIdentifier: ${t})`;const a=e.experimentId,n=new Be(i.cbScores.cbs).getValues().get(a);let o=null;if(void 0!==n){const i=e.variationByExposition,r=n.map(e=>i.filter(t=>e.ids.includes(t.variationId))).find(e=>e.length>0);if(r){let i=0;if(r.length>1){const n=Bt.getHashDouble({visitorIdentifier:t,respoolTime:e.respoolTime,id:String(a)});M.debug`Calculated cbs hash ${n} for code ${t}`,i=Math.min(Math.floor(n*r.length),r.length-1)}o=r[i]}}return M.debug`RETURN: KameleoonClientImpl.evaluateCBScores(rule: ${e}, targetingData: ${i}, visitorIdentifier: ${t}) -> (variation: ${o})`,o}}let zt=class{constructor({siteCode:e,externalEventSource:t,urlProvider:i}){this.url=i.getEventSourceUrl(),this.siteCode=e,this.eventSource=t,this.isConnectionOpen=!1}get isOpen(){return this.isConnectionOpen}open(e){this.eventSource.open({onEvent:this.handleMessage(e),url:this.url,eventType:"configuration-update-event"}),this.isConnectionOpen=!0,M.info`Established a new SSE connection with: ${this.url}`}close(){this.eventSource.close(),this.isConnectionOpen=!1,M.info`SSE connection: '${this.url}' was successfully closed`}onError(e){this.eventSource.onError?this.eventSource.onError(e):M.warning("EventSource does not have `onError` method provided. Real-time errors won't be handled.")}handleMessage(e){return t=>{M.debug`Received new message from: ${this.url}`;const i=JSON.parse(t.data),{siteCode:a,ts:n}=i;this.siteCode===a&&e(n)}}};const jt=31536e3;let qt=class{constructor(){this.isConsentRequired=!1}set consentRequired(e){this.isConsentRequired=e}get consentRequired(){return this.isConsentRequired}set getData(e){this.getDataCallback=e}set setData(e){this.setDataCallback=e}get setData(){if(this.setDataCallback)return this.setDataCallback;throw new Error("Missing setDataCallback!")}validateVisitorCode(t){return 0===t.length?l.Err(new h(e.KameleoonException.VisitorCodeEmpty)):t.length>255?l.Err(new h(e.KameleoonException.VisitorCodeMaxLength)):l.Ok()}getVisitorCode(t){if(M.debug`CALL: VisitorCodeManager.getVisitorCode(defaultVisitorCode: ${t})`,!this.getDataCallback||!this.setDataCallback)throw new Error("Missing getDataCallback or setDataCallback methods in getVisitorCode!");let i;const a=this.getDataCallback(e.KameleoonStorageKey.VisitorCode);return a&&(i=a),i||(t?(this.validateVisitorCode(t).throw(),i=t,M.debug`Used default visitor code: ${i}`):(i=this.generateVisitorCode(),M.debug`Generated new visitor code: ${i}`)),this.processSimulatedVariations(i),this.isConsentRequired||this.setDataCallback({visitorCode:i,key:e.KameleoonStorageKey.VisitorCode,maxAge:jt,path:"/"}),M.debug`RETURN: VisitorCodeManager.getVisitorCode(defaultVisitorCode: ${t}) -> (visitorCode: ${i})`,i}processSimulatedVariations(e){if(this.variationConfiguration){const t=this.getSimulatedVariations(e);try{this.variationConfiguration.clearSimulatedVariations(e).throw(),null!==t&&t.length>0&&this.variationConfiguration.updateForcedFeatureVariations(e,t).throw()}catch(e){e instanceof Error&&M.error`Failed to process simulated variations: ${e.message}`}}}getSimulatedVariations(t){M.debug`CALL: VisitorCodeManager.getSimulatedVariations(visitorCode: ${t})`;const i=this.getDataCallback(e.KameleoonStorageKey.KameleoonSimulationFFData);let a=null;if("string"==typeof i&&i.length>0)try{const e=JSON.parse(decodeURIComponent(i));e&&"object"==typeof e&&(a=Object.entries(e).map(([e,t])=>this.variationConfiguration.simulatedVariationFromJson(e,t)).filter(e=>null!==e))}catch(e){e instanceof Error&&M.error`Failed to parse simulated variations: ${e.message}`}return M.debug`RETURN: VisitorCodeManager.getSimulatedVariations(visitorCode: ${t}) -> (variations: ${a})`,a}generateVisitorCode(){const e=[];for(let t=0;t<16;t++)e.push("abcdefghijklmnopqrstuvwxyz0123456789"[Math.floor(36*Math.random())]);return e.join("")}setVariationConfiguration(e){this.variationConfiguration||(this.variationConfiguration=e)}};var Ht;!function(e){e[e.Kb=1e3]="Kb",e[e.Mb=1e6]="Mb",e[e.Gb=1e9]="Gb"}(Ht||(Ht={}));const Wt=10*Ht.Mb;class Yt{constructor(e){this.currentSize=0,this.resultBody=[],this.hasUserAgent=!1,this.trackingVisitors={},this.prng=e}getTrackingBody(){const e={body:this.resultBody.join("\n"),hasUserAgent:this.hasUserAgent};return this.cleanup(),e}addData({visitorCode:e,variationData:t,visitorData:i,userAgent:a,isConsentProvided:n,isMappingIdentifier:o}){const r=[],s=this.getVariationDataLines(t),u=this.getVisitorDataLines(i);return r.push(...s,...u),this.addVisitorTrackingLines({visitorCode:e,lines:r,userAgent:a,isConsentProvided:n,isMappingIdentifier:o})}getVisitorDataLines(t){const i=[];for(const a of t){let t;if(!(a instanceof Ye||a.data.type!==e.KameleoonData.Conversion&&a.data.type!==e.KameleoonData.PageView)){const e=a.data.nonce;e?t=e:(t=Ke.getNonce(this.prng),a.data.nonce=t)}t||(t=Ke.getNonce(this.prng)),i.push(a.url+k+t)}return i}getVariationDataLines(e){const t=[];return e.forEach(e=>{t.push("eventType=experiment"+S+e.experimentId+"&variationId="+e.variationId+k+Ke.getNonce(this.prng))}),t}prepareVisitorBody(e){const t=this.trackingVisitors[e];if(!t)return l.Err();const{lines:i,userAgent:a,isMappingIdentifier:n,isConsentProvided:o}=t,r=this.getIdentifier(e,n);if(i.length)i.forEach((e,t)=>{i[t]=e+r}),M.debug`Sending tracking request for unsent data ${i} of visitor ${e} with given (or not required) consent ${o}`;else if(o){const t=this.getActivityLine();i.push(t+r),M.debug`Sending tracking request for activity of visitor ${e} with given consent`}else M.debug`No data to send for visitor ${e} with no consent`;a&&i.length&&(i[0]+="&userAgent="+a,this.hasUserAgent=!0);const s=this.checkSize(i);return s.ok&&this.resultBody.push(...i),s}cleanup(){this.currentSize=0,this.resultBody=[],this.hasUserAgent=!1,this.trackingVisitors={}}checkSize(e){let t=0;return t+=e.reduce((e,t)=>e+4*t.length,0),t+this.currentSize>Wt?l.Err():(this.currentSize+=t,l.Ok())}addVisitorTrackingLines({visitorCode:e,lines:t,userAgent:i,isConsentProvided:a,isMappingIdentifier:n}){return this.trackingVisitors[e]?(i&&(this.trackingVisitors[e].userAgent=i),this.trackingVisitors[e].lines.push(...t)):this.trackingVisitors[e]={isMappingIdentifier:n,isConsentProvided:a,userAgent:i,lines:t},this.prepareVisitorBody(e)}getActivityLine(){return"eventType=activity"+k+Ke.getNonce(this.prng)}getIdentifier(e,t){return(t?K:I)+encodeURIComponent(e)}}class Jt{constructor({dataManager:e,trackingStorage:t,variationConfiguration:i,trackingInterval:a,requester:n,prng:o,clientConfiguration:r}){this.intervalId=null,M.debug`CALL: new Tracker(dataManager, trackingStorage, variationConfiguration, trackingInterval: ${a}, requester, prng, clientConfiguration)`,this.dataManager=e,this.trackingStorage=t,this.variationConfiguration=i,this.requester=n,this.bodyProvider=new Yt(o),this.clientConfiguration=r;try{this.intervalId=setInterval(()=>{this.sendDataAll()},a)}catch(e){throw this.intervalId&&clearInterval(this.intervalId),e}M.debug`RETURN: new Tracker(dataManager, trackingStorage, variationConfiguration, trackingInterval: ${a}, requester, prng, clientConfiguration)`}scheduleVisitor(e,t){M.debug`CALL: Tracker.scheduleVisitor(visitorCode: ${e}, isConsentProvided: ${t})`,this.trackingStorage.read().and(i=>{i.scheduledVisitors[`_${e}`]={isConsentProvided:t},this.trackingStorage.write(i)}),M.debug`RETURN: Tracker.scheduleVisitor(visitorCode: ${e}, isConsentProvided: ${t})`}checkIsIdentifier(e){var t,i;const a=this.dataManager.isUniqueIdentifier(e),n=null!==(i=null===(t=this.dataManager.getMappingIdentifier(e))||void 0===t?void 0:t.mappingIdentifier)&&void 0!==i?i:e;let o=!1;if(a){const t=this.dataManager.getLinkedVisitor(e),i=this.dataManager.identifierCustomDataIndex;t||"number"!=typeof i?o=!0:this.dataManager.storeData(e,new Oe(i,e))}return o&&e!=n}getUserAgent(t){const i=this.dataManager.getVisitorData(t);if(i){const t=i[e.KameleoonData.UserAgent];if(t)return t.value}}sendDataAll(){return d(this,0,void 0,function*(){const e=this.trackingStorage.read();if(!e.ok)return;const{scheduledVisitors:t}=e.data;yield this.sendData(t)})}sendDataForVisitor(e,t){return d(this,0,void 0,function*(){this.trackingStorage.read().ok&&(yield this.sendData({[`_${e}`]:{isConsentProvided:t}}))})}sendData(t){return d(this,0,void 0,function*(){const i={},a=[],n=[];for(const[e,{isConsentProvided:o}]of Object.entries(t)){let t=e.startsWith("_")?e.substring(1):e;const r=this.checkIsIdentifier(t),s=this.getUserAgent(t),u=this.getUnsentVisitorData(t,o),l=this.getUnsentVariationData(t,o);if(!this.bodyProvider.addData({visitorCode:t,variationData:l,visitorData:u,userAgent:s,isConsentProvided:o,isMappingIdentifier:r}).ok){M.warning("Visitor data to be tracked exceeded the request size limit. Some visitor data is kept to be sent later. If it is not caused by the peak load, decreasing the tracking interval is recommended.");break}i[t]={visitorData:u,variationData:l},n.push({visitorCode:t,isConsentProvided:o}),a.push(e)}const{body:o,hasUserAgent:r}=this.bodyProvider.getTrackingBody();if(0!==a.length&&this.trackingStorage.read().and(e=>{a.forEach(t=>{delete e.scheduledVisitors[t]}),this.trackingStorage.write(e)}),o)if((yield this.requester.track(o,r)).ok)M.info`Successful request for tracking visitors: ${n}, data: ${i}`,this.updateDataStatus(i,e.TrackingStatus.Sent);else{M.error("Tracking request failed"),M.info`Failed request for tracking visitors: ${n}, data: ${i}`,this.updateDataStatus(i,e.TrackingStatus.Unsent);let t={};for(let{visitorCode:e,isConsentProvided:i}of n)e=`_${e}`,t[e]={isConsentProvided:i};this.addNotTrackedVisitors(t)}})}addNotTrackedVisitors(e){const t=this.trackingStorage.read();if(!t.ok)return;const{scheduledVisitors:i}=t.data;Object.entries(e).forEach(([e,{isConsentProvided:t}])=>{i[e]||(i[e]={isConsentProvided:t})}),this.trackingStorage.write({scheduledVisitors:i})}updateDataStatus(t,i){let a={};for(const[e,{visitorData:n,variationData:o}]of Object.entries(t)){const t=n.filter(e=>!(e instanceof Ye)).map(e=>{const t=e;return t.status=i,t});t.length&&(a[e]=t);const r=o.map(e=>String(e.experimentId));this.variationConfiguration.updateDataStatus({visitorCode:e,experimentIdList:r,status:i})}0!==Object.keys(a).length&&(i===e.TrackingStatus.Sent?this.dataManager.storeTrackedData(a):this.dataManager.storeData(a,!1))}getUnsentVisitorData(t,i){const a=this.dataManager.getUnsentData(t),n=[];if(!a.length)return[];for(const t of a)t.url&&(i||this.clientConfiguration.hasAnyTargetedDeliveryRule&&!(t instanceof Ye)&&t.data.type===e.KameleoonData.Conversion)&&n.push(t);if(n.length){const i=n.filter(e=>!(e instanceof Ye)).map(t=>{const i=t;return i.status=e.TrackingStatus.Pending,i});this.dataManager.storeTrackedData({[t]:i})}return n}getUnsentVariationData(t,i){const a=this.variationConfiguration.getUnsentData(t),n=new Set;if(!a.length)return[];const o=a.filter(e=>{const t=e.isTargetedRule||i;return t&&n.add(String(e.experimentId)),t});return this.variationConfiguration.updateDataStatus({visitorCode:t,experimentIdList:Array.from(n),status:e.TrackingStatus.Pending}),o}}let Xt=class t{constructor({siteCode:t,dependencies:i,configuration:a,internalConfiguration:n,stubMode:o}){var r;if(this.initialized=!1,this.stubMode=o,o)return this.variationConfiguration={},this.clientConfiguration={},this.dataManager={},this.consentDataStorage={},this.trackingCache={},this.requester={},this.externalPackageInfo={},this.visitorCodeManager={},this.eventManager={},this.tracker={},void(this.environment="");const s=null==n?void 0:n.externals.externalLogger;s&&M.setLogger(s),Je.setConditionFactoryInstance(new St),M.debug`CALL: new KameleoonClient(siteCode: ${t}, dependencies: ${i}, configuration: ${a})`;const{settings:u}=new je(t,a);this.environment=u.environment;const{externalStorage:l,externalEventSource:d,externalPackageInfo:c,externalVisitorCodeManager:g,externalRequester:h,externalPRNG:p,customDataManager:v}=n.externals,{useAbortController:m}=n.settings,f=new X(10),C=new Kt(l,e.KameleoonStorageKey.ClientData),y=new Kt(l,e.KameleoonStorageKey.VariationData),D=new Kt(l,e.KameleoonStorageKey.ForcedExperimentVariation),E=new Kt(l,e.KameleoonStorageKey.ForcedFeatureVariation),T=new Kt(l,e.KameleoonStorageKey.ConsentData),I=new Kt(l,e.KameleoonStorageKey.TrackingData);let k=v;if(!k){const t=new Kt(l,e.KameleoonStorageKey.TargetingData),i=new Kt(l,e.KameleoonStorageKey.DataInfo);k=new $t({dataStorage:t,infoStorage:i,cleanupInterval:u.cleanupInterval,packageInfo:c})}const S=null!==(r=null==i?void 0:i.urlProvider)&&void 0!==r?r:new J;S.initialize({domain:u.networkDomain,siteCode:u.siteCode,packageInfo:c,environment:u.environment});const V=new F({urlProvider:S,useAbortController:m,packageInfo:c,externalRequester:h,requestTimeout:u.requestTimeout,trackRetryDelay:u.trackRetryDelay}),w=new zt({siteCode:u.siteCode,externalEventSource:d,urlProvider:S}),R=new Q,b=new te({urlProvider:S,storage:C,updateInterval:u.updateInterval,dataManager:k,eventManager:R,requester:V,eventSource:w,externalVisitorCodeManager:g,externalPackageInfo:c,defaultDataFile:null==a?void 0:a.defaultDataFile}),K=new Gt(y,D,E,g,b),A=new Jt({dataManager:k,trackingStorage:I,variationConfiguration:K,requester:V,trackingInterval:u.trackingInterval,prng:p,clientConfiguration:b});this.tracker=A,this.variationConfiguration=K,this.requester=V,this.trackingCache=f,this.dataManager=k,this.clientConfiguration=b,this.externalPackageInfo=c,this.consentDataStorage=T,this.visitorCodeManager=g,this.eventManager=R,null!==u.cleanupInterval&&new At(l,u.cleanupInterval),M.debug`RETURN: new KameleoonClient(siteCode: ${t}, dependencies: ${i}, configuration: ${a})`}initialize(){return d(this,0,void 0,function*(){if(this.stubMode)return!1;M.info("CALL: KameleoonClient.initialize()");const e=yield this.clientConfiguration.initialize();return e.throw(),this.initialized=!0,M.info`RETURN: KameleoonClient.initialize() -> (result: ${e.ok})`,e.ok})}addData(t,...i){if(this.stubMode)throw new h(e.KameleoonException.Initialization);if(M.info`CALL: KameleoonClient.addData(visitorCode: ${t}, data: ${i})`,this.visitorCodeManager.validateVisitorCode(t).throw(),!this.initialized)throw new h(e.KameleoonException.Initialization);this.dataManager.storeData(t,...i).throw(),M.info`RETURN: KameleoonClient.addData(visitorCode: ${t}, data: ${i})`}getRemoteVisitorData({visitorCode:t,shouldAddData:i=!0,filters:a=pe}){return d(this,0,void 0,function*(){if(this.stubMode)throw new h(e.KameleoonException.Initialization);if(M.info`CALL: KameleoonClient.getRemoteVisitorData(visitorCode: ${t}, shouldAddData: ${i}, filters: ${a})`,!this.initialized)throw new h(e.KameleoonException.Initialization);this.visitorCodeManager.validateVisitorCode(t).throw();const{previousVisitAmount:n}=a;if("number"==typeof n&&(n<1||n>25))throw new h(e.KameleoonException.VisitAmount);const o=this.dataManager.isUniqueIdentifier(t),r=(yield this.requester.getVisitorData({visitorCode:t,filters:a,isMappingIdentifier:o})).throw(),{visitorData:s,storageVisitorData:u,visitsData:l,mappingIdentifier:d}=ze.parseVisitorData({data:r,filters:a,visitorCode:t,dataManager:this.dataManager,variationConfiguration:this.variationConfiguration});for(const e of u)(i||this.dataManager.isPersistentCustomData(e))&&this.addData(t,e);return l&&i&&this.addData(t,l),(null==a?void 0:a.visitorCode)&&d&&this.dataManager.setMappingIdentifier(t,d),M.info`RETURN: KameleoonClient.getRemoteVisitorData(visitorCode: ${t}, shouldAddData: ${i}, filters: ${a}) -> (visitorData: ${s})`,s})}trackConversion({visitorCode:e,goalId:t,negative:i,revenue:a,metadata:n}){this.stubMode||(M.info`CALL: KameleoonClient.trackConversion(visitorCode: ${e}, goalId: ${t}, negative: ${i}, revenue: ${a}, metadata: ${n})`,this.addData(e,new $e({goalId:t,revenue:a,negative:i,metadata:n})),this.flush(e),M.info`RETURN: KameleoonClient.trackConversion(visitorCode: ${e}, goalId: ${t}, negative: ${i}, revenue: ${a}, metadata: ${n})`)}flush(t){var i;if(this.stubMode)throw new h(e.KameleoonException.Initialization);let a,n=!1;if("string"==typeof t?a=t:t&&(a=t.visitorCode,n=null!==(i=t.instant)&&void 0!==i&&i),M.info`CALL: KameleoonClient.flush(visitorCode: ${a}, instant: ${n})`,!this.initialized)throw new h(e.KameleoonException.Initialization);if("string"==typeof a)this.visitorCodeManager.validateVisitorCode(a).throw(),n?this.tracker.sendDataForVisitor(a,this._isConsentProvided(a)):this.tracker.scheduleVisitor(a,this._isConsentProvided(a));else{for(const e of this.dataManager.unsentDataVisitors)this.tracker.scheduleVisitor(e,this._isConsentProvided(e));for(const e of this.variationConfiguration.getVisitorsWithUnsentData())this.tracker.scheduleVisitor(e,this._isConsentProvided(e));n&&this.tracker.sendDataAll()}M.info`RETURN: KameleoonClient.flush(visitorCode: ${a}, instant: ${n})`}getFeatureFlags(){if(this.stubMode)throw new h(e.KameleoonException.Initialization);if(M.info("CALL: KameleoonClient.getFeatureFlags()"),!this.initialized)throw new h(e.KameleoonException.Initialization);const t=this.clientConfiguration.featureFlags,i=[];return t.forEach(({id:e,featureKey:t})=>{i.push({id:e,key:t})}),M.info`RETURN: KameleoonClient.getFeatureFlags() -> (FeatureFlags: ${i})`,i}getVisitorFeatureFlags(t){if(this.stubMode)throw new h(e.KameleoonException.Initialization);if(M.info`CALL: KameleoonClient.getVisitorFeatureFlags(visitorCode: ${t})`,!this.initialized)throw new h(e.KameleoonException.Initialization);this.visitorCodeManager.validateVisitorCode(t).throw();const i=this._getActiveFeatureVariations(t),a=[];return i.forEach(({featureFlagId:e,featureKey:t})=>{a.push({id:e,key:t})}),M.info`RETURN: KameleoonClient.getVisitorFeatureFlags(visitorCode: ${t}) -> (FeatureFlags: ${a})`,a}getVariation({visitorCode:t,featureKey:i,track:a=!0}){if(this.stubMode)throw new h(e.KameleoonException.Initialization);M.info`CALL: KameleoonClient.getVariation(visitorCode: ${t}, featureKey: ${i}, track: ${a})`,this.visitorCodeManager.validateVisitorCode(t).throw();const n=this._getFeatureVariation({visitorCode:t,featureKey:i,track:a}).throw();return M.info`RETURN: KameleoonClient.getVariation(visitorCode: ${t}, featureKey: ${i}, track: ${a}) -> (variation: ${n})`,n}getVariations({visitorCode:t,onlyActive:i=!1,track:a=!0}){if(this.stubMode)throw new h(e.KameleoonException.Initialization);M.info`CALL: KameleoonClient.getVariations(visitorCode: ${t}, onlyActive: ${i}, track: ${a})`,this.visitorCodeManager.validateVisitorCode(t).throw();const n=new Map,o=this.clientConfiguration.featureFlags;for(const r of o.values())try{const e=this._getFeatureVariation({visitorCode:t,featureKey:r.featureKey,track:a});!e.ok||i&&e.data.key===ce||n.set(r.featureKey,e.data)}catch(t){if(t instanceof h&&t.type!==e.KameleoonException.FeatureFlagEnvironmentDisabled)throw t}return M.info`RETURN: KameleoonClient.getVariations(visitorCode: ${t}, onlyActive: ${i}, track: ${a}) -> (variations: ${n})`,n}getActiveFeatureFlags(t){if(this.stubMode)throw new h(e.KameleoonException.Initialization);if(M.info`CALL: KameleoonClient.getActiveFeatureFlags(visitorCode: ${t})`,!this.initialized)throw new h(e.KameleoonException.Initialization);this.visitorCodeManager.validateVisitorCode(t).throw();const i=this._getActiveFeatureVariations(t),a=new Map;return i.forEach(e=>{const{variationKey:i,featureKey:n,variationId:o,experimentId:r}=e;let s=[];null!==o&&null!==r&&(s=this._getFeatureVariables({visitorCode:t,featureKey:n,variationKey:i}));const u=s.map(e=>ze.parseFeatureVariable(e).throw());a.set(e.featureKey,{name:"",key:i,id:o,experimentId:r,variables:u})}),M.info`RETURN: KameleoonClient.getActiveFeatureFlags(visitorCode: ${t}) -> (FeatureFlags: ${a})`,a}getFeatureFlagVariationKey(t,i){if(this.stubMode)throw new h(e.KameleoonException.Initialization);M.info`CALL: KameleoonClient.getFeatureFlagVariationKey(visitorCode: ${t}, featureKey: ${i})`,this.visitorCodeManager.validateVisitorCode(t).throw();const{key:a}=this._getFeatureVariation({visitorCode:t,featureKey:i,track:!0}).throw();return M.info`RETURN: KameleoonClient.getFeatureFlagVariationKey(visitorCode: ${t}, featureKey: ${i}) -> (variationKey: ${a})`,a}getFeatureFlagVariable({visitorCode:t,featureKey:i,variableKey:a}){if(this.stubMode)throw new h(e.KameleoonException.Initialization);M.info`CALL: KameleoonClient.getFeatureFlagVariable(visitorCode: ${t}, featureKey: ${i}, variableKey: ${a})`,this.visitorCodeManager.validateVisitorCode(t).throw();const{key:n}=this._getFeatureVariation({visitorCode:t,featureKey:i,track:!0}).throw(),o=this._getFeatureVariables({visitorCode:t,featureKey:i,variationKey:n}).find(e=>e.key===a);if(!o)throw new h(e.KameleoonException.FeatureFlagVariableNotFound,a,t);const{type:r,value:s}=ze.parseFeatureVariable(o).throw(),u={type:r,value:s};return M.info`RETURN: KameleoonClient.getFeatureFlagVariable(visitorCode: ${t}, featureKey: ${i}, variableKey: ${a}) -> (FeatureFlagVariable: ${u})`,u}getFeatureFlagVariables(t,i){if(this.stubMode)throw new h(e.KameleoonException.Initialization);M.info`CALL: KameleoonClient.getFeatureFlagVariables(visitorCode: ${t}, featureKey: ${i})`,this.visitorCodeManager.validateVisitorCode(t).throw();const{key:a}=this._getFeatureVariation({visitorCode:t,featureKey:i,track:!0}).throw(),n=this._getFeatureVariables({visitorCode:t,featureKey:i,variationKey:a}),o=[];for(const e of n){const t=ze.parseFeatureVariable(e).throw();o.push(t)}return M.info`RETURN: KameleoonClient.getFeatureFlagVariables(visitorCode: ${t}, featureKey: ${i}) -> (FeatureFlagVariables: ${o})`,o}isFeatureFlagActive(t,i){if(this.stubMode)throw new h(e.KameleoonException.Initialization);let[a,n,o]=["","",!0];"string"==typeof t?(a=t,n=i):([a,n]=[t.visitorCode,t.featureKey],void 0!==t.track&&(o=t.track)),M.info`CALL: KameleoonClient.isFeatureFlagActive(visitorCode: ${a}, featureKey: ${n}, track ${o})`,this.visitorCodeManager.validateVisitorCode(a).throw();try{const{key:e}=this._getFeatureVariation({visitorCode:a,featureKey:n,track:o}).throw(),t=e!==ce;return M.info`RETURN: KameleoonClient.isFeatureFlagActive(visitorCode: ${a}, featureKey: ${n}, track: ${o}) -> (isActive: ${t})`,t}catch(t){if(t instanceof h&&t.type===e.KameleoonException.FeatureFlagEnvironmentDisabled)return M.info`RETURN: KameleoonClient.isFeatureFlagActive(visitorCode: ${a}, featureKey: ${n}, track: ${o}) -> (isActive: false)`,!1;throw t}}getRemoteData(e){return d(this,0,void 0,function*(){if(this.stubMode)return null;M.info`CALL: KameleoonClient.getRemoteData(key: ${e})`;const t=yield this.requester.getRemoteData(e);return M.info`RETURN: KameleoonClient.getRemoteData(key: ${e}) -> (remoteData: ${t})`,t.throw()})}getVisitorWarehouseAudience({visitorCode:t,customDataIndex:i,warehouseKey:a}){return d(this,0,void 0,function*(){if(this.stubMode)return null;M.info`CALL: KameleoonClient.getVisitorWarehouseAudience(visitorCode: ${t}, customDataIndex: ${i}, warehouseKey: ${a})`,this.visitorCodeManager.validateVisitorCode(t).throw();const n=yield this.getRemoteData(a||t);if(!n)throw new h(e.KameleoonException.RemoteData,`No data found for ${a||t} key`);if(!n[ge]||0===Object.keys(n[ge]).length)return M.info`RETURN: KameleoonClient.getVisitorWarehouseAudience(visitorCode: ${t}, customDataIndex: ${i}, warehouseKey: ${a}) -> (customData: null)`,null;const o=new Oe(i,...Object.keys(n[ge]));return this.dataManager.storeData(t,o),M.info`RETURN: KameleoonClient.getVisitorWarehouseAudience(visitorCode: ${t}, customDataIndex: ${i}, warehouseKey: ${a}) -> (customData: ${o})`,o})}onEvent(t,i){if(this.stubMode)throw new h(e.KameleoonException.Initialization);if(M.info`CALL: KameleoonClient.onEvent(event: ${t}, callback)`,!this.initialized)throw new h(e.KameleoonException.Initialization);this.eventManager.addEventHandler(t,i),M.info`RETURN: KameleoonClient.onEvent(event: ${t}, callback)`}getEngineTrackingCode(e){if(this.stubMode)return"";M.info`CALL: KameleoonClient.getEngineTrackingCode(visitorCode: ${e})`,this.visitorCodeManager.validateVisitorCode(e).throw();const t=Ke.getTrackingCode(this.trackingCache,e);return M.info`RETURN: KameleoonClient.getEngineTrackingCode(visitorCode: ${e}) -> (trackingCode: ${t})`,t}isInitialized(){return M.debug`CALL/RETURN: KameleoonClient.isInitialized() -> (initialized: ${this.initialized})`,this.initialized}setLogLevel(e){M.setLogLevel(e)}setForcedVariation({visitorCode:e,experimentId:t,variationKey:i,forceTargeting:a=!0}){this.stubMode||(M.info`CALL: KameleoonClient.setForcedVariation(visitorCode: '${e}', experimentId: ${t}, variationKey: '${i}', forceTargeting: ${a})`,this.visitorCodeManager.validateVisitorCode(e).throw(),this._setForcedVariation({visitorCode:e,experimentId:t,variationKey:i,forceTargeting:a}).throw(),M.info`RETURN: KameleoonClient.setForcedVariation(visitorCode: '${e}', experimentId: ${t}, variationKey: '${i}', forceTargeting: ${a})`)}evaluateAudiences(e){if(this.stubMode)return;M.info`CALL: KameleoonClient.evaluateAudiences(visitorCode: ${e})`,this.visitorCodeManager.validateVisitorCode(e).throw();const t=[],i=this.dataManager.getVisitorData(e);for(let a of this.clientConfiguration.segments.values()){if(!a.audienceTracking)continue;const n=Ke.checkTargeting({segment:a,visitorCode:e,targetingData:i,experimentId:null,clientConfiguration:this.clientConfiguration,packageInfo:this.externalPackageInfo,dataManager:this.dataManager,variationConfiguration:this.variationConfiguration});n.ok&&n.data&&(M.info`Visitor ${e} has been targeted for ${a}`,t.push(new Ot(Number(a.id))))}0!==t.length&&this.dataManager.storeData(e,...t),this.flush(e),M.info`RETURN: KameleoonClient.evaluateAudiences(visitorCode: ${e})`}getDataFile(){const e={featureFlags:new Map};return this.stubMode||(M.debug`CALL: KameleoonClient.getDataFile()`,this.clientConfiguration.featureFlags.forEach((t,i)=>{const a=new Map;t.variations.forEach(e=>{var i;const n=new Map;e.variables.forEach(e=>{try{const t=ze.parseFeatureVariable(e).throw();n.set(e.key,t)}catch(i){M.error`Error parsing variable ${e.key} of feature flag ${t.featureKey}: ${i}`}}),a.set(e.key,{name:null!==(i=e.name)&&void 0!==i?i:"",key:e.key,id:null,experimentId:null,variables:n})});const n=t.rules.map(e=>{const t=new Map;return e.variationByExposition.forEach(i=>{const n=a.get(i.variationKey);n&&t.set(n.key,{name:n.name,key:n.key,id:i.variationId,experimentId:e.experimentId,variables:n.variables})}),{variations:t}});e.featureFlags.set(i,{variations:a,environmentEnabled:t.environmentEnabled,rules:n,defaultVariationKey:t.defaultVariationKey})}),M.debug`RETURN: KameleoonClient.getDataFile() -> (dataFile: ${e})`),e}setUserConsent({visitorCode:t,consent:i,setData:a}){this.stubMode||(M.info`CALL: KameleoonClient.setUserConsent(visitorCode: ${t}, consent: ${i}, setData: ${a})`,this.visitorCodeManager.validateVisitorCode(t).throw(),this.updateConsentData(t,i),i&&a({visitorCode:t,key:e.KameleoonStorageKey.VisitorCode,maxAge:jt,path:"/"}),M.info`RETURN: KameleoonClient.setUserConsent(visitorCode: ${t}, consent: ${i}, setData: ${a})`)}updateConsentData(t,i){const a=this.consentDataStorage.read(),n=i?xt.Given:xt.NotGiven;if(!a.ok)return void(a.error.type===e.KameleoonException.StorageEmpty&&this.consentDataStorage.write({[t]:{consent:n}}));const o=a.data;o[t]={consent:n},this.consentDataStorage.write(o)}getLegalConsent(e){let t;M.debug`CALL: KameleoonClient.getLegalConsent(visitorCode: ${e})`;const i=this.consentDataStorage.read();return t=i.ok?this.extractLegalConsent(i.data[e]):xt.Unknown,M.debug`RETURN: KameleoonClient.getLegalConsent(visitorCode: ${e}) -> (legalConsent: ${t})`,t}extractLegalConsent(e){if(void 0===e)return xt.Unknown;if("boolean"==typeof e)return e?xt.Given:xt.NotGiven;const t=e.consent;return"boolean"==typeof t?t?xt.Given:xt.NotGiven:t}_isConsentProvided(e){M.debug`CALL: KameleoonClient._isConsentProvided(visitorCode: ${e})`;const{isConsentRequired:t}=this.clientConfiguration,i=!t||this.getLegalConsent(e)==xt.Given;return M.debug`RETURN: KameleoonClient._isConsentProvided(visitorCode: ${e}) -> (isConsentProvided: ${i})`,i}_getFeatureVariables({visitorCode:t,featureKey:i,variationKey:a}){M.debug`CALL: KameleoonClient._getFeatureVariables(visitorCode: ${t}, featureKey: ${i}, variationKey: ${a})`;const n=this.clientConfiguration.featureFlags.get(i);if(!n)throw new h(e.KameleoonException.FeatureFlagConfigurationNotFound,i);const o=n.variations.find(e=>e.key===a);if(!o)throw new h(e.KameleoonException.FeatureFlagVariationNotFound,a,t);return M.debug`RETURN: KameleoonClient._getFeatureVariables(visitorCode: ${t}, featureKey: ${i}, variationKey: ${a}) -> (variables: ${o.variables})`,o.variables}_getActiveFeatureVariations(t){M.debug`CALL: KameleoonClient._getActiveFeatureVariations(visitorCode: ${t})`;const i=this.clientConfiguration.featureFlags,a=[];for(const n of i.values())if(n.environmentEnabled)try{const e=this._evaluate({visitorCode:t,featureFlag:n,track:!1,save:!1});e.variationKey!==ce&&a.push({variationKey:e.variationKey,variationId:e.variationId,experimentId:e.experimentId,featureFlagId:n.id,featureKey:n.featureKey,rule:null,isTargetedRule:e.ruleType===G.TARGETED_DELIVERY})}catch(t){if(t instanceof h){t.type!=e.KameleoonException.FeatureFlagEnvironmentDisabled&&M.error`Unexpected error: ${t}`;continue}}return M.debug`RETURN: KameleoonClient._getActiveFeatureVariations(visitorCode: ${t}) -> (activeVariations: ${a})`,a}_evaluate({visitorCode:i,featureFlag:a,track:n,save:o}){let r;M.debug`CALL: KameleoonClient._evaluate(visitorCode: ${i}, featureFlag: ${a}, track: ${n}, save: ${o})`;let s=null;const u=this.dataManager.getVisitorData(i),l=this.variationConfiguration.getForcedFeatureVariation(i,a.featureKey);if(l.ok&&(s=l.data),s)r=t.EvaluatedExperiment.fromForcedFeatureVariation(a.defaultVariationKey,s);else if(this._isVisitorNotInHoldout(i,n,o,a,u)&&this._isFFUnrestrictedByMEGroup(i,a,u)){const e=this._getCodeForHash(i,a.bucketingCustomDataIndex,u),s=this.getLegalConsent(i),l=this.variationConfiguration.getVariation({visitorCode:i,visitorIdentifier:e,featureFlag:a,track:n,withAssignment:o,targetingData:u,clientConfiguration:this.clientConfiguration,dataManager:this.dataManager,packageInfo:this.externalPackageInfo,legalConsent:s}).throw();r=t.EvaluatedExperiment.fromVariationData(l)}else r=t.EvaluatedExperiment.fromDefaultVariationKey(a.defaultVariationKey);return o&&!r.isSimulated&&null!==r.experimentId&&null!==r.variationId&&this.variationConfiguration.updateStoredVariations(i,{[r.experimentId]:{variationId:r.variationId,isTargetedRule:r.ruleType===G.TARGETED_DELIVERY,status:n?e.TrackingStatus.Unsent:e.TrackingStatus.Sent}}),this.eventManager.fireEvent(e.EventType.Evaluation,{featureKey:a.featureKey,variation:{key:r.variationKey,experimentId:r.experimentId,id:r.variationId}}),M.debug`RETURN: KameleoonClient._evaluate(visitorCode: ${i}, featureFlag: ${a}, track: ${n}, save: ${o}) -> (evalExp: ${r})`,r}_isFFUnrestrictedByMEGroup(e,t,i){const a=t.mutuallyExclusiveGroup;if(!a)return!0;M.debug`CALL: KameleoonClient._isFFUnrestrictedByMEGroup(visitorCode: ${e}, featureFlag: ${t}, visitorData: ${i})`;let n=!0;const o=this.clientConfiguration.meGroups.get(a);if(o){const r=this._getCodeForHash(e,t.bucketingCustomDataIndex,i),s=Bt.getHashDoubleForMEGroup(r,a);M.debug`Calculated meGroup hash ${s} for code: ${r}, meGroup: ${a}`,n=o.getFeatureFlagByHash(s)===t}return M.debug`RETURN: KameleoonClient._isFFUnrestrictedByMEGroup(visitorCode: ${e}, featureFlag: ${t}, visitorData: ${i}) -> (selected: ${n})`,n}_getFeatureVariation({visitorCode:t,featureKey:i,track:a}){var n,o;if(M.debug`CALL: KameleoonClient._getFeatureVariation(visitorCode: ${t}, featureKey: ${i}, track: ${a})`,!this.initialized)return l.Err(new h(e.KameleoonException.Initialization));const r=this.clientConfiguration.featureFlags.get(i);if(!r)return l.Err(new h(e.KameleoonException.FeatureFlagConfigurationNotFound,i));if(!r.environmentEnabled)return l.Err(new h(e.KameleoonException.FeatureFlagEnvironmentDisabled,r.featureKey,this.environment));const s=this._evaluate({visitorCode:t,featureFlag:r,track:a,save:!0}),{experimentId:u,variationId:d,variationKey:c,isSimulated:g}=s;let p=new Map,v=!1;try{this._getFeatureVariables({visitorCode:t,featureKey:i,variationKey:c}).forEach(t=>{v||t.type!==e.VariableType.JS&&t.type!==e.VariableType.CSS||(v=!0);const i=ze.parseFeatureVariable(t).throw();p.set(t.key,i)})}catch(e){}u&&"number"==typeof d&&!g&&Ke.updateCache({cacheManager:this.trackingCache,hasJsCssVariables:v,visitorCode:t,experimentId:u,variationId:d}),a&&!g&&this.tracker.scheduleVisitor(t,this._isConsentProvided(t));const m={name:null!==(o=null===(n=r.variations.find(e=>e.key===c))||void 0===n?void 0:n.name)&&void 0!==o?o:"",key:c,id:d,experimentId:u,variables:p};return M.debug`RETURN: KameleoonClient._getFeatureVariation(visitorCode: ${t}, featureKey: ${i}, track: ${a}) -> (variation: ${m})`,l.Ok(m)}_isVisitorNotInHoldout(t,i,a,n,o){const r=this.clientConfiguration.holdout;if(!r)return!0;M.debug`CALL: KameleoonClient._isVisitorNotInHoldout(visitorCode: ${t}, track: ${i}, save: ${a}, featureFlag: ${n}, visitorData: ${o})`;let s=!0;if((this.clientConfiguration.isConsentRequired?this.getLegalConsent(t):xt.Given)==xt.NotGiven&&this.clientConfiguration.consentBlockingBehaviour==W.CompletelyBlocked)throw new h(e.KameleoonException.FeatureFlagEnvironmentDisabled,`Evaluation of holdout is blocked because consent is not provided for visitor '${t}'`);const u=this._getCodeForHash(t,null==n?void 0:n.bucketingCustomDataIndex,o),l=Bt.getHashDouble({visitorIdentifier:u,respoolTime:null,id:String(r.experimentId)});M.debug`Calculated holdoutHash: ${l} for visitorCode: ${u}`;let d=Ke.getVariationByHash(r.variationByExposition,l);return null!==d&&(s="in-holdout"!==d.variationKey,a&&this.variationConfiguration.updateStoredVariations(t,{[r.experimentId]:{variationId:d.variationId,isTargetedRule:!1,status:i?e.TrackingStatus.Unsent:e.TrackingStatus.Sent}})),M.debug`RETURN: KameleoonClient._isVisitorNotInHoldout(visitorCode: ${t}, track: ${i}, save: ${a}, featureFlag: ${n}, visitorData: ${o}) -> (isNotInHoldout: ${s})`,s}_setForcedVariation({visitorCode:t,experimentId:i,variationKey:a,forceTargeting:n=!0}){if(M.debug`CALL: KameleoonClient._setForcedVariation(visitorCode: '${t}', experimentId: ${i}, variationKey: '${a}', forceTargeting: ${n})`,null===a){const e=this.variationConfiguration.updateForcedExperimentVariation(t,i,null);return M.debug`RETURN: KameleoonClient._setForcedVariation(visitorCode: '${t}', experimentId: ${i}, variationKey: '${a}', forceTargeting: ${n}) -> (writeResult: ${e})`,e}let o=null,r=null;if(o=this.clientConfiguration.experimentMap.get(i),!o)return M.error`Experiment with id ${i} not found for visitor ${t}`,l.Err(new h(e.KameleoonException.FeatureFlagExperimentNotFound,i,t));if(r=o.variations.get(a),void 0===r)return M.error`Variation with key ${a} not found in experiment ${o} for visitor ${t}`,l.Err(new h(e.KameleoonException.FeatureFlagVariationNotFound,a,t));o={type:o.type,experimentId:i},r={variationKey:a,variationId:r};const s=this.variationConfiguration.updateForcedExperimentVariation(t,i,{rule:o,varByExp:r,forceTargeting:n});return M.debug`RETURN: KameleoonClient._setForcedVariation(visitorCode: '${t}', experimentId: ${i}, variationKey: '${a}', forceTargeting: ${n}) -> (writeResult: ${s})`,s}_getCodeForHash(e,t,i){var a;let n;if(M.debug`CALL: KameleoonClient._getCodeForHash(visitorCode: ${e}, bucketingCustomDataIndex: ${t}, visitorData: ${i})`,null!=t){const e=null==i?void 0:i.customData;if(e){const i=null===(a=e[t])||void 0===a?void 0:a.value[0];i&&(n=i)}}return n||(n=this.dataManager.getVisitorIdentifier(e)),M.debug`RETURN: KameleoonClient._getCodeForHash(visitorCode: ${e}, bucketingCustomDataIndex: ${t}, visitorData: ${i}) -> (codeForHash: ${n})`,n}};Xt.EvaluatedExperiment=class{static fromForcedFeatureVariation(e,t){var i,a,n;let o=e;return t.varByExp?o=t.varByExp.variationKey:t.rule&&t.rule.type===G.EXPERIMENTATION&&(o=ce),{variationKey:o,variationId:(null===(i=t.varByExp)||void 0===i?void 0:i.variationId)||null,experimentId:(null===(a=t.rule)||void 0===a?void 0:a.experimentId)||null,ruleType:(null===(n=t.rule)||void 0===n?void 0:n.type)||null,isSimulated:t.simulated}}static fromVariationData(e){var t,i;return{variationKey:e.variationKey,variationId:e.variationId,experimentId:e.experimentId,ruleType:null!==(i=null===(t=e.rule)||void 0===t?void 0:t.type)&&void 0!==i?i:null,isSimulated:!1}}static fromDefaultVariationKey(e){return{variationKey:e,variationId:null,experimentId:null,ruleType:null,isSimulated:!1}}};class Qt{static simulateSuccessRequest(t,i){switch(t){case e.RequestType.Tracking:return new Promise(e=>{e({status:204,json:()=>new Promise(e=>e(null)),text:()=>new Promise(e=>e("")),ok:!0})});case e.RequestType.Configuration:case e.RequestType.RemoteData:return new Promise(e=>{e({status:200,json:()=>new Promise(e=>e(i)),text:()=>new Promise(e=>e("")),ok:!0})});default:g(t)}}static getCookieValue(e,t){const i=e.split("; ").find(e=>{const[i,a]=e.split("=");return i===t&&""!==a});return i?i.split("=")[1]:null}}var Zt,ei=l.Err,ti=l.Ok;function ii(e,t,i,a){return new(i||(i=Promise))(function(n,o){function r(e){try{u(a.next(e))}catch(e){o(e)}}function s(e){try{u(a.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(r,s)}u((a=a.apply(e,t||[])).next())})}"function"==typeof SuppressedError&&SuppressedError;class ai{sendRequest({url:e,parameters:t}){return ii(this,void 0,void 0,function*(){return yield fetch(e,t)})}}!function(e){e.PairsDelimiter="; ",e.KeyValueDelimiter="=",e.MaxAge="Max-Age",e.Path="Path",e.Domain="Domain"}(Zt||(Zt={}));const ni=15*e.Milliseconds.Second,oi=30*e.Milliseconds.Minute;class ri{getData(e){M.debug`CALL: VisitorCodeManager.getData(key: ${e})`;const t=document.cookie;let i=null;return t&&(i=Qt.getCookieValue(t,e)),M.debug`RETURN: VisitorCodeManager.getData(key: ${e}) -> (visitorCode: ${i})`,i}setData({visitorCode:e,domain:t,maxAge:i,key:a,path:n}){const o=this.getResultCookie({domain:t,visitorCode:e,key:a,maxAge:i,path:n});document.cookie=o,M.debug`Cookie ${o} was added for visitor ${e}`}getResultCookie({domain:e,visitorCode:t,maxAge:i,key:a,path:n}){const o=[a+Zt.KeyValueDelimiter+t,Zt.MaxAge+Zt.KeyValueDelimiter+i,Zt.Path+Zt.KeyValueDelimiter+n];return e&&o.push(Zt.Domain+Zt.KeyValueDelimiter+e),o.join(Zt.PairsDelimiter)}}class si{read(t){const i=localStorage.getItem(t);return t!==e.KameleoonStorageKey.ConsentData||i&&"{}"!==i?i?JSON.parse(i):null:this.getEngineConsentData()}write(e,t){localStorage.setItem(e,JSON.stringify(t))}getEngineConsentData(){var t;this.visitorCodeManager||(this.visitorCodeManager=new ri);const i=this.visitorCodeManager.getData(e.KameleoonStorageKey.VisitorCode);if(!i)return null;try{const e=localStorage.getItem("kameleoonLegalConsent");if(!e)return null;const a=JSON.parse(e),n=null===(t=null==a?void 0:a.value)||void 0===t?void 0:t.AB_TESTING;return"boolean"==typeof n?{[i]:{consent:n?xt.Given:xt.NotGiven}}:null}catch(e){return null}}}class ui{open({eventType:e,onEvent:t,url:i}){const a=new EventSource(i);this.eventSource=a,this.eventSource.addEventListener(e,t)}close(){this.eventSource&&this.eventSource.close()}onError(e){this.eventSource&&(this.eventSource.onerror=e)}}class li{getRandomNumber(){if("undefined"!=typeof window&&(null===window||void 0===window?void 0:window.crypto)){const e=new Uint32Array(1),t=4294967296;return window.crypto.getRandomValues(e),e[0]/t}return Math.random()}}class di{log(t,i){switch(i=`${(new Date).toLocaleString("en-US",{timeZoneName:"short"})} ${i}`,t){case e.LogLevel.DEBUG:console.debug(i);break;case e.LogLevel.INFO:console.info(i);break;case e.LogLevel.WARNING:console.warn(i);break;case e.LogLevel.ERROR:console.error(i)}}}class ci{constructor(e,t,i,a){M.debug`CALL: new VisitorActivityManager(dataManager, tracker, isConsentProvided, interval: ${a})`,this.dataManager=e,this.tracker=t,this.isConsentProvided=i,this.setup(a),M.debug`RETURN: new VisitorActivityManager(dataManager, tracker, isConsentProvided, interval: ${a})`}setup(e){setInterval(()=>{this.updateLastActivity()},e),this.updateLastActivity()}updateLastActivity(){M.debug`CALL: VisitorActivityManager.updateLastActivity()`;const e=this.dataManager.updateLastActivity();e&&this.tracker.scheduleVisitor(e,this.isConsentProvided(e)),M.debug`RETURN: VisitorActivityManager.updateLastActivity()`}}class gi extends $t{constructor({dataStorage:e,infoStorage:t,cleanupInterval:i,packageInfo:a,platformAnalyzer:n}){M.debug`CALL: new ClientDataManager(dataStorage, infoStorage, cleanupInterval: ${i}, packageInfo: ${a}, platformAnalyzer)`,super({dataStorage:e,infoStorage:t,cleanupInterval:i,packageInfo:a}),this.visitor=null,this.platformAnalyzer=n,this.updateVisitor(),M.debug`RETURN: new ClientDataManager(dataStorage, infoStorage, cleanupInterval: ${i} packageInfo: ${a}, platformAnalyzer)`}getUnsentData(t){var i,a;const n=super.getUnsentData(t),o=super.getVisitorData(t);if(!o)return n;const r=o[e.KameleoonData.Browser],s=o[e.KameleoonData.Device],u=o[e.KameleoonData.OperatingSystem],l=new Ye({browserType:null==r?void 0:r.browser,browserVersion:null==r?void 0:r.version,visitNumber:null===(i=this.visitor)||void 0===i?void 0:i.visitNumber,timeSincePreviousVisit:null===(a=this.visitor)||void 0===a?void 0:a.timeSincePreviousVisit,os:null==u?void 0:u.operatingSystem,deviceType:null==s?void 0:s.device});return n.push(l),n}storeData(e,...t){return"string"==typeof e?(t.length&&this.checkVisitor(e),super.storeData(e,...t)):super.storeData(e,!0)}getVisitorData(e){return this.checkVisitor(e),super.getVisitorData(e)}updateLastActivity(){var t,i,a,n;if(!this.visitor)return null;const o=this.dataStorage.read();if(!o.ok)return null;const r=o.data;let s=null!==(t=r[this.visitor.visitorCode])&&void 0!==t?t:{};"string"==typeof s&&(s=r[s]);let u=s[e.KameleoonData.VisitsData];u||(u={visits:[],visitNumber:0,type:e.KameleoonData.VisitsData,status:e.TrackingStatus.Sent,expirationTime:0},s[e.KameleoonData.VisitsData]=u);const l=this.fetchVisit(u.visits,u.visits.length-1),d=null!==(i=null==l?void 0:l.timeLastActivity)&&void 0!==i?i:0,c=Date.now();let g=null!==(a=u.visitNumber)&&void 0!==a?a:u.visits.length?u.visits.length-1:0;if(c-d>oi)g+=d>0?1:0,Ae.insertVisitInOrderedListMutably({list:u.visits,visit:{timeStarted:c,timeLastActivity:c}}),this.visitor.timeSincePreviousVisit=l?c-d:0;else if(u.visits.length&&(u.visits[u.visits.length-1]={timeStarted:null!==(n=null==l?void 0:l.timeStarted)&&void 0!==n?n:c,timeLastActivity:c},-1===this.visitor.timeSincePreviousVisit)){const e=this.fetchVisit(u.visits,u.visits.length-2);this.visitor.timeSincePreviousVisit=e?c-e.timeLastActivity:0}return u.visitNumber=g,this.visitor.visitNumber=g,this.dataStorage.write(r),this.visitor.visitorCode}checkVisitor(e){this.visitor&&this.visitor.visitorCode===e||this.createVisitor(e)}createVisitor(e){var t,i,a;M.debug`CALL: ClientDataManager.createVisitor(visitorCode: ${e})`,this.visitor=new hi(e);try{const n=this.platformAnalyzer.getResult(),o=[];(null===(t=n.os)||void 0===t?void 0:t.name)&&o.push(new Fe(n.os.name)),(null===(i=n.platform)||void 0===i?void 0:i.type)&&o.push(new Me(n.platform.type)),(null===(a=n.browser)||void 0===a?void 0:a.name)&&o.push(new Ne(n.browser.name,n.browser.version)),n.pageView&&o.push(n.pageView),o.length&&this.storeData(e,...o)}finally{this.updateLastActivity()}M.debug`RETURN: ClientDataManager.createVisitor(visitorCode: ${e})`}updateVisitor(){var t;M.debug`CALL: ClientDataManager.updateVisitor()`;const i=this.dataStorage.read();if(!i.ok)return;const a=i.data;let n,o=-1;for(const[i,r]of Object.entries(a)){if("string"==typeof r)continue;const a=r[e.KameleoonData.VisitsData];if(!a){n||(n=i);continue}const s=a.visits.length?a.visits[a.visits.length-1]:null;if(s){const e=null!==(t="number"==typeof s?s:null==s?void 0:s.timeLastActivity)&&void 0!==t?t:0;e>o&&(o=e,n=i)}else n||(n=i)}n?this.createVisitor(n):(this.visitor=null,M.debug`ClientDataManager no visitor found`),M.debug`RETURN: ClientDataManager.updateVisitor()`}fetchVisit(e,t){if(t<0||t>=e.length)return null;const i=e[t];return"number"==typeof i?{timeStarted:i,timeLastActivity:i}:i}}class hi{constructor(e){this.visitNumber=0,this.timeSincePreviousVisit=-1,this.visitorCode=e}}class pi{static getFirstMatch(e,t){const i=t.match(e);return i&&i.length>0&&i[1]||""}static getSecondMatch(e,t){const i=t.match(e);return i&&i.length>1&&i[2]||""}static assign(e,...t){return Object.assign(e,...t)}}class vi{constructor(){this.userAgent=navigator.userAgent||"",M.debug`PlatformParser: userAgent = ${this.userAgent}`,this.parsedResult={},""!==this.userAgent&&this.parse()}parseBrowser(){const t=[{test:[/chrome|crios|crmo/i],describe:t=>({name:e.BrowserType.Chrome,version:this.getBrowserVersion(pi.getFirstMatch(/(?:chrome|crios|crmo)\/(\d+(\.?_?\d+)+)/i,t))})},{test:[/firefox|iceweasel|fxios/i],describe:t=>({name:e.BrowserType.Firefox,version:this.getBrowserVersion(pi.getFirstMatch(/(?:firefox|iceweasel|fxios)[\s/](\d+(\.?_?\d+)+)/i,t))})},{test:[/safari|applewebkit/i],describe:t=>({name:e.BrowserType.Safari,version:this.getBrowserVersion(pi.getFirstMatch(/version\/(\d+(\.?_?\d+)+)/i,t))})},{test:[/opr\/|opios/i],describe:t=>({name:e.BrowserType.Opera,version:this.getBrowserVersion(pi.getFirstMatch(/(?:opr|opios)[\s/](\S+)/i,t))})},{test:[/edg([ea]|ios)/i],describe:t=>({name:e.BrowserType.InternetExplorer,version:this.getBrowserVersion(pi.getSecondMatch(/edg([ea]|ios)\/(\d+(\.?_?\d+)+)/i,t))})},{test:[/googlebot/i],describe:t=>({name:e.BrowserType.Other,version:this.getBrowserVersion(pi.getFirstMatch(/googlebot\/(\d+(\.\d+))/i,t)||pi.getFirstMatch(/version\/(\d+(\.?_?\d+)+)/i,t))})},{test:[/SamsungBrowser/i],describe:t=>({name:e.BrowserType.Other,version:this.getBrowserVersion(pi.getFirstMatch(/(?:SamsungBrowser)[\s/](\d+(\.?_?\d+)+)/i,t))})},{test:[/yabrowser/i],describe:t=>({name:e.BrowserType.Other,version:this.getBrowserVersion(pi.getFirstMatch(/(?:yabrowser)[\s/](\d+(\.?_?\d+)+)/i,t))})},{test:[/ucbrowser/i],describe:t=>({name:e.BrowserType.Other,version:this.getBrowserVersion(pi.getFirstMatch(/(?:ucbrowser)[\s/](\d+(\.?_?\d+)+)/i,t))})},{test:[/vivaldi/i],describe:t=>({name:e.BrowserType.Other,version:this.getBrowserVersion(pi.getFirstMatch(/vivaldi\/(\d+(\.?_?\d+)+)/i,t))})},{test:[/phantom/i],describe:t=>({name:e.BrowserType.Other,version:this.getBrowserVersion(pi.getFirstMatch(/phantomjs\/(\d+(\.?_?\d+)+)/i,t))})},{test:[/electron/i],describe:t=>({name:e.BrowserType.Other,version:this.getBrowserVersion(pi.getFirstMatch(/(?:electron)\/(\d+(\.?_?\d+)+)/i,t))})},{test:[/chromium/i],describe:t=>({name:e.BrowserType.Other,version:this.getBrowserVersion(pi.getFirstMatch(/(?:chromium)[\s/](\d+(\.?_?\d+)+)/i,t))})},{test:[/opera/i],describe:t=>({name:e.BrowserType.Opera,version:this.getBrowserVersion(pi.getFirstMatch(/(?:opera)[\s/](\d+(\.?_?\d+)+)/i,t))})},{test:[/msie|trident/i],describe:t=>({name:e.BrowserType.InternetExplorer,version:this.getBrowserVersion(pi.getFirstMatch(/(?:msie |rv:)(\d+(\.?_?\d+)+)/i,t))})},{test:[/.*/i],describe:t=>{const i=t.includes("(")?/^(.*)\/(.*)[ \t]\((.*)/:/^(.*)\/(.*) /;return{name:e.BrowserType.Other,version:this.getBrowserVersion(pi.getSecondMatch(i,t))}}}].find(e=>e.test.some(e=>e.test(this.userAgent)));return t&&(this.parsedResult.browser=t.describe(this.userAgent)),this.parsedResult.browser||{}}parseOS(){const t=[{test:[/windows phone/i],describe:()=>({name:e.OperatingSystemType.WindowsPhone})},{test:[/windows /i],describe:()=>({name:e.OperatingSystemType.Windows})},{test:[/Macintosh(.*?) FxiOS(.*?) Version\//],describe:t=>({name:e.OperatingSystemType.IOS,version:pi.getSecondMatch(/(Version\/)(\d[\d.]+)/,t)})},{test:[/macintosh/i],describe:t=>({name:e.OperatingSystemType.Mac,version:pi.getFirstMatch(/mac os x (\d+(\.?_?\d+)+)/i,t).replace(/[_\s]/g,".")})},{test:[/(ipod|iphone|ipad)/i],describe:t=>({name:e.OperatingSystemType.IOS,version:pi.getFirstMatch(/os (\d+([_\s]\d+)*) like mac os x/i,t).replace(/[_\s]/g,".")})},{test:[/android/i],describe:()=>({name:e.OperatingSystemType.Android})},{test:[/linux/i],describe:()=>({name:e.OperatingSystemType.Linux})}].find(e=>e.test.some(e=>e.test(this.userAgent)));return t&&(this.parsedResult.os=t.describe(this.userAgent)),this.parsedResult.os||{}}parsePlatform(){const t=[{test:()=>{var t,i;return(null===(t=this.parsedResult.os)||void 0===t?void 0:t.name)===e.OperatingSystemType.Android&&Number(String(null===(i=this.parsedResult.os)||void 0===i?void 0:i.version).split(".")[0])>=3},describe:t=>({type:e.DeviceType.Tablet})},{test:()=>{var t;return(null===(t=this.parsedResult.os)||void 0===t?void 0:t.name)===e.OperatingSystemType.Android},describe:()=>({type:e.DeviceType.Phone})},{test:()=>{var t;return(null===(t=this.parsedResult.os)||void 0===t?void 0:t.name)===e.OperatingSystemType.Mac},describe:()=>({type:e.DeviceType.Desktop})},{test:()=>{var t;return(null===(t=this.parsedResult.os)||void 0===t?void 0:t.name)===e.OperatingSystemType.Windows},describe:()=>({type:e.DeviceType.Desktop})},{test:()=>{var t;return(null===(t=this.parsedResult.os)||void 0===t?void 0:t.name)===e.OperatingSystemType.Linux},describe:()=>({type:e.DeviceType.Desktop})}],i=[{test:[/huserAgentwei/i],describe:t=>({type:e.DeviceType.Phone})},{test:[/nexus\s*(?:7|8|9|10).*/i],describe:()=>({type:e.DeviceType.Tablet})},{test:[/ipad/i],describe:()=>({type:e.DeviceType.Tablet})},{test:[/Macintosh(.*?) FxiOS(.*?) Version\//],describe:()=>({type:e.DeviceType.Tablet})},{test:[/kftt build/i],describe:()=>({type:e.DeviceType.Tablet})},{test:[/silk/i],describe:()=>({type:e.DeviceType.Tablet})},{test:[/tablet(?! pc)/i],describe:()=>({type:e.DeviceType.Tablet})},{test:[/ipod|iphone/i],describe:()=>({type:e.DeviceType.Phone})},{test:[/nexus\s*[0-6].*/i,/galaxy nexus/i],describe:()=>({type:e.DeviceType.Phone})},{test:[/[^-]mobi/i],describe:()=>({type:e.DeviceType.Phone})},{test:[/blackberry/i],describe:()=>({type:e.DeviceType.Phone})},{test:[/bada/i],describe:()=>({type:e.DeviceType.Phone})},{test:[/windows phone/i],describe:()=>({type:e.DeviceType.Phone})},{test:[/android/i],describe:()=>({type:e.DeviceType.Phone})},{test:[/ios/i],describe:()=>({type:e.DeviceType.Desktop})},{test:[/windows/i],describe:()=>({type:e.DeviceType.Desktop})},{test:[/linux/i],describe:()=>({type:e.DeviceType.Desktop})}].find(e=>e.test.some(e=>e.test(this.userAgent)))||t.find(e=>e.test());return i&&(this.parsedResult.platform=i.describe(this.userAgent)),this.parsedResult.platform||{}}parse(){this.userAgent&&(this.parseBrowser(),this.parseOS(),this.parsePlatform())}getBrowserVersion(e){if(!e)return;const t=e.split(".");if(0===t.length)return;const i=t.length>1?`${t[0]}.${t[1]}`:t[0],a=parseFloat(i);return isNaN(a)?void 0:a}parseWebView(){var e;let t=null===(e=window.location)||void 0===e?void 0:e.href;if(t){const e=document?document.title:"";this.parsedResult.pageView=new xe({urlAddress:t,title:e})}}getResult(){return this.parseWebView(),pi.assign({},this.parsedResult)}}e.ApplicationVersion=class{constructor(t){this.version=t,this.status=e.TrackingStatus.Sent}get url(){return""}get data(){return{version:this.version,type:e.KameleoonData.ApplicationVersion,status:this.status}}},e.Browser=Ne,e.Conversion=$e,e.Cookie=qe,e.CustomData=Oe,e.DataManager=$t,e.DataProcessor=We,e.DataStorage=Kt,e.Device=Me,e.Err=ei,e.GeolocationData=Le,e.KameleoonClient=class extends Xt{constructor({siteCode:t,configuration:i,externals:a,_internals:n,stubMode:o}){var r;if(o)return super({siteCode:t,internalConfiguration:{},stubMode:o}),this.internalVisitorCodeManager={},void(this.externalVisitorCodeManager={});const s=(null==n?void 0:n.prng)||new li,u=(null==a?void 0:a.storage)||new si,l=(null==a?void 0:a.requester)||new ai,d=(null==a?void 0:a.eventSource)||new ui,c=new qt,g=(null==a?void 0:a.visitorCodeManager)||new ri,h=(null==n?void 0:n.packageInfo)||{type:e.SdkLanguageType.JAVASCRIPT,version:"4.17.2",isServer:!1},p=new Kt(u,e.KameleoonStorageKey.TargetingData),v=new Kt(u,e.KameleoonStorageKey.DataInfo),m=new gi({dataStorage:p,infoStorage:v,cleanupInterval:0,packageInfo:h,platformAnalyzer:null!==(r=null==n?void 0:n.platformAnalyzer)&&void 0!==r?r:new vi});super({siteCode:t,configuration:i,internalConfiguration:{externals:{externalPRNG:s,externalStorage:u,externalRequester:l,externalEventSource:d,externalVisitorCodeManager:c,externalPackageInfo:h,externalLogger:(null==a?void 0:a.logger)||new di,customDataManager:m},settings:{useAbortController:!0}}});const f=be.validateDomain(null==i?void 0:i.cookieDomain);this.domain=f.ok?f.data:void 0,this.internalVisitorCodeManager=c,this.externalVisitorCodeManager=g,this.customDataManager=m}initialize(){const e=Object.create(null,{initialize:{get:()=>super.initialize}});return ii(this,void 0,void 0,function*(){if(this.stubMode)return!1;const t=e.initialize.call(this);return new ci(this.customDataManager,this.tracker,e=>this._isConsentProvided(e),ni),t})}getVisitorCode(e){var t;if(this.stubMode)return"";M.info`CALL KamaleoonClient.getVisitorCode(defaultVisitorCode: ${e})`,this.internalVisitorCodeManager.getData=e=>this.externalVisitorCodeManager.getData(e),this.internalVisitorCodeManager.setData=e=>{this.externalVisitorCodeManager.setData(Object.assign(Object.assign({},e),{domain:this.domain}))};const i=this.internalVisitorCodeManager.getVisitorCode(e);return this.initialized&&(null===(t=this.customDataManager)||void 0===t||t.checkVisitor(i)),M.info`RETURN KamaleoonClient.getVisitorCode(defaultVisitorCode: ${e}) -> (visitorCode: ${i})`,i}setLegalConsent(e,t){this.stubMode||(super.setUserConsent({visitorCode:e,consent:t,setData:e=>{this.externalVisitorCodeManager.setData(Object.assign(Object.assign({},e),{domain:this.domain}))}}),super.flush(e))}},e.KameleoonCore=Xt,e.KameleoonError=h,e.KameleoonLogger=M,e.KameleoonUtils=Qt,e.ListUtilities=Ae,e.NUMBER_OF_RETRIES=1,e.Ok=ti,e.OperatingSystem=Fe,e.PageView=xe,e.Parser=ze,e.StaticData=Ye,e.Tree=Qe,e.UniqueIdentifier=He,e.UserAgent=class{constructor(t){this.value=t,this.status=e.TrackingStatus.Sent}get url(){return""}get data(){return{value:this.value,type:e.KameleoonData.UserAgent,status:this.status}}},e.Utilities=Ke,e.VISITOR_CODE_LENGTH=16,e.VISIT_DURATION=Rt,e.Validator=be,e.VisitorCodeManager=qt});
//# sourceMappingURL=javascript-sdk.umd.min.js.map
