{"ast":null,"code":"import _objectSpread from\"/Users/eurocare/Downloads/barvihaluxury-main/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useState,useEffect,useRef}from\"react\";import{apiFetchJson,getAccessToken}from\"../api\";import{MessageIcon}from\"./Icons\";import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";const SEEN_STORAGE_KEY=\"kl_messages_seen_v1\";const THREAD_CACHE_TTL_MS=2*60*1000;const detectMobileView=()=>{var _window$screen;if(typeof window===\"undefined\")return false;const viewportWidth=window.innerWidth||document.documentElement.clientWidth||0;const screenWidth=typeof((_window$screen=window.screen)===null||_window$screen===void 0?void 0:_window$screen.width)===\"number\"?window.screen.width:viewportWidth;const effectiveWidth=Math.min(viewportWidth||screenWidth,screenWidth||viewportWidth);const mobileUa=/Android|webOS|iPhone|iPad|iPod|Opera Mini|IEMobile/i.test(typeof navigator!==\"undefined\"&&navigator.userAgent||\"\");const hasCoarsePointer=typeof window.matchMedia===\"function\"?window.matchMedia(\"(pointer: coarse)\").matches:false;const noHover=typeof window.matchMedia===\"function\"?window.matchMedia(\"(hover: none)\").matches:false;const touchPoints=typeof navigator!==\"undefined\"?Number(navigator.maxTouchPoints||0):0;const touchLikeDevice=hasCoarsePointer||noHover||touchPoints>1;return effectiveWidth<=768||touchLikeDevice&&effectiveWidth<=1024||mobileUa&&effectiveWidth<=1180;};const normalizePreviewImageUrl=value=>{const raw=String(value||\"\").trim();if(!raw)return\"\";if(/^data:/i.test(raw)){// Kleinanzeigen message attachments can be inlined (data:image/*). Keep small payloads so\n// sent/received photos still render when we fall back to DOM parsing.\nif(/^data:image\\\\//i.test(raw)&&raw.length<=250000)return raw;return\"\";}const normalizeRuleForKleinanzeigen=parsed=>{const host=String(parsed.hostname||\"\").toLowerCase();const isProdAdsImage=host===\"img.kleinanzeigen.de\"&&parsed.pathname.startsWith(\"/api/v1/prod-ads/images/\");if(!isProdAdsImage)return parsed;const ruleParam=String(parsed.searchParams.get(\"rule\")||\"\");const malformedRule=/(imageid|\\$\\{.*\\}|\\$_\\{.*\\})/i.test(ruleParam);const validRule=/^\\$_[a-z0-9_.-]+$/i.test(ruleParam);if(!validRule||malformedRule){parsed.searchParams.set(\"rule\",\"$_57.JPG\");}return parsed;};if(/^(https?:)?\\/\\//i.test(raw)){try{const parsed=normalizeRuleForKleinanzeigen(new URL(raw.startsWith(\"//\")?\"https:\".concat(raw):raw));return parsed.href;}catch(_unused){return raw.startsWith(\"//\")?\"https:\".concat(raw):raw;}}if(/^img\\.kleinanzeigen\\.de/i.test(raw))return normalizePreviewImageUrl(\"https://\".concat(raw));if(/^\\/api\\/v1\\/prod-ads\\/images\\//i.test(raw))return normalizePreviewImageUrl(\"https://img.kleinanzeigen.de\".concat(raw));try{const parsed=normalizeRuleForKleinanzeigen(new URL(raw,\"https://www.kleinanzeigen.de\"));return parsed.href;}catch(_unused2){return\"\";}};const toMessageImageSrc=(value,accountId)=>{const normalized=normalizePreviewImageUrl(value);if(!normalized)return\"\";const accountToken=accountId!==undefined&&accountId!==null&&String(accountId).trim()?String(accountId).trim():\"\";const accessToken=getAccessToken();if(normalized.startsWith(\"/api/messages/image?\")){let src=normalized;if(accountToken&&!/[?&]accountId=/i.test(src)){const separator=src.includes(\"?\")?\"&\":\"?\";src=\"\".concat(src).concat(separator,\"accountId=\").concat(encodeURIComponent(accountToken));}if(accessToken&&!/[?&](accessToken|token)=/i.test(src)){const separator=src.includes(\"?\")?\"&\":\"?\";src=\"\".concat(src).concat(separator,\"accessToken=\").concat(encodeURIComponent(accessToken));}return src;}if(/^https?:\\/\\//i.test(normalized)){if(!accountToken)return normalized;const params=new URLSearchParams();params.set(\"url\",normalized);params.set(\"accountId\",accountToken);if(accessToken){params.set(\"accessToken\",accessToken);}return\"/api/messages/image?\".concat(params.toString());}return normalized;};const getRawMessagePreviewImage=message=>{var _message$ad,_message$ad2,_message$ad3;if(!message||typeof message!==\"object\")return\"\";const candidates=[message.adImage,message.adImageUrl,message.adImageURL,message.imageUrl,message.image,message.thumbnailUrl,message.thumbnail,message.previewImage,(_message$ad=message.ad)===null||_message$ad===void 0?void 0:_message$ad.image,(_message$ad2=message.ad)===null||_message$ad2===void 0?void 0:_message$ad2.imageUrl,(_message$ad3=message.ad)===null||_message$ad3===void 0?void 0:_message$ad3.thumbnailUrl];for(const candidate of candidates){const normalized=normalizePreviewImageUrl(candidate);if(normalized)return normalized;}return\"\";};const getMessagePreviewImage=message=>toMessageImageSrc(getRawMessagePreviewImage(message),message===null||message===void 0?void 0:message.accountId);const hasMessagePreviewImage=message=>Boolean(getRawMessagePreviewImage(message));const isPaymentAndShippingMessage=message=>{if(!message||typeof message!==\"object\")return false;const type=String(message.type||\"\").toUpperCase();return type===\"PAYMENT_AND_SHIPPING_MESSAGE\"||Boolean(message.paymentAndShippingMessageType);};const formatEuroFromCents=value=>{const cents=Number(value);if(!Number.isFinite(cents))return\"\";return(cents/100).toLocaleString(\"de-DE\",{style:\"currency\",currency:\"EUR\"});};const pickOfferField=(message,key)=>{if(!message||typeof message!==\"object\")return null;const direct=message[key];if(direct!==undefined&&direct!==null)return direct;const actions=Array.isArray(message.actions)?message.actions:[];const withKey=actions.find(action=>action&&action[key]!==undefined&&action[key]!==null);return withKey?withKey[key]:null;};const getOfferActionText=function(message,actionType){let fallback=arguments.length>2&&arguments[2]!==undefined?arguments[2]:\"\";const actions=Array.isArray(message===null||message===void 0?void 0:message.actions)?message.actions:[];const action=actions.find(item=>(item===null||item===void 0?void 0:item.actionType)===actionType);return(action===null||action===void 0?void 0:action.ctaText)||fallback;};const extractAttachmentUrls=message=>{const buckets=[message===null||message===void 0?void 0:message.attachments,message===null||message===void 0?void 0:message.images,message===null||message===void 0?void 0:message.imageUrls,message===null||message===void 0?void 0:message.media,message===null||message===void 0?void 0:message.pictures].filter(value=>Array.isArray(value));const urls=[];for(const bucket of buckets){for(const item of bucket){if(!item)continue;if(typeof item===\"string\"){urls.push(item);continue;}if(typeof item===\"object\"){// Kleinanzeigen message attachments often need the gateway URL (auth required),\n// while the api.kleinanzeigen.de URL can return 401.\nconst candidate=item.gatewayUrl||item.url||item.href||item.src||item.imageUrl||item.thumbnailUrl;if(candidate)urls.push(candidate);}}}return urls.filter(Boolean);};const getConversationKey=message=>{if(!message||typeof message!==\"object\")return\"\";const accountId=message.accountId!=null?String(message.accountId):\"\";const convo=message.conversationId||message.conversationUrl||message.id||\"\";const convoId=convo!=null?String(convo):\"\";if(!accountId||!convoId)return\"\";return\"\".concat(accountId,\"|\").concat(convoId);};const getConversationFingerprint=message=>{if(!message||typeof message!==\"object\")return\"\";const date=String(message.date||\"\").trim();const time=String(message.time||\"\").trim();const text=String(message.message||\"\").trim();return\"\".concat(date,\"|\").concat(time,\"|\").concat(text);};const loadSeenMap=()=>{if(typeof window===\"undefined\"||!window.localStorage)return{};try{const raw=window.localStorage.getItem(SEEN_STORAGE_KEY);if(!raw)return{};const parsed=JSON.parse(raw);return parsed&&typeof parsed===\"object\"?parsed:{};}catch(_unused3){return{};}};const saveSeenMap=next=>{if(typeof window===\"undefined\"||!window.localStorage)return;try{window.localStorage.setItem(SEEN_STORAGE_KEY,JSON.stringify(next||{}));}catch(_unused4){// ignore quota / serialization issues\n}};const MessagesTab=()=>{var _selectedMessage$mess;const[messages,setMessages]=useState([]);const[selectedMessage,setSelectedMessage]=useState(null);const[replyText,setReplyText]=useState(\"\");const[replyImages,setReplyImages]=useState([]);const[sending,setSending]=useState(false);const[loading,setLoading]=useState(false);const[loadingThread,setLoadingThread]=useState(false);const[error,setError]=useState(null);const[isMobileView,setIsMobileView]=useState(()=>detectMobileView());const[translationByMessageId,setTranslationByMessageId]=useState({});const[declineConfirmOpen,setDeclineConfirmOpen]=useState(false);const[decliningOffer,setDecliningOffer]=useState(false);const chatScrollRef=useRef(null);const fileInputRef=useRef(null);const previewHydrationInFlight=useRef(new Set());const messagesRefreshInFlight=useRef(false);const translateInFlight=useRef(new Set());const threadCacheRef=useRef(new Map());const clearComposerImages=()=>{setReplyImages(prev=>{const existing=Array.isArray(prev)?prev:[];existing.forEach(item=>{if(item!==null&&item!==void 0&&item.previewUrl){URL.revokeObjectURL(item.previewUrl);}});return[];});};const getThreadCacheKeyForMessage=message=>{if(!message||typeof message!==\"object\")return\"\";const accountId=message.accountId!=null?String(message.accountId):\"\";const conversationId=message.conversationId!=null?String(message.conversationId):\"\";const conversationUrl=message.conversationUrl!=null?String(message.conversationUrl):\"\";if(!accountId)return\"\";if(conversationId)return\"\".concat(accountId,\"|cid:\").concat(conversationId);if(conversationUrl)return\"\".concat(accountId,\"|url:\").concat(conversationUrl);return\"\";};const readThreadCacheEntry=message=>{const key=getThreadCacheKeyForMessage(message);if(!key)return null;const entry=threadCacheRef.current.get(key);if(!entry||typeof entry!==\"object\")return null;if(!entry.expiresAt||entry.expiresAt<Date.now()){threadCacheRef.current.delete(key);return null;}return entry;};const writeThreadCacheEntry=(message,payload)=>{const key=getThreadCacheKeyForMessage(message);if(!key||!payload||typeof payload!==\"object\")return;threadCacheRef.current.set(key,{expiresAt:Date.now()+THREAD_CACHE_TTL_MS,payload:{adTitle:payload.adTitle||\"\",adImage:payload.adImage||\"\",sender:payload.sender||\"\",messages:Array.isArray(payload.messages)?payload.messages:[],conversationId:payload.conversationId||(message===null||message===void 0?void 0:message.conversationId)||\"\",conversationUrl:payload.conversationUrl||(message===null||message===void 0?void 0:message.conversationUrl)||\"\"}});};useEffect(()=>{loadMessages();},[]);useEffect(()=>{const intervalId=window.setInterval(()=>{// Avoid background polling when the tab is hidden (mobile data / lower load).\nif(typeof document!==\"undefined\"&&document.visibilityState!==\"visible\")return;loadMessages({silent:true});},3*60*1000);return()=>window.clearInterval(intervalId);},[]);useEffect(()=>{if(!selectedMessage)return;const container=chatScrollRef.current;if(!container)return;container.scrollTo({top:container.scrollHeight,behavior:\"smooth\"});},[selectedMessage===null||selectedMessage===void 0?void 0:selectedMessage.id,selectedMessage===null||selectedMessage===void 0?void 0:selectedMessage.messages]);useEffect(()=>{// Reset composer state when switching conversations.\nsetReplyText(\"\");clearComposerImages();setDeclineConfirmOpen(false);setDecliningOffer(false);},[selectedMessage===null||selectedMessage===void 0?void 0:selectedMessage.id]);useEffect(()=>{const handleResize=()=>{setIsMobileView(detectMobileView());};window.addEventListener(\"resize\",handleResize);return()=>window.removeEventListener(\"resize\",handleResize);},[]);const hydrateMissingPreviewImages=async list=>{if(!Array.isArray(list)||!list.length)return;const candidates=list.filter(item=>item&&!hasMessagePreviewImage(item)).slice(0,10);for(const item of candidates){const key=String(item.conversationId||item.conversationUrl||item.id||\"\");if(!key||previewHydrationInFlight.current.has(key))continue;previewHydrationInFlight.current.add(key);try{const params=new URLSearchParams();if(item.accountId!=null)params.set(\"accountId\",String(item.accountId));if(item.conversationId)params.set(\"conversationId\",String(item.conversationId));if(item.conversationUrl)params.set(\"conversationUrl\",String(item.conversationUrl));if(!item.conversationId&&!item.conversationUrl){if(item.sender)params.set(\"participant\",String(item.sender));if(item.adTitle)params.set(\"adTitle\",String(item.adTitle));}if(!params.get(\"accountId\"))continue;const data=await apiFetchJson(\"/api/messages/thread?\".concat(params.toString()));const adImage=normalizePreviewImageUrl(data===null||data===void 0?void 0:data.adImage);if(!adImage)continue;setMessages(prev=>prev.map(msg=>{const sameConversation=item.conversationId&&msg.conversationId&&String(item.conversationId)===String(msg.conversationId)||item.conversationUrl&&msg.conversationUrl&&String(item.conversationUrl)===String(msg.conversationUrl)||String(msg.id)===String(item.id);if(!sameConversation)return msg;return _objectSpread(_objectSpread({},msg),{},{adImage,adTitle:(data===null||data===void 0?void 0:data.adTitle)||msg.adTitle,conversationId:(data===null||data===void 0?void 0:data.conversationId)||msg.conversationId,conversationUrl:(data===null||data===void 0?void 0:data.conversationUrl)||msg.conversationUrl});}));}catch(error){console.error(\"Не удалось догрузить превью диалога:\",error);}finally{previewHydrationInFlight.current.delete(key);}}};const rememberConversationSeen=message=>{const key=getConversationKey(message);if(!key)return;const fingerprint=getConversationFingerprint(message);if(!fingerprint)return;const seen=loadSeenMap();seen[key]={fingerprint,seenAt:Date.now()};saveSeenMap(seen);// Immediately update UI so the badge doesn't come back on refresh.\nsetMessages(prev=>prev.map(msg=>{const msgKey=getConversationKey(msg);if(!msgKey||msgKey!==key)return msg;return _objectSpread(_objectSpread({},msg),{},{unread:false});}));};const loadMessages=async function(){let opts=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};const silent=Boolean(opts&&typeof opts===\"object\"&&opts.silent);if(messagesRefreshInFlight.current)return;messagesRefreshInFlight.current=true;if(!silent){setLoading(true);setError(null);}try{const data=await apiFetchJson(\"/api/messages\");const list=Array.isArray(data)?data:[];const seen=new Set();const deduped=[];for(const item of list){const key=item.conversationId||item.conversationUrl||item.id||\"\".concat(item.accountId||\"\",\"|\").concat(item.sender||\"\",\"|\").concat(item.adTitle||\"\",\"|\").concat(item.message||\"\",\"|\").concat(item.time||\"\");if(seen.has(key))continue;seen.add(key);deduped.push(item);}const seenMap=loadSeenMap();const merged=deduped.map(item=>{const key=getConversationKey(item);if(!key)return item;const entry=seenMap[key];if(!entry||typeof entry!==\"object\")return item;const currentFingerprint=getConversationFingerprint(item);if(entry.fingerprint&&entry.fingerprint===currentFingerprint){return _objectSpread(_objectSpread({},item),{},{unread:false});}return item;});setMessages(merged);hydrateMissingPreviewImages(merged);}catch(err){console.error(\"Ошибка загрузки сообщений:\",err);if(!silent)setError(err.message||\"Не удалось загрузить сообщения\");}finally{if(!silent)setLoading(false);messagesRefreshInFlight.current=false;}};// NOTE: Backend does not guarantee a \"mark read\" API (and Kleinanzeigen state may lag).\n// We persist \"seen\" locally so a refresh won't resurrect the \"new\" badge.\nconst markAsRead=message=>rememberConversationSeen(message);const handleReplyImageSelect=event=>{var _event$target;const files=Array.from((event===null||event===void 0?void 0:(_event$target=event.target)===null||_event$target===void 0?void 0:_event$target.files)||[]);if(event!==null&&event!==void 0&&event.target)event.target.value=\"\";if(!files.length)return;const nextItems=files.filter(file=>String((file===null||file===void 0?void 0:file.type)||\"\").toLowerCase().startsWith(\"image/\")).slice(0,10).map(file=>({id:\"img-\".concat(Date.now(),\"-\").concat(Math.random().toString(16).slice(2)),file,previewUrl:URL.createObjectURL(file)}));if(!nextItems.length)return;setReplyImages(prev=>{const existing=Array.isArray(prev)?prev:[];return[...existing,...nextItems].slice(0,10);});};const removeReplyImage=id=>{setReplyImages(prev=>{const existing=Array.isArray(prev)?prev:[];const target=existing.find(item=>(item===null||item===void 0?void 0:item.id)===id);if(target!==null&&target!==void 0&&target.previewUrl){URL.revokeObjectURL(target.previewUrl);}return existing.filter(item=>(item===null||item===void 0?void 0:item.id)!==id);});};const formatRequestError=(error,fallbackText)=>{var _error$data,_error$data2;const baseMessage=String((error===null||error===void 0?void 0:error.message)||fallbackText||\"Ошибка запроса\").trim();const debugId=(error===null||error===void 0?void 0:(_error$data=error.data)===null||_error$data===void 0?void 0:_error$data.debugId)||(error===null||error===void 0?void 0:error.debugId)||\"\";const requestId=(error===null||error===void 0?void 0:(_error$data2=error.data)===null||_error$data2===void 0?void 0:_error$data2.requestId)||(error===null||error===void 0?void 0:error.requestId)||\"\";if(debugId){return\"\".concat(baseMessage,\" (debugId: \").concat(debugId,\")\");}if(requestId){return\"\".concat(baseMessage,\" (requestId: \").concat(requestId,\")\");}return baseMessage;};const confirmDeclineOffer=async()=>{if(!selectedMessage||decliningOffer)return;if(!selectedMessage.conversationId&&!selectedMessage.conversationUrl){alert(\"Не найден идентификатор диалога.\");return;}setDecliningOffer(true);try{const result=await apiFetchJson(\"/api/messages/offer/decline\",{method:\"POST\",timeoutMs:240000,headers:{\"Content-Type\":\"application/json\"},body:JSON.stringify({accountId:selectedMessage.accountId,conversationId:selectedMessage.conversationId,conversationUrl:selectedMessage.conversationUrl})});const serverMessages=Array.isArray(result.messages)?result.messages:[];if(serverMessages.length){const lastMessage=serverMessages[serverMessages.length-1];const nextConversationId=result.conversationId||selectedMessage.conversationId;const nextConversationUrl=result.conversationUrl||selectedMessage.conversationUrl;setMessages(prev=>prev.map(msg=>msg.id===selectedMessage.id?_objectSpread(_objectSpread({},msg),{},{message:(lastMessage===null||lastMessage===void 0?void 0:lastMessage.text)||msg.message,date:(lastMessage===null||lastMessage===void 0?void 0:lastMessage.date)||msg.date,time:(lastMessage===null||lastMessage===void 0?void 0:lastMessage.time)||msg.time,conversationId:nextConversationId||msg.conversationId,conversationUrl:nextConversationUrl||msg.conversationUrl,unread:false}):msg));setSelectedMessage(prev=>_objectSpread(_objectSpread({},prev),{},{messages:serverMessages,conversationId:nextConversationId||prev.conversationId,conversationUrl:nextConversationUrl||prev.conversationUrl}));writeThreadCacheEntry(selectedMessage,{adTitle:selectedMessage.adTitle,adImage:selectedMessage.adImage,sender:selectedMessage.sender,messages:serverMessages,conversationId:nextConversationId,conversationUrl:nextConversationUrl});}else{// Fallback: refresh thread when backend doesn't return messages.\nfetchThread(selectedMessage,{force:true});}setDeclineConfirmOpen(false);}catch(error){console.error(\"Ошибка отклонения заявки:\",error,{status:error===null||error===void 0?void 0:error.status,code:error===null||error===void 0?void 0:error.code,data:(error===null||error===void 0?void 0:error.data)||null});alert(formatRequestError(error,\"Не удалось отклонить заявку\"));}finally{setDecliningOffer(false);}};const sendReply=async()=>{if(!selectedMessage)return;if(!selectedMessage.conversationId&&!selectedMessage.conversationUrl&&!selectedMessage.sender&&!selectedMessage.adTitle){alert(\"Не найден идентификатор диалога.\");return;}const textToSend=replyText.trim();const imagesToSend=Array.isArray(replyImages)?replyImages:[];if(imagesToSend.length&&!selectedMessage.conversationId&&!selectedMessage.conversationUrl){alert(\"Для отправки фото нужен conversationId диалога. Откройте диалог и попробуйте снова.\");return;}if(!textToSend&&imagesToSend.length===0)return;const now=new Date();const optimisticId=\"local-\".concat(now.getTime(),\"-\").concat(Math.random().toString(16).slice(2));const optimisticAttachments=imagesToSend.map(item=>{var _item$file,_item$file2;return{url:(item===null||item===void 0?void 0:item.previewUrl)||\"\",name:(item===null||item===void 0?void 0:(_item$file=item.file)===null||_item$file===void 0?void 0:_item$file.name)||\"\",type:(item===null||item===void 0?void 0:(_item$file2=item.file)===null||_item$file2===void 0?void 0:_item$file2.type)||\"\",local:true};}).filter(item=>item===null||item===void 0?void 0:item.url);const previewText=textToSend||(optimisticAttachments.length?\"Фото\":\"\");const optimisticMessage=_objectSpread({id:optimisticId,text:textToSend,date:now.toISOString().slice(0,10),time:now.toTimeString().slice(0,5),direction:\"outgoing\",sender:\"Вы\",pending:true},optimisticAttachments.length?{attachments:optimisticAttachments}:{});// Optimistic UI: show message immediately in the thread and conversation list.\nsetReplyText(\"\");setReplyImages([]);setSelectedMessage(prev=>{if(!prev)return prev;const existing=Array.isArray(prev.messages)&&prev.messages.length?prev.messages:prev.message?[{id:prev.id,text:prev.message,sender:prev.sender,date:prev.date,time:prev.time,direction:\"incoming\"}]:[];return _objectSpread(_objectSpread({},prev),{},{messages:[...existing,optimisticMessage]});});setMessages(prev=>prev.map(msg=>msg.id===selectedMessage.id?_objectSpread(_objectSpread({},msg),{},{message:previewText,date:optimisticMessage.date,time:optimisticMessage.time,unread:false}):msg));setSending(true);try{const result=optimisticAttachments.length?await(()=>{const form=new FormData();form.append(\"accountId\",String(selectedMessage.accountId));if(selectedMessage.conversationId)form.append(\"conversationId\",String(selectedMessage.conversationId));if(selectedMessage.conversationUrl)form.append(\"conversationUrl\",String(selectedMessage.conversationUrl));if(textToSend)form.append(\"text\",textToSend);imagesToSend.forEach(item=>{if(!(item!==null&&item!==void 0&&item.file))return;form.append(\"images\",item.file,item.file.name||\"image.jpg\");});return apiFetchJson(\"/api/messages/send-media\",{method:\"POST\",timeoutMs:240000,body:form});})():await apiFetchJson(\"/api/messages/send\",{method:\"POST\",timeoutMs:180000,headers:{\"Content-Type\":\"application/json\"},body:JSON.stringify({accountId:selectedMessage.accountId,conversationId:selectedMessage.conversationId,conversationUrl:selectedMessage.conversationUrl,participant:selectedMessage.sender,adTitle:selectedMessage.adTitle,text:textToSend})});if(result.success){const resolvedConversationId=result.conversationId||selectedMessage.conversationId;const resolvedConversationUrl=result.conversationUrl||selectedMessage.conversationUrl;const serverMessages=Array.isArray(result.messages)?result.messages:[];const hasSameOutgoing=optimisticAttachments.length?serverMessages.some(m=>String((m===null||m===void 0?void 0:m.direction)||\"\").toLowerCase()===\"outgoing\"&&(Array.isArray(m===null||m===void 0?void 0:m.attachments)&&m.attachments.length>0||textToSend&&String((m===null||m===void 0?void 0:m.text)||\"\")===textToSend)):serverMessages.some(m=>String((m===null||m===void 0?void 0:m.direction)||\"\").toLowerCase()===\"outgoing\"&&String((m===null||m===void 0?void 0:m.text)||\"\")===textToSend);const nextMessages=serverMessages.length?hasSameOutgoing?serverMessages:[...serverMessages,_objectSpread(_objectSpread({},optimisticMessage),{},{pending:false})]:null;if(nextMessages){const lastMessage=nextMessages[nextMessages.length-1];setMessages(prev=>prev.map(msg=>msg.id===selectedMessage.id?_objectSpread(_objectSpread({},msg),{},{message:(lastMessage===null||lastMessage===void 0?void 0:lastMessage.text)||msg.message,date:(lastMessage===null||lastMessage===void 0?void 0:lastMessage.date)||msg.date,time:(lastMessage===null||lastMessage===void 0?void 0:lastMessage.time)||msg.time,conversationId:resolvedConversationId||msg.conversationId,conversationUrl:resolvedConversationUrl||msg.conversationUrl}):msg));setSelectedMessage(prev=>_objectSpread(_objectSpread({},prev),{},{messages:nextMessages,conversationId:resolvedConversationId,conversationUrl:resolvedConversationUrl}));writeThreadCacheEntry(selectedMessage,{adTitle:selectedMessage.adTitle,adImage:selectedMessage.adImage,sender:selectedMessage.sender,messages:nextMessages,conversationId:resolvedConversationId,conversationUrl:resolvedConversationUrl});}else{// Backend may respond without thread messages. Keep optimistic entry and mark it as sent.\nsetSelectedMessage(prev=>{if(!prev)return prev;const updated=Array.isArray(prev.messages)?prev.messages:[];return _objectSpread(_objectSpread({},prev),{},{messages:updated.map(m=>(m===null||m===void 0?void 0:m.id)===optimisticId?_objectSpread(_objectSpread({},m),{},{pending:false}):m),conversationId:resolvedConversationId,conversationUrl:resolvedConversationUrl});});setMessages(prev=>prev.map(msg=>msg.id===selectedMessage.id?_objectSpread(_objectSpread({},msg),{},{conversationId:resolvedConversationId||msg.conversationId,conversationUrl:resolvedConversationUrl||msg.conversationUrl}):msg));}}else{// Revert optimistic update on logical failure.\nsetSelectedMessage(prev=>{if(!prev)return prev;const updated=Array.isArray(prev.messages)?prev.messages:[];return _objectSpread(_objectSpread({},prev),{},{messages:updated.filter(m=>(m===null||m===void 0?void 0:m.id)!==optimisticId)});});setReplyText(textToSend);setReplyImages(imagesToSend);const debugId=result!==null&&result!==void 0&&result.debugId?\" (debugId: \".concat(result.debugId,\")\"):\"\";alert(\"Ошибка: \"+(result.error||\"Не удалось отправить\")+debugId);}}catch(err){console.error(\"Ошибка отправки:\",err,{status:err===null||err===void 0?void 0:err.status,code:err===null||err===void 0?void 0:err.code,data:(err===null||err===void 0?void 0:err.data)||null});setSelectedMessage(prev=>{if(!prev)return prev;const updated=Array.isArray(prev.messages)?prev.messages:[];return _objectSpread(_objectSpread({},prev),{},{messages:updated.filter(m=>(m===null||m===void 0?void 0:m.id)!==optimisticId)});});setReplyText(textToSend);setReplyImages(imagesToSend);alert(formatRequestError(err,\"Ошибка при отправке сообщения\"));}finally{setSending(false);}};const getTimeAgo=(date,time)=>{if(!date&&!time)return\"\";const now=new Date();try{const messageDate=new Date(date+\"T\"+(time||\"00:00\"));if(isNaN(messageDate.getTime()))return time||date||\"\";const diffHours=Math.floor((now-messageDate)/(1000*60*60));if(diffHours<1)return time||\"Только что\";if(diffHours<24)return time;if(diffHours<48)return\"Вчера\";return date;}catch(_unused5){return time||date||\"\";}};const formatMessageDate=(date,time)=>{if(!date&&!time)return\"\";const parts=[];if(date){try{const d=new Date(date+\"T00:00\");if(!isNaN(d.getTime())){const now=new Date();const diffDays=Math.floor((now-d)/(1000*60*60*24));if(diffDays===0)parts.push(\"Сегодня\");else if(diffDays===1)parts.push(\"Вчера\");else parts.push(d.toLocaleDateString(\"ru-RU\",{day:\"numeric\",month:\"short\"}));}else{parts.push(date);}}catch(_unused6){parts.push(date);}}if(time)parts.push(time);return parts.join(\", \");};const threadMessages=selectedMessage!==null&&selectedMessage!==void 0&&(_selectedMessage$mess=selectedMessage.messages)!==null&&_selectedMessage$mess!==void 0&&_selectedMessage$mess.length?selectedMessage.messages:selectedMessage?[{id:selectedMessage.id,text:selectedMessage.message,sender:selectedMessage.sender,date:selectedMessage.date,time:selectedMessage.time,direction:\"incoming\"}]:[];const fetchThread=async function(message){let{force=false}=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};const cached=!force?readThreadCacheEntry(message):null;if(cached!==null&&cached!==void 0&&cached.payload){const cachedPayload=cached.payload;const updatedFromCache=_objectSpread(_objectSpread({},message),{},{adTitle:cachedPayload.adTitle||message.adTitle,adImage:cachedPayload.adImage||message.adImage,sender:message.sender||cachedPayload.sender||\"\",messages:Array.isArray(cachedPayload.messages)?cachedPayload.messages:[],conversationId:cachedPayload.conversationId||message.conversationId,conversationUrl:cachedPayload.conversationUrl||message.conversationUrl});setMessages(prev=>prev.map(msg=>String(msg.id)===String(message.id)?_objectSpread(_objectSpread({},msg),{},{adTitle:updatedFromCache.adTitle,adImage:updatedFromCache.adImage,conversationId:updatedFromCache.conversationId,conversationUrl:updatedFromCache.conversationUrl}):msg));setSelectedMessage(updatedFromCache);return;}setLoadingThread(true);try{const params=new URLSearchParams();params.set(\"accountId\",message.accountId);if(message.conversationId)params.set(\"conversationId\",message.conversationId);if(message.conversationUrl)params.set(\"conversationUrl\",message.conversationUrl);if(!message.conversationId&&!message.conversationUrl){if(message.sender)params.set(\"participant\",message.sender);if(message.adTitle)params.set(\"adTitle\",message.adTitle);}const data=await apiFetchJson(\"/api/messages/thread?\".concat(params.toString()));if(data.success){const adImage=normalizePreviewImageUrl(data.adImage||message.adImage);const updated=_objectSpread(_objectSpread({},message),{},{adTitle:data.adTitle||message.adTitle,adImage,sender:message.sender||data.participant||\"\",messages:data.messages||[],conversationId:data.conversationId||message.conversationId,conversationUrl:data.conversationUrl||message.conversationUrl});setMessages(prev=>prev.map(msg=>String(msg.id)===String(message.id)?_objectSpread(_objectSpread({},msg),{},{adTitle:updated.adTitle,adImage:updated.adImage,conversationId:updated.conversationId,conversationUrl:updated.conversationUrl}):msg));setSelectedMessage(updated);writeThreadCacheEntry(updated,updated);}}catch(err){console.error(\"Ошибка загрузки диалога:\",err);}finally{setLoadingThread(false);}};const handleKeyDown=e=>{if(e.key===\"Enter\"&&!e.shiftKey){e.preventDefault();sendReply();}};const unreadCount=messages.filter(m=>m.unread).length;const showConversationList=!isMobileView||!selectedMessage;const showChatPanel=!isMobileView||Boolean(selectedMessage);const selectedRawPreviewImage=selectedMessage?getRawMessagePreviewImage(selectedMessage):\"\";const selectedPreviewImage=selectedMessage?toMessageImageSrc(selectedRawPreviewImage,selectedMessage===null||selectedMessage===void 0?void 0:selectedMessage.accountId):\"\";const selectedDirectPreviewImage=normalizePreviewImageUrl(selectedRawPreviewImage);const hasReplyPayload=Boolean(replyText.trim())||replyImages.length>0;const canSendReply=!sending&&hasReplyPayload;// Spinner SVG for loading states\nconst Spinner=_ref=>{let{size=20,color=\"#7dd3fc\"}=_ref;return/*#__PURE__*/_jsx(\"svg\",{width:size,height:size,viewBox:\"0 0 24 24\",style:{animation:\"spin 1s linear infinite\"},children:/*#__PURE__*/_jsx(\"circle\",{cx:\"12\",cy:\"12\",r:\"10\",stroke:color,strokeWidth:\"3\",fill:\"none\",strokeDasharray:\"31.4\",strokeDashoffset:\"10\",strokeLinecap:\"round\"})});};return/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(\"style\",{children:\"\\n        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }\\n        @keyframes pulse { 0%, 100% { opacity: 0.4; } 50% { opacity: 0.8; } }\\n        @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }\\n        .msg-conv-item:hover { background: rgba(59,130,246,0.12) !important; }\\n        .msg-send-btn:hover:not(:disabled) { background: #16a34a !important; }\\n        .msg-refresh-btn:hover:not(:disabled) { background: #0284c7 !important; transform: scale(1.02); }\\n        .msg-refresh-btn:active:not(:disabled) { transform: scale(0.98); }\\n        .msg-translate-btn:hover { opacity: 1 !important; transform: translateY(-1px) scale(1.02) !important; }\\n        .msg-translate-btn:active { transform: translateY(0px) scale(0.98) !important; }\\n      \"}),/*#__PURE__*/_jsx(\"div\",{className:\"section-header\",style:{display:\"flex\",alignItems:\"center\",justifyContent:\"space-between\",gap:\"12px\",marginBottom:\"20px\",flexWrap:\"wrap\"},children:/*#__PURE__*/_jsxs(\"h2\",{style:{margin:0,color:\"#f8fafc\",display:\"flex\",alignItems:\"center\",gap:\"14px\",fontWeight:700},children:[/*#__PURE__*/_jsx(\"span\",{style:{width:\"42px\",height:\"42px\",borderRadius:\"14px\",background:\"linear-gradient(135deg, rgba(249, 115, 22, 0.25), rgba(194, 65, 12, 0.2))\",border:\"1px solid rgba(251, 146, 60, 0.4)\",boxShadow:\"0 4px 15px rgba(251, 146, 60, 0.28)\",display:\"flex\",alignItems:\"center\",justifyContent:\"center\"},children:/*#__PURE__*/_jsx(MessageIcon,{size:22,color:\"#fdba74\"})}),\"\\u0421\\u043E\\u043E\\u0431\\u0449\\u0435\\u043D\\u0438\\u044F\"]})}),/*#__PURE__*/_jsxs(\"div\",{className:\"messages-layout\",style:{display:\"flex\",gap:\"20px\",height:\"calc(100vh - 220px)\",minHeight:\"500px\"},children:[/*#__PURE__*/_jsxs(\"div\",{className:\"messages-list\",style:_objectSpread({width:\"400px\",minWidth:\"340px\",background:\"linear-gradient(145deg, rgba(30, 41, 59, 0.6) 0%, rgba(15, 23, 42, 0.95) 100%)\",borderRadius:\"20px\",overflow:\"hidden\",boxShadow:\"0 20px 50px rgba(0,0,0,0.4), 0 0 30px rgba(0,0,0,0.2)\",border:\"1px solid rgba(148,163,184,0.12)\",color:\"#e2e8f0\",display:\"flex\",flexDirection:\"column\",backdropFilter:\"blur(10px)\"},showConversationList?{}:{display:\"none\"}),children:[/*#__PURE__*/_jsxs(\"div\",{style:{padding:\"16px 20px\",borderBottom:\"1px solid rgba(148,163,184,0.15)\",background:\"rgba(15,23,42,0.5)\"},children:[/*#__PURE__*/_jsxs(\"div\",{style:{display:\"flex\",justifyContent:\"space-between\",alignItems:\"center\",marginBottom:\"12px\"},children:[/*#__PURE__*/_jsx(\"h3\",{style:{margin:0,fontSize:\"18px\",fontWeight:700},children:\"\\u0414\\u0438\\u0430\\u043B\\u043E\\u0433\\u0438\"}),unreadCount>0&&/*#__PURE__*/_jsxs(\"span\",{style:{padding:\"5px 14px\",background:\"linear-gradient(135deg, #10b981, #059669)\",color:\"white\",borderRadius:\"9999px\",fontSize:\"12px\",fontWeight:600,boxShadow:\"0 0 12px rgba(16, 185, 129, 0.4)\",border:\"1px solid rgba(16, 185, 129, 0.3)\"},children:[unreadCount,\" \",unreadCount===1?\"новое\":\"новых\"]})]}),/*#__PURE__*/_jsx(\"button\",{className:\"msg-refresh-btn\",onClick:loadMessages,disabled:loading,style:{width:\"100%\",padding:\"10px 16px\",background:loading?\"rgba(14,165,233,0.3)\":\"linear-gradient(135deg, #0ea5e9, #0284c7)\",color:\"white\",border:\"none\",borderRadius:\"10px\",fontSize:\"13px\",fontWeight:600,cursor:loading?\"not-allowed\":\"pointer\",display:\"flex\",alignItems:\"center\",justifyContent:\"center\",gap:\"8px\",transition:\"all 0.15s ease\"},children:loading?/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(Spinner,{size:16,color:\"#fff\"}),\"\\u0417\\u0430\\u0433\\u0440\\u0443\\u0437\\u043A\\u0430 \\u0441\\u043E\\u043E\\u0431\\u0449\\u0435\\u043D\\u0438\\u0439...\"]}):/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsxs(\"svg\",{width:\"16\",height:\"16\",viewBox:\"0 0 24 24\",fill:\"none\",stroke:\"currentColor\",strokeWidth:\"2.5\",strokeLinecap:\"round\",strokeLinejoin:\"round\",children:[/*#__PURE__*/_jsx(\"polyline\",{points:\"23 4 23 10 17 10\"}),/*#__PURE__*/_jsx(\"path\",{d:\"M20.49 15a9 9 0 1 1-2.12-9.36L23 10\"})]}),\"\\u041E\\u0431\\u043D\\u043E\\u0432\\u0438\\u0442\\u044C \\u0441\\u043E\\u043E\\u0431\\u0449\\u0435\\u043D\\u0438\\u044F\"]})})]}),error&&/*#__PURE__*/_jsxs(\"div\",{style:{margin:\"12px\",padding:\"12px 16px\",background:\"rgba(239,68,68,0.15)\",border:\"1px solid rgba(239,68,68,0.3)\",borderRadius:\"10px\",fontSize:\"13px\",color:\"#fca5a5\"},children:[/*#__PURE__*/_jsx(\"div\",{style:{fontWeight:600,marginBottom:\"4px\"},children:\"\\u041E\\u0448\\u0438\\u0431\\u043A\\u0430 \\u0437\\u0430\\u0433\\u0440\\u0443\\u0437\\u043A\\u0438\"}),/*#__PURE__*/_jsx(\"div\",{children:error}),/*#__PURE__*/_jsx(\"button\",{onClick:loadMessages,style:{marginTop:\"8px\",padding:\"4px 12px\",background:\"rgba(239,68,68,0.3)\",color:\"#fca5a5\",border:\"1px solid rgba(239,68,68,0.4)\",borderRadius:\"6px\",fontSize:\"12px\",cursor:\"pointer\"},children:\"\\u041F\\u043E\\u043F\\u0440\\u043E\\u0431\\u043E\\u0432\\u0430\\u0442\\u044C \\u0441\\u043D\\u043E\\u0432\\u0430\"})]}),/*#__PURE__*/_jsx(\"div\",{style:{flex:1,overflow:\"auto\"},children:loading&&messages.length===0?/*#__PURE__*/// Loading skeleton\n_jsx(\"div\",{style:{padding:\"8px 0\"},children:[1,2,3,4,5].map(i=>/*#__PURE__*/_jsxs(\"div\",{style:{padding:\"14px 20px\",display:\"flex\",gap:\"12px\",alignItems:\"center\",borderBottom:\"1px solid rgba(148,163,184,0.08)\"},children:[/*#__PURE__*/_jsx(\"div\",{style:{width:\"52px\",height:\"52px\",borderRadius:\"12px\",background:\"rgba(148,163,184,0.1)\",flexShrink:0,animation:\"pulse 1.5s ease-in-out infinite\"}}),/*#__PURE__*/_jsxs(\"div\",{style:{flex:1},children:[/*#__PURE__*/_jsx(\"div\",{style:{height:\"14px\",width:\"60%\",background:\"rgba(148,163,184,0.1)\",borderRadius:\"4px\",marginBottom:\"8px\",animation:\"pulse 1.5s ease-in-out infinite\"}}),/*#__PURE__*/_jsx(\"div\",{style:{height:\"12px\",width:\"80%\",background:\"rgba(148,163,184,0.08)\",borderRadius:\"4px\",marginBottom:\"6px\",animation:\"pulse 1.5s ease-in-out infinite\",animationDelay:\"0.1s\"}}),/*#__PURE__*/_jsx(\"div\",{style:{height:\"10px\",width:\"40%\",background:\"rgba(148,163,184,0.06)\",borderRadius:\"4px\",animation:\"pulse 1.5s ease-in-out infinite\",animationDelay:\"0.2s\"}})]})]},i))}):messages.length===0&&!loading?/*#__PURE__*/_jsxs(\"div\",{style:{padding:\"60px 20px\",textAlign:\"center\",color:\"#64748b\"},children:[/*#__PURE__*/_jsx(\"div\",{style:{fontSize:\"40px\",marginBottom:\"12px\",opacity:0.5},children:/*#__PURE__*/_jsx(\"svg\",{width:\"48\",height:\"48\",viewBox:\"0 0 24 24\",fill:\"none\",stroke:\"currentColor\",strokeWidth:\"1.5\",style:{margin:\"0 auto\",display:\"block\",color:\"#475569\"},children:/*#__PURE__*/_jsx(\"path\",{d:\"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z\"})})}),/*#__PURE__*/_jsx(\"div\",{style:{fontSize:\"15px\",fontWeight:600,marginBottom:\"4px\"},children:\"\\u041D\\u0435\\u0442 \\u0441\\u043E\\u043E\\u0431\\u0449\\u0435\\u043D\\u0438\\u0439\"}),/*#__PURE__*/_jsx(\"div\",{style:{fontSize:\"13px\"},children:\"\\u041D\\u0430\\u0436\\u043C\\u0438\\u0442\\u0435 \\\"\\u041E\\u0431\\u043D\\u043E\\u0432\\u0438\\u0442\\u044C\\\" \\u0434\\u043B\\u044F \\u0437\\u0430\\u0433\\u0440\\u0443\\u0437\\u043A\\u0438\"})]}):messages.map(message=>{const rawPreviewImage=getRawMessagePreviewImage(message);const previewImage=toMessageImageSrc(rawPreviewImage,message===null||message===void 0?void 0:message.accountId);const directPreviewImage=normalizePreviewImageUrl(rawPreviewImage);return/*#__PURE__*/_jsxs(\"div\",{className:\"msg-conv-item\",onClick:()=>{markAsRead(message);setSelectedMessage(message);fetchThread(message);},style:{padding:\"14px 20px\",borderBottom:\"1px solid rgba(148,163,184,0.08)\",cursor:\"pointer\",background:(selectedMessage===null||selectedMessage===void 0?void 0:selectedMessage.id)===message.id?\"rgba(59,130,246,0.15)\":message.unread?\"rgba(34,197,94,0.08)\":\"transparent\",borderLeft:(selectedMessage===null||selectedMessage===void 0?void 0:selectedMessage.id)===message.id?\"3px solid #3b82f6\":message.unread?\"3px solid #22c55e\":\"3px solid transparent\",display:\"flex\",alignItems:\"flex-start\",gap:\"12px\",transition:\"background 0.15s ease\",animation:\"fadeIn 0.2s ease\"},children:[/*#__PURE__*/_jsxs(\"div\",{style:{width:\"52px\",height:\"52px\",borderRadius:\"50%\",overflow:\"hidden\",background:\"rgba(15,23,42,0.6)\",border:\"1px solid rgba(148,163,184,0.15)\",display:\"flex\",alignItems:\"center\",justifyContent:\"center\",flexShrink:0},children:[previewImage?/*#__PURE__*/_jsx(\"img\",{src:previewImage,\"data-direct-src\":directPreviewImage||\"\",\"data-fallback-tried\":\"0\",alt:\"\",style:{width:\"100%\",height:\"100%\",objectFit:\"cover\"},loading:\"lazy\",referrerPolicy:\"no-referrer\",onError:e=>{var _imageNode$dataset,_imageNode$dataset2;const imageNode=e.currentTarget;const directSrc=String(((_imageNode$dataset=imageNode.dataset)===null||_imageNode$dataset===void 0?void 0:_imageNode$dataset.directSrc)||\"\").trim();const fallbackTried=((_imageNode$dataset2=imageNode.dataset)===null||_imageNode$dataset2===void 0?void 0:_imageNode$dataset2.fallbackTried)===\"1\";const currentSrc=String(imageNode.getAttribute(\"src\")||\"\").trim();if(!fallbackTried&&directSrc&&directSrc!==currentSrc){imageNode.dataset.fallbackTried=\"1\";imageNode.setAttribute(\"src\",directSrc);return;}imageNode.style.display=\"none\";const fallbackNode=imageNode.nextElementSibling;if(fallbackNode)fallbackNode.style.display=\"flex\";}}):null,/*#__PURE__*/_jsx(\"div\",{style:{width:\"100%\",height:\"100%\",background:message.unread?\"linear-gradient(135deg, #22c55e, #16a34a)\":\"linear-gradient(135deg, #3b82f6, #2563eb)\",color:\"white\",display:previewImage?\"none\":\"flex\",alignItems:\"center\",justifyContent:\"center\",fontSize:\"20px\",fontWeight:700},children:(message.sender||\"?\").charAt(0).toUpperCase()})]}),/*#__PURE__*/_jsxs(\"div\",{style:{flex:1,minWidth:0},children:[/*#__PURE__*/_jsxs(\"div\",{style:{display:\"flex\",justifyContent:\"space-between\",alignItems:\"center\",marginBottom:\"3px\"},children:[/*#__PURE__*/_jsx(\"span\",{style:{fontWeight:700,fontSize:\"14px\",color:\"#f1f5f9\",overflow:\"hidden\",textOverflow:\"ellipsis\",whiteSpace:\"nowrap\",maxWidth:\"65%\"},children:message.sender||\"Неизвестный\"}),/*#__PURE__*/_jsx(\"span\",{style:{fontSize:\"11px\",color:\"#64748b\",whiteSpace:\"nowrap\",flexShrink:0},children:getTimeAgo(message.date,message.time)})]}),/*#__PURE__*/_jsx(\"div\",{style:{fontSize:\"13px\",color:\"#94a3b8\",fontWeight:600,overflow:\"hidden\",textOverflow:\"ellipsis\",whiteSpace:\"nowrap\",marginBottom:\"3px\"},children:message.adTitle||\"Без названия\"}),/*#__PURE__*/_jsx(\"div\",{style:{fontSize:\"12px\",color:\"#64748b\",overflow:\"hidden\",textOverflow:\"ellipsis\",whiteSpace:\"nowrap\",marginBottom:\"4px\"},children:message.message||\"\"}),/*#__PURE__*/_jsxs(\"div\",{style:{display:\"flex\",alignItems:\"center\",gap:\"6px\"},children:[/*#__PURE__*/_jsx(\"span\",{style:{fontSize:\"11px\",color:\"#475569\",background:\"rgba(148,163,184,0.1)\",padding:\"1px 6px\",borderRadius:\"4px\"},children:message.accountName}),message.unread&&/*#__PURE__*/_jsx(\"span\",{style:{padding:\"3px 10px\",background:\"linear-gradient(135deg, #8b5cf6, #7c3aed)\",color:\"white\",borderRadius:\"9999px\",fontSize:\"10px\",fontWeight:700,textTransform:\"uppercase\",letterSpacing:\"0.5px\",boxShadow:\"0 0 10px rgba(139, 92, 246, 0.4)\",border:\"1px solid rgba(139, 92, 246, 0.3)\"},children:\"new\"})]})]})]},message.id);})}),messages.length>0&&/*#__PURE__*/_jsxs(\"div\",{style:{padding:\"8px 20px\",borderTop:\"1px solid rgba(148,163,184,0.1)\",fontSize:\"11px\",color:\"#475569\",textAlign:\"center\",background:\"rgba(15,23,42,0.3)\"},children:[messages.length,\" \",messages.length===1?\"диалог\":messages.length<5?\"диалога\":\"диалогов\"]})]}),/*#__PURE__*/_jsx(\"div\",{className:\"messages-chat\",style:_objectSpread({flex:1,position:\"relative\",background:\"linear-gradient(145deg, rgba(30, 41, 59, 0.6) 0%, rgba(15, 23, 42, 0.95) 100%)\",borderRadius:\"20px\",overflow:\"hidden\",boxShadow:\"0 20px 50px rgba(0,0,0,0.4), 0 0 30px rgba(0,0,0,0.2)\",border:\"1px solid rgba(148,163,184,0.12)\",display:\"flex\",flexDirection:\"column\",color:\"#e2e8f0\",backdropFilter:\"blur(10px)\"},showChatPanel?{}:{display:\"none\"}),children:selectedMessage?/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(\"div\",{style:{padding:\"14px 20px\",borderBottom:\"1px solid rgba(148,163,184,0.15)\",background:\"rgba(15,23,42,0.6)\"},children:/*#__PURE__*/_jsxs(\"div\",{style:{display:\"flex\",justifyContent:\"space-between\",alignItems:\"center\"},children:[/*#__PURE__*/_jsxs(\"div\",{style:{display:\"flex\",gap:\"14px\",alignItems:\"center\",flex:1,minWidth:0},children:[/*#__PURE__*/_jsx(\"div\",{style:{width:\"50px\",height:\"50px\",borderRadius:\"10px\",overflow:\"hidden\",border:\"1px solid rgba(148,163,184,0.15)\",background:\"rgba(15,23,42,0.8)\",flexShrink:0,display:\"flex\",alignItems:\"center\",justifyContent:\"center\"},children:selectedPreviewImage?/*#__PURE__*/_jsx(\"img\",{src:selectedPreviewImage,\"data-direct-src\":selectedDirectPreviewImage||\"\",\"data-fallback-tried\":\"0\",alt:\"\",style:{width:\"100%\",height:\"100%\",objectFit:\"cover\"},onError:e=>{var _imageNode$dataset3,_imageNode$dataset4;const imageNode=e.currentTarget;const directSrc=String(((_imageNode$dataset3=imageNode.dataset)===null||_imageNode$dataset3===void 0?void 0:_imageNode$dataset3.directSrc)||\"\").trim();const fallbackTried=((_imageNode$dataset4=imageNode.dataset)===null||_imageNode$dataset4===void 0?void 0:_imageNode$dataset4.fallbackTried)===\"1\";const currentSrc=String(imageNode.getAttribute(\"src\")||\"\").trim();if(!fallbackTried&&directSrc&&directSrc!==currentSrc){imageNode.dataset.fallbackTried=\"1\";imageNode.setAttribute(\"src\",directSrc);return;}imageNode.style.display=\"none\";}}):/*#__PURE__*/_jsxs(\"svg\",{width:\"24\",height:\"24\",viewBox:\"0 0 24 24\",fill:\"none\",stroke:\"#475569\",strokeWidth:\"1.5\",children:[/*#__PURE__*/_jsx(\"rect\",{x:\"3\",y:\"3\",width:\"18\",height:\"18\",rx:\"2\",ry:\"2\"}),/*#__PURE__*/_jsx(\"circle\",{cx:\"8.5\",cy:\"8.5\",r:\"1.5\"}),/*#__PURE__*/_jsx(\"polyline\",{points:\"21 15 16 10 5 21\"})]})}),/*#__PURE__*/_jsxs(\"div\",{style:{minWidth:0},children:[/*#__PURE__*/_jsx(\"div\",{style:{fontWeight:700,fontSize:\"15px\",color:\"#f1f5f9\",overflow:\"hidden\",textOverflow:\"ellipsis\",whiteSpace:\"nowrap\"},children:selectedMessage.sender||\"Неизвестный\"}),/*#__PURE__*/_jsx(\"div\",{style:{fontSize:\"13px\",color:\"#94a3b8\",fontWeight:500,overflow:\"hidden\",textOverflow:\"ellipsis\",whiteSpace:\"nowrap\",marginTop:\"2px\"},children:selectedMessage.adTitle||\"Без названия\"}),/*#__PURE__*/_jsx(\"div\",{style:{fontSize:\"11px\",color:\"#475569\",marginTop:\"2px\"},children:selectedMessage.accountName})]})]}),/*#__PURE__*/_jsx(\"button\",{onClick:()=>setSelectedMessage(null),style:{background:\"rgba(148,163,184,0.1)\",border:\"none\",width:isMobileView?\"auto\":\"32px\",height:\"32px\",padding:isMobileView?\"0 10px\":0,borderRadius:\"8px\",cursor:\"pointer\",color:\"#94a3b8\",display:\"flex\",alignItems:\"center\",justifyContent:\"center\",fontSize:\"16px\",fontWeight:600,flexShrink:0},children:isMobileView?\"← Назад\":/*#__PURE__*/_jsxs(\"svg\",{width:\"16\",height:\"16\",viewBox:\"0 0 24 24\",fill:\"none\",stroke:\"currentColor\",strokeWidth:\"2.5\",strokeLinecap:\"round\",children:[/*#__PURE__*/_jsx(\"line\",{x1:\"18\",y1:\"6\",x2:\"6\",y2:\"18\"}),/*#__PURE__*/_jsx(\"line\",{x1:\"6\",y1:\"6\",x2:\"18\",y2:\"18\"})]})})]})}),/*#__PURE__*/_jsx(\"div\",{ref:chatScrollRef,style:{flex:1,padding:\"20px\",overflow:\"auto\",background:\"rgba(8,12,24,0.4)\"},children:loadingThread?/*#__PURE__*/_jsxs(\"div\",{style:{display:\"flex\",flexDirection:\"column\",alignItems:\"center\",justifyContent:\"center\",height:\"100%\",gap:\"12px\",color:\"#64748b\"},children:[/*#__PURE__*/_jsx(Spinner,{size:32,color:\"#3b82f6\"}),/*#__PURE__*/_jsx(\"span\",{style:{fontSize:\"14px\"},children:\"\\u0417\\u0430\\u0433\\u0440\\u0443\\u0437\\u043A\\u0430 \\u0434\\u0438\\u0430\\u043B\\u043E\\u0433\\u0430...\"})]}):threadMessages.length===0?/*#__PURE__*/_jsx(\"div\",{style:{color:\"#64748b\",textAlign:\"center\",paddingTop:\"40px\"},children:/*#__PURE__*/_jsx(\"div\",{style:{fontSize:\"14px\"},children:\"\\u041D\\u0435\\u0442 \\u0441\\u043E\\u043E\\u0431\\u0449\\u0435\\u043D\\u0438\\u0439 \\u0432 \\u044D\\u0442\\u043E\\u043C \\u0434\\u0438\\u0430\\u043B\\u043E\\u0433\\u0435\"})}):/*#__PURE__*/_jsx(_Fragment,{children:threadMessages.map((messageItem,idx)=>{const isOutgoing=messageItem.direction===\"outgoing\";const isPending=Boolean(messageItem.pending);const isOffer=isPaymentAndShippingMessage(messageItem);const messageKey=String(messageItem.id||\"idx-\".concat(idx));const translation=translationByMessageId[messageKey]||null;const hasText=Boolean(String(messageItem.text||\"\").trim());const attachmentSrcs=extractAttachmentUrls(messageItem).map(url=>toMessageImageSrc(url,selectedMessage===null||selectedMessage===void 0?void 0:selectedMessage.accountId)).filter(Boolean);const canTranslate=!isOffer&&!isOutgoing&&hasText;const toggleTranslate=async()=>{if(!canTranslate)return;// Toggle off when already shown.\nif(translation!==null&&translation!==void 0&&translation.shown&&translation!==null&&translation!==void 0&&translation.translatedText){setTranslationByMessageId(prev=>_objectSpread(_objectSpread({},prev),{},{[messageKey]:_objectSpread(_objectSpread({},prev[messageKey]),{},{shown:false})}));return;}// Toggle on when already fetched.\nif(translation!==null&&translation!==void 0&&translation.translatedText&&!(translation!==null&&translation!==void 0&&translation.loading)){setTranslationByMessageId(prev=>_objectSpread(_objectSpread({},prev),{},{[messageKey]:_objectSpread(_objectSpread({},prev[messageKey]),{},{shown:true,error:\"\"})}));return;}if(translateInFlight.current.has(messageKey))return;translateInFlight.current.add(messageKey);setTranslationByMessageId(prev=>_objectSpread(_objectSpread({},prev),{},{[messageKey]:_objectSpread(_objectSpread({},prev[messageKey]),{},{loading:true,shown:true,error:\"\"})}));try{const result=await apiFetchJson(\"/api/translate\",{method:\"POST\",headers:{\"Content-Type\":\"application/json\"},body:JSON.stringify({text:String(messageItem.text||\"\"),to:\"ru\",accountId:selectedMessage===null||selectedMessage===void 0?void 0:selectedMessage.accountId})});setTranslationByMessageId(prev=>_objectSpread(_objectSpread({},prev),{},{[messageKey]:{loading:false,shown:true,error:\"\",translatedText:(result===null||result===void 0?void 0:result.translatedText)||\"\"}}));}catch(error){console.error(\"Ошибка перевода:\",error);setTranslationByMessageId(prev=>_objectSpread(_objectSpread({},prev),{},{[messageKey]:{loading:false,shown:true,translatedText:\"\",error:(error===null||error===void 0?void 0:error.message)||\"Не удалось перевести\"}}));}finally{translateInFlight.current.delete(messageKey);}};const offerTitle=String((messageItem===null||messageItem===void 0?void 0:messageItem.title)||\"Anfrage erhalten\").trim()||\"Anfrage erhalten\";const offerItemCents=pickOfferField(messageItem,\"itemPriceInEuroCent\");const offerShippingCents=pickOfferField(messageItem,\"shippingCostInEuroCent\");const offerTotalCents=pickOfferField(messageItem,\"sellerTotalInEuroCent\");const offerCarrierName=pickOfferField(messageItem,\"carrierName\");const offerOptionName=pickOfferField(messageItem,\"shippingOptionName\");const offerOptionDesc=pickOfferField(messageItem,\"shippingOptionDescription\");const offerLiabilityCents=pickOfferField(messageItem,\"liabilityLimitInEuroCent\");const acceptCta=getOfferActionText(messageItem,\"ACCEPT_BUYER_OFFER_LEARN_MORE_ACTION\",\"Anfrage akzeptieren\");const declineCta=getOfferActionText(messageItem,\"CANCEL_OFFER_ACTION\",\"Anfrage ablehnen\");const counterCta=getOfferActionText(messageItem,\"MAKE_COUNTER_OFFER_ACTION\",\"Gegenangebot machen\");return/*#__PURE__*/_jsx(\"div\",{style:{marginBottom:\"12px\",display:\"flex\",justifyContent:isOutgoing?\"flex-end\":\"flex-start\",animation:\"fadeIn 0.2s ease\"},children:/*#__PURE__*/_jsxs(\"div\",{style:{maxWidth:isOffer?\"520px\":\"70%\",minWidth:isOffer?\"240px\":\"120px\"},children:[/*#__PURE__*/_jsx(\"div\",{style:{fontSize:\"11px\",color:isOutgoing?\"#86efac\":\"#7dd3fc\",fontWeight:600,marginBottom:\"4px\",paddingLeft:isOutgoing?\"0\":\"12px\",paddingRight:isOutgoing?\"12px\":\"0\",textAlign:isOutgoing?\"right\":\"left\"},children:messageItem.sender||(isOutgoing?\"Вы\":selectedMessage.sender||\"\")}),isOffer?/*#__PURE__*/_jsxs(\"div\",{style:{borderRadius:\"18px\",padding:\"14px 14px 12px 14px\",background:\"linear-gradient(145deg, rgba(2,6,23,0.55) 0%, rgba(15,23,42,0.95) 58%, rgba(6,78,59,0.22) 100%)\",border:\"1px solid rgba(34,197,94,0.22)\",boxShadow:\"0 18px 40px rgba(0,0,0,0.45)\"},children:[/*#__PURE__*/_jsxs(\"div\",{style:{display:\"flex\",justifyContent:\"space-between\",alignItems:\"flex-start\",gap:\"12px\",marginBottom:\"12px\"},children:[/*#__PURE__*/_jsxs(\"div\",{style:{display:\"flex\",gap:\"10px\",alignItems:\"center\",minWidth:0},children:[/*#__PURE__*/_jsx(\"div\",{style:{width:\"36px\",height:\"36px\",borderRadius:\"12px\",background:\"rgba(34,197,94,0.18)\",border:\"1px solid rgba(34,197,94,0.25)\",display:\"flex\",alignItems:\"center\",justifyContent:\"center\",flexShrink:0},children:/*#__PURE__*/_jsx(\"span\",{style:{color:\"#4ade80\",fontWeight:900,fontSize:\"16px\"},children:\"\\u20AC\"})}),/*#__PURE__*/_jsxs(\"div\",{style:{minWidth:0},children:[/*#__PURE__*/_jsx(\"div\",{style:{fontSize:\"14px\",fontWeight:800,color:\"#bbf7d0\",overflow:\"hidden\",textOverflow:\"ellipsis\",whiteSpace:\"nowrap\"},children:offerTitle}),/*#__PURE__*/_jsx(\"div\",{style:{fontSize:\"12px\",color:\"rgba(148,163,184,0.9)\",marginTop:\"1px\"},children:\"Sicher bezahlen\"})]})]}),/*#__PURE__*/_jsx(\"div\",{style:{fontSize:\"20px\",fontWeight:900,color:\"#4ade80\",whiteSpace:\"nowrap\"},children:formatEuroFromCents(offerTotalCents)})]}),/*#__PURE__*/_jsxs(\"div\",{style:{display:\"flex\",flexDirection:\"column\",gap:\"8px\"},children:[/*#__PURE__*/_jsxs(\"div\",{style:{display:\"flex\",justifyContent:\"space-between\",color:\"rgba(226,232,240,0.92)\",fontSize:\"13px\"},children:[/*#__PURE__*/_jsx(\"span\",{style:{color:\"rgba(148,163,184,0.95)\"},children:\"Betrag\"}),/*#__PURE__*/_jsx(\"span\",{style:{fontWeight:700},children:formatEuroFromCents(offerItemCents)})]}),/*#__PURE__*/_jsxs(\"div\",{style:{display:\"flex\",justifyContent:\"space-between\",color:\"rgba(226,232,240,0.92)\",fontSize:\"13px\"},children:[/*#__PURE__*/_jsx(\"span\",{style:{color:\"rgba(148,163,184,0.95)\"},children:\"Versand\"}),/*#__PURE__*/_jsx(\"span\",{style:{fontWeight:700},children:formatEuroFromCents(offerShippingCents)})]}),/*#__PURE__*/_jsxs(\"div\",{style:{display:\"flex\",justifyContent:\"space-between\",fontSize:\"13px\",paddingTop:\"6px\",borderTop:\"1px solid rgba(148,163,184,0.12)\"},children:[/*#__PURE__*/_jsx(\"span\",{style:{color:\"rgba(148,163,184,0.95)\",fontWeight:800},children:\"Gesamt\"}),/*#__PURE__*/_jsx(\"span\",{style:{fontWeight:900,color:\"#e2e8f0\"},children:formatEuroFromCents(offerTotalCents)})]})]}),offerCarrierName||offerOptionName||offerOptionDesc?/*#__PURE__*/_jsxs(\"div\",{style:{marginTop:\"12px\",padding:\"12px\",borderRadius:\"14px\",background:\"rgba(2,6,23,0.25)\",border:\"1px solid rgba(148,163,184,0.14)\"},children:[/*#__PURE__*/_jsxs(\"div\",{style:{fontSize:\"13px\",fontWeight:800,color:\"#e2e8f0\"},children:[\"Inkl. \",offerCarrierName||\"Versand\",\" \",offerOptionName||\"\"]}),offerOptionDesc?/*#__PURE__*/_jsx(\"div\",{style:{marginTop:\"4px\",fontSize:\"12px\",color:\"rgba(148,163,184,0.95)\"},children:offerOptionDesc}):null,offerLiabilityCents?/*#__PURE__*/_jsxs(\"div\",{style:{marginTop:\"6px\",fontSize:\"12px\",color:\"rgba(148,163,184,0.95)\"},children:[\"Mit Sendungsverfolgung und Haftung bis \",formatEuroFromCents(offerLiabilityCents)]}):null]}):null,hasText?/*#__PURE__*/_jsx(\"div\",{style:{marginTop:\"12px\",fontSize:\"13px\",lineHeight:\"1.5\",color:\"rgba(226,232,240,0.92)\"},children:messageItem.text}):null,/*#__PURE__*/_jsxs(\"div\",{style:{marginTop:\"12px\",display:\"flex\",flexDirection:\"column\",gap:\"10px\"},children:[/*#__PURE__*/_jsx(\"button\",{type:\"button\",disabled:true,style:{width:\"100%\",padding:\"10px 14px\",borderRadius:\"9999px\",border:\"1px solid rgba(34,197,94,0.32)\",background:\"linear-gradient(135deg, rgba(34,197,94,0.55), rgba(22,163,74,0.45))\",color:\"rgba(255,255,255,0.95)\",fontWeight:900,cursor:\"not-allowed\",opacity:0.75},title:\"\\u0421\\u043A\\u043E\\u0440\\u043E\",children:acceptCta}),/*#__PURE__*/_jsxs(\"div\",{style:{display:\"flex\",gap:\"10px\"},children:[/*#__PURE__*/_jsx(\"button\",{type:\"button\",onClick:()=>setDeclineConfirmOpen(true),disabled:decliningOffer,style:{flex:1,padding:\"10px 14px\",borderRadius:\"9999px\",border:\"1px solid rgba(148,163,184,0.28)\",background:\"rgba(2,6,23,0.35)\",color:\"rgba(226,232,240,0.95)\",fontWeight:800,cursor:decliningOffer?\"not-allowed\":\"pointer\",opacity:decliningOffer?0.7:1},children:declineCta}),/*#__PURE__*/_jsx(\"button\",{type:\"button\",disabled:true,style:{flex:1,padding:\"10px 14px\",borderRadius:\"9999px\",border:\"1px solid rgba(148,163,184,0.22)\",background:\"rgba(2,6,23,0.25)\",color:\"rgba(148,163,184,0.95)\",fontWeight:800,cursor:\"not-allowed\",opacity:0.75},title:\"\\u0421\\u043A\\u043E\\u0440\\u043E\",children:counterCta})]})]}),/*#__PURE__*/_jsx(\"div\",{style:{fontSize:\"10px\",color:\"rgba(148,163,184,0.8)\",marginTop:\"10px\",textAlign:\"right\"},children:isPending?\"Отправка...\":formatMessageDate(messageItem.date||selectedMessage.date,messageItem.time||selectedMessage.time)})]}):/*#__PURE__*/_jsxs(\"div\",{style:{position:\"relative\",padding:canTranslate?\"10px 14px 18px 14px\":\"10px 14px\",borderRadius:isOutgoing?\"14px 14px 4px 14px\":\"14px 14px 14px 4px\",background:isOutgoing?\"linear-gradient(135deg, #1a4731, #14532d)\":\"rgba(15,23,42,0.8)\",border:isOutgoing?\"1px solid rgba(34,197,94,0.25)\":\"1px solid rgba(148,163,184,0.15)\"},children:[attachmentSrcs.length>0&&/*#__PURE__*/_jsx(\"div\",{style:{display:\"grid\",gridTemplateColumns:\"repeat(auto-fit, minmax(120px, 1fr))\",gap:\"8px\",marginBottom:hasText?\"8px\":\"0\"},children:attachmentSrcs.map((src,imageIdx)=>/*#__PURE__*/_jsx(\"img\",{src:src,alt:\"\",loading:\"lazy\",referrerPolicy:\"no-referrer\",style:{width:\"100%\",maxHeight:\"220px\",objectFit:\"cover\",borderRadius:\"12px\",border:\"1px solid rgba(148,163,184,0.14)\"}},\"\".concat(messageKey,\"-img-\").concat(imageIdx)))}),hasText?/*#__PURE__*/_jsx(\"div\",{style:{fontSize:\"14px\",lineHeight:\"1.5\",whiteSpace:\"pre-wrap\",wordBreak:\"break-word\",color:\"#e2e8f0\"},children:messageItem.text}):null,canTranslate&&/*#__PURE__*/_jsx(\"button\",{type:\"button\",className:\"msg-translate-btn\",onClick:toggleTranslate,title:\"\\u041F\\u0435\\u0440\\u0435\\u0432\\u0435\\u0441\\u0442\\u0438 \\u043D\\u0430 \\u0440\\u0443\\u0441\\u0441\\u043A\\u0438\\u0439\",style:{position:\"absolute\",left:\"8px\",bottom:\"6px\",width:\"22px\",height:\"22px\",borderRadius:\"8px\",border:\"1px solid rgba(148,163,184,0.18)\",background:\"rgba(2,6,23,0.25)\",color:\"#94a3b8\",display:\"inline-flex\",alignItems:\"center\",justifyContent:\"center\",cursor:\"pointer\",opacity:0.75,transition:\"transform 0.12s ease, opacity 0.12s ease, background 0.12s ease\"},children:/*#__PURE__*/_jsxs(\"svg\",{width:\"14\",height:\"14\",viewBox:\"0 0 24 24\",fill:\"none\",stroke:\"currentColor\",strokeWidth:\"2.2\",strokeLinecap:\"round\",strokeLinejoin:\"round\",children:[/*#__PURE__*/_jsx(\"path\",{d:\"M5 5h6\"}),/*#__PURE__*/_jsx(\"path\",{d:\"M8 5c0 6-3 10-6 12\"}),/*#__PURE__*/_jsx(\"path\",{d:\"M7 13c2 2 4 4 7 6\"}),/*#__PURE__*/_jsx(\"path\",{d:\"M14 19h7\"}),/*#__PURE__*/_jsx(\"path\",{d:\"M17 4l4 15\"}),/*#__PURE__*/_jsx(\"path\",{d:\"M20 19l-3-9-3 9\"})]})}),(translation===null||translation===void 0?void 0:translation.shown)&&/*#__PURE__*/_jsx(\"div\",{style:{marginTop:\"10px\",paddingTop:\"8px\",borderTop:\"1px dashed rgba(148,163,184,0.18)\",fontSize:\"13px\",lineHeight:\"1.45\",color:translation!==null&&translation!==void 0&&translation.error?\"#fb7185\":\"#cbd5e1\",opacity:0.95},children:translation!==null&&translation!==void 0&&translation.loading?/*#__PURE__*/_jsx(\"span\",{style:{color:\"#94a3b8\"},children:\"\\u041F\\u0435\\u0440\\u0435\\u0432\\u043E\\u0434...\"}):translation!==null&&translation!==void 0&&translation.error?/*#__PURE__*/_jsx(\"span\",{children:translation.error}):/*#__PURE__*/_jsx(\"span\",{children:translation.translatedText})}),/*#__PURE__*/_jsx(\"div\",{style:{fontSize:\"10px\",color:\"#64748b\",marginTop:\"6px\",textAlign:\"right\"},children:isPending?\"Отправка...\":formatMessageDate(messageItem.date||selectedMessage.date,messageItem.time||selectedMessage.time)})]})]})},messageItem.id||idx);})})}),/*#__PURE__*/_jsxs(\"div\",{style:{padding:\"14px 20px\",borderTop:\"1px solid rgba(148,163,184,0.15)\",background:\"rgba(15,23,42,0.6)\"},children:[/*#__PURE__*/_jsx(\"input\",{ref:fileInputRef,type:\"file\",accept:\"image/*\",multiple:true,onChange:handleReplyImageSelect,style:{display:\"none\"}}),replyImages.length>0&&/*#__PURE__*/_jsx(\"div\",{style:{marginBottom:\"10px\",display:\"flex\",gap:\"8px\",overflowX:\"auto\",paddingBottom:\"2px\"},children:replyImages.map(item=>/*#__PURE__*/_jsxs(\"div\",{style:{position:\"relative\",width:\"72px\",height:\"72px\",borderRadius:\"10px\",border:\"1px solid rgba(148,163,184,0.2)\",overflow:\"hidden\",flexShrink:0},children:[/*#__PURE__*/_jsx(\"img\",{src:item.previewUrl,alt:\"\",style:{width:\"100%\",height:\"100%\",objectFit:\"cover\"}}),/*#__PURE__*/_jsx(\"button\",{type:\"button\",onClick:()=>removeReplyImage(item.id),style:{position:\"absolute\",top:\"4px\",right:\"4px\",width:\"20px\",height:\"20px\",borderRadius:\"9999px\",border:\"none\",background:\"rgba(2,6,23,0.72)\",color:\"#f8fafc\",fontSize:\"12px\",cursor:\"pointer\",display:\"flex\",alignItems:\"center\",justifyContent:\"center\"},title:\"\\u0423\\u0434\\u0430\\u043B\\u0438\\u0442\\u044C\",children:\"\\xD7\"})]},item.id))}),/*#__PURE__*/_jsxs(\"div\",{style:{display:\"flex\",gap:\"10px\",alignItems:\"flex-end\"},children:[/*#__PURE__*/_jsx(\"button\",{type:\"button\",onClick:()=>{var _fileInputRef$current;return(_fileInputRef$current=fileInputRef.current)===null||_fileInputRef$current===void 0?void 0:_fileInputRef$current.click();},disabled:sending,\"aria-label\":\"Bilder hochladen\",style:{width:\"42px\",height:\"42px\",borderRadius:\"12px\",border:\"1px solid rgba(148,163,184,0.25)\",background:\"rgba(15,23,42,0.7)\",color:\"#cbd5e1\",cursor:sending?\"not-allowed\":\"pointer\",display:\"flex\",alignItems:\"center\",justifyContent:\"center\",flexShrink:0},children:/*#__PURE__*/_jsxs(\"svg\",{viewBox:\"0 0 24 24\",width:\"18\",height:\"18\",fill:\"currentColor\",\"aria-hidden\":\"true\",children:[/*#__PURE__*/_jsx(\"path\",{d:\"M12.0004 8.54376C9.72753 8.54376 7.88501 10.4042 7.88501 12.6991C7.88501 14.994 9.72753 16.8544 12.0004 16.8544C14.2733 16.8544 16.1158 14.994 16.1158 12.6991C16.1158 10.4042 14.2733 8.54376 12.0004 8.54376ZM9.88501 12.6991C9.88501 11.5195 10.8321 10.5632 12.0004 10.5632C13.1687 10.5632 14.1158 11.5195 14.1158 12.6991C14.1158 13.8787 13.1687 14.835 12.0004 14.835C10.8321 14.835 9.88501 13.8787 9.88501 12.6991Z\"}),/*#__PURE__*/_jsx(\"path\",{d:\"M9.23077 4C8.91601 4 8.61962 4.14963 8.43077 4.40388L6.65385 6.79612H4.38462C3.75218 6.79612 3.14564 7.04979 2.69844 7.50134C2.25124 7.95288 2 8.5653 2 9.20388V17.5922C2 18.2308 2.25124 18.8432 2.69844 19.2948C3.14564 19.7463 3.75218 20 4.38462 20H19.6154C20.2478 20 20.8544 19.7463 21.3016 19.2948C21.7488 18.8432 22 18.2308 22 17.5922V9.20388C22 8.5653 21.7488 7.95288 21.3016 7.50134C20.8544 7.04979 20.2478 6.79612 19.6154 6.79612H17.3462L15.5692 4.40388C15.3804 4.14963 15.084 4 14.7692 4H9.23077ZM7.95385 8.41165L9.73077 6.01942H14.2692L16.0462 8.41165C16.235 8.6659 16.5314 8.81553 16.8462 8.81553H19.6154C19.7179 8.81553 19.8163 8.85665 19.8888 8.9292C19.9614 9.00175 20.0025 9.10014 20.0025 9.20263V17.5909C20.0025 17.6934 19.9614 17.7918 19.8888 17.8644C19.8163 17.9369 19.7179 17.978 19.6154 17.978H4.38462C4.28208 17.978 4.1837 17.9369 4.11115 17.8644C4.0386 17.7918 3.99748 17.6934 3.99748 17.5909V9.20263C3.99748 9.10014 4.0386 9.00175 4.11115 8.9292C4.1837 8.85665 4.28208 8.81553 4.38462 8.81553H7.15385C7.4686 8.81553 7.765 8.6659 7.95385 8.41165Z\"})]})}),/*#__PURE__*/_jsx(\"textarea\",{value:replyText,onChange:e=>setReplyText(e.target.value),onKeyDown:handleKeyDown,placeholder:\"Nachricht schreiben...\",rows:1,style:{flex:1,padding:\"10px 14px\",border:\"1px solid rgba(148,163,184,0.2)\",borderRadius:\"12px\",resize:\"none\",minHeight:\"42px\",maxHeight:\"120px\",background:\"rgba(15,23,42,0.6)\",color:\"#e2e8f0\",fontSize:\"14px\",lineHeight:\"1.4\",outline:\"none\",fontFamily:\"inherit\"},onInput:e=>{e.target.style.height=\"42px\";e.target.style.height=Math.min(e.target.scrollHeight,120)+\"px\";}}),/*#__PURE__*/_jsx(\"button\",{className:\"msg-send-btn\",onClick:sendReply,disabled:!canSendReply,style:{padding:\"10px 20px\",background:sending?\"rgba(34,197,94,0.4)\":!hasReplyPayload?\"rgba(148,163,184,0.15)\":\"linear-gradient(135deg, #22c55e, #16a34a)\",color:!hasReplyPayload?\"#64748b\":\"white\",border:\"none\",borderRadius:\"12px\",cursor:!canSendReply?\"not-allowed\":\"pointer\",whiteSpace:\"nowrap\",fontSize:\"14px\",fontWeight:600,display:\"flex\",alignItems:\"center\",gap:\"6px\",height:\"42px\",transition:\"all 0.15s ease\"},children:sending?/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(Spinner,{size:14,color:\"#fff\"}),/*#__PURE__*/_jsx(\"span\",{children:\"\\u041E\\u0442\\u043F\\u0440\\u0430\\u0432\\u043A\\u0430\"})]}):/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsxs(\"svg\",{width:\"16\",height:\"16\",viewBox:\"0 0 24 24\",fill:\"none\",stroke:\"currentColor\",strokeWidth:\"2.5\",strokeLinecap:\"round\",strokeLinejoin:\"round\",children:[/*#__PURE__*/_jsx(\"line\",{x1:\"22\",y1:\"2\",x2:\"11\",y2:\"13\"}),/*#__PURE__*/_jsx(\"polygon\",{points:\"22 2 15 22 11 13 2 9 22 2\"})]}),/*#__PURE__*/_jsx(\"span\",{children:\"\\u041E\\u0442\\u043F\\u0440\\u0430\\u0432\\u0438\\u0442\\u044C\"})]})})]}),/*#__PURE__*/_jsx(\"div\",{style:{fontSize:\"11px\",color:\"#475569\",marginTop:\"6px\"},children:\"Enter \\u0434\\u043B\\u044F \\u043E\\u0442\\u043F\\u0440\\u0430\\u0432\\u043A\\u0438, Shift+Enter \\u0434\\u043B\\u044F \\u043D\\u043E\\u0432\\u043E\\u0439 \\u0441\\u0442\\u0440\\u043E\\u043A\\u0438\"})]}),declineConfirmOpen&&/*#__PURE__*/_jsx(\"div\",{style:{position:\"absolute\",inset:0,background:\"rgba(2,6,23,0.65)\",backdropFilter:\"blur(2px)\",display:\"flex\",alignItems:\"center\",justifyContent:\"center\",zIndex:40,padding:\"16px\"},children:/*#__PURE__*/_jsxs(\"div\",{style:{width:\"100%\",maxWidth:\"420px\",borderRadius:\"16px\",border:\"1px solid rgba(148,163,184,0.2)\",background:\"linear-gradient(145deg, rgba(15,23,42,0.96), rgba(2,6,23,0.98))\",boxShadow:\"0 18px 60px rgba(0,0,0,0.5)\",padding:\"18px\"},children:[/*#__PURE__*/_jsx(\"div\",{style:{fontSize:\"16px\",fontWeight:700,color:\"#f8fafc\",marginBottom:\"8px\"},children:\"Anfrage ablehnen\"}),/*#__PURE__*/_jsx(\"div\",{style:{fontSize:\"13px\",lineHeight:\"1.5\",color:\"#94a3b8\",marginBottom:\"16px\"},children:\"M\\xF6chtest du diese Anfrage wirklich ablehnen?\"}),/*#__PURE__*/_jsxs(\"div\",{style:{display:\"flex\",gap:\"10px\",justifyContent:\"flex-end\"},children:[/*#__PURE__*/_jsx(\"button\",{type:\"button\",onClick:()=>setDeclineConfirmOpen(false),disabled:decliningOffer,style:{padding:\"10px 14px\",borderRadius:\"10px\",border:\"1px solid rgba(148,163,184,0.22)\",background:\"rgba(15,23,42,0.65)\",color:\"#cbd5e1\",cursor:decliningOffer?\"not-allowed\":\"pointer\"},children:\"Abbrechen\"}),/*#__PURE__*/_jsx(\"button\",{type:\"button\",onClick:confirmDeclineOffer,disabled:decliningOffer,style:{padding:\"10px 14px\",borderRadius:\"10px\",border:\"1px solid rgba(239,68,68,0.35)\",background:\"linear-gradient(135deg, rgba(239,68,68,0.78), rgba(185,28,28,0.82))\",color:\"#fff\",fontWeight:700,cursor:decliningOffer?\"not-allowed\":\"pointer\",display:\"inline-flex\",alignItems:\"center\",gap:\"6px\",minWidth:\"158px\",justifyContent:\"center\"},children:decliningOffer?/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(Spinner,{size:14,color:\"#fff\"}),/*#__PURE__*/_jsx(\"span\",{children:\"Bitte warten\"})]}):\"Anfrage ablehnen\"})]})]})})]}):/*#__PURE__*/// Empty state\n_jsx(\"div\",{style:{flex:1,display:\"flex\",alignItems:\"center\",justifyContent:\"center\",color:\"#475569\"},children:/*#__PURE__*/_jsxs(\"div\",{style:{textAlign:\"center\",maxWidth:\"280px\"},children:[/*#__PURE__*/_jsx(\"svg\",{width:\"64\",height:\"64\",viewBox:\"0 0 24 24\",fill:\"none\",stroke:\"currentColor\",strokeWidth:\"1\",style:{margin:\"0 auto 16px\",display:\"block\",color:\"#334155\"},children:/*#__PURE__*/_jsx(\"path\",{d:\"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z\"})}),/*#__PURE__*/_jsx(\"h3\",{style:{margin:\"0 0 8px\",fontSize:\"16px\",color:\"#64748b\"},children:\"\\u0412\\u044B\\u0431\\u0435\\u0440\\u0438\\u0442\\u0435 \\u0434\\u0438\\u0430\\u043B\\u043E\\u0433\"}),/*#__PURE__*/_jsx(\"p\",{style:{margin:0,fontSize:\"13px\",lineHeight:\"1.5\"},children:\"\\u0412\\u044B\\u0431\\u0435\\u0440\\u0438\\u0442\\u0435 \\u0434\\u0438\\u0430\\u043B\\u043E\\u0433 \\u0438\\u0437 \\u0441\\u043F\\u0438\\u0441\\u043A\\u0430 \\u0441\\u043B\\u0435\\u0432\\u0430 \\u0434\\u043B\\u044F \\u043F\\u0440\\u043E\\u0441\\u043C\\u043E\\u0442\\u0440\\u0430 \\u0441\\u043E\\u043E\\u0431\\u0449\\u0435\\u043D\\u0438\\u0439 \\u0438 \\u043E\\u0442\\u0432\\u0435\\u0442\\u0430\"})]})})})]})]});};export default MessagesTab;","map":{"version":3,"names":["React","useState","useEffect","useRef","apiFetchJson","getAccessToken","MessageIcon","jsx","_jsx","jsxs","_jsxs","Fragment","_Fragment","SEEN_STORAGE_KEY","THREAD_CACHE_TTL_MS","detectMobileView","_window$screen","window","viewportWidth","innerWidth","document","documentElement","clientWidth","screenWidth","screen","width","effectiveWidth","Math","min","mobileUa","test","navigator","userAgent","hasCoarsePointer","matchMedia","matches","noHover","touchPoints","Number","maxTouchPoints","touchLikeDevice","normalizePreviewImageUrl","value","raw","String","trim","i","length","normalizeRuleForKleinanzeigen","parsed","host","hostname","toLowerCase","isProdAdsImage","pathname","startsWith","ruleParam","searchParams","get","malformedRule","validRule","set","URL","concat","href","_unused","_unused2","toMessageImageSrc","accountId","normalized","accountToken","undefined","accessToken","src","separator","includes","encodeURIComponent","params","URLSearchParams","toString","getRawMessagePreviewImage","message","_message$ad","_message$ad2","_message$ad3","candidates","adImage","adImageUrl","adImageURL","imageUrl","image","thumbnailUrl","thumbnail","previewImage","ad","candidate","getMessagePreviewImage","hasMessagePreviewImage","Boolean","isPaymentAndShippingMessage","type","toUpperCase","paymentAndShippingMessageType","formatEuroFromCents","cents","isFinite","toLocaleString","style","currency","pickOfferField","key","direct","actions","Array","isArray","withKey","find","action","getOfferActionText","actionType","fallback","arguments","item","ctaText","extractAttachmentUrls","buckets","attachments","images","imageUrls","media","pictures","filter","urls","bucket","push","gatewayUrl","url","getConversationKey","convo","conversationId","conversationUrl","id","convoId","getConversationFingerprint","date","time","text","loadSeenMap","localStorage","getItem","JSON","parse","_unused3","saveSeenMap","next","setItem","stringify","_unused4","MessagesTab","_selectedMessage$mess","messages","setMessages","selectedMessage","setSelectedMessage","replyText","setReplyText","replyImages","setReplyImages","sending","setSending","loading","setLoading","loadingThread","setLoadingThread","error","setError","isMobileView","setIsMobileView","translationByMessageId","setTranslationByMessageId","declineConfirmOpen","setDeclineConfirmOpen","decliningOffer","setDecliningOffer","chatScrollRef","fileInputRef","previewHydrationInFlight","Set","messagesRefreshInFlight","translateInFlight","threadCacheRef","Map","clearComposerImages","prev","existing","forEach","previewUrl","revokeObjectURL","getThreadCacheKeyForMessage","readThreadCacheEntry","entry","current","expiresAt","Date","now","delete","writeThreadCacheEntry","payload","adTitle","sender","loadMessages","intervalId","setInterval","visibilityState","silent","clearInterval","container","scrollTo","top","scrollHeight","behavior","handleResize","addEventListener","removeEventListener","hydrateMissingPreviewImages","list","slice","has","add","data","map","msg","sameConversation","_objectSpread","console","rememberConversationSeen","fingerprint","seen","seenAt","msgKey","unread","opts","deduped","seenMap","merged","currentFingerprint","err","markAsRead","handleReplyImageSelect","event","_event$target","files","from","target","nextItems","file","random","createObjectURL","removeReplyImage","formatRequestError","fallbackText","_error$data","_error$data2","baseMessage","debugId","requestId","confirmDeclineOffer","alert","result","method","timeoutMs","headers","body","serverMessages","lastMessage","nextConversationId","nextConversationUrl","fetchThread","force","status","code","sendReply","textToSend","imagesToSend","optimisticId","getTime","optimisticAttachments","_item$file","_item$file2","name","local","previewText","optimisticMessage","toISOString","toTimeString","direction","pending","form","FormData","append","participant","success","resolvedConversationId","resolvedConversationUrl","hasSameOutgoing","some","m","nextMessages","updated","getTimeAgo","messageDate","isNaN","diffHours","floor","_unused5","formatMessageDate","parts","d","diffDays","toLocaleDateString","day","month","_unused6","join","threadMessages","cached","cachedPayload","updatedFromCache","handleKeyDown","e","shiftKey","preventDefault","unreadCount","showConversationList","showChatPanel","selectedRawPreviewImage","selectedPreviewImage","selectedDirectPreviewImage","hasReplyPayload","canSendReply","Spinner","_ref","size","color","height","viewBox","animation","children","cx","cy","r","stroke","strokeWidth","fill","strokeDasharray","strokeDashoffset","strokeLinecap","className","display","alignItems","justifyContent","gap","marginBottom","flexWrap","margin","fontWeight","borderRadius","background","border","boxShadow","minHeight","minWidth","overflow","flexDirection","backdropFilter","padding","borderBottom","fontSize","onClick","disabled","cursor","transition","strokeLinejoin","points","marginTop","flex","flexShrink","animationDelay","textAlign","opacity","rawPreviewImage","directPreviewImage","borderLeft","alt","objectFit","referrerPolicy","onError","_imageNode$dataset","_imageNode$dataset2","imageNode","currentTarget","directSrc","dataset","fallbackTried","currentSrc","getAttribute","setAttribute","fallbackNode","nextElementSibling","charAt","textOverflow","whiteSpace","maxWidth","accountName","textTransform","letterSpacing","borderTop","position","_imageNode$dataset3","_imageNode$dataset4","x","y","rx","ry","x1","y1","x2","y2","ref","paddingTop","messageItem","idx","isOutgoing","isPending","isOffer","messageKey","translation","hasText","attachmentSrcs","canTranslate","toggleTranslate","shown","translatedText","to","offerTitle","title","offerItemCents","offerShippingCents","offerTotalCents","offerCarrierName","offerOptionName","offerOptionDesc","offerLiabilityCents","acceptCta","declineCta","counterCta","paddingLeft","paddingRight","lineHeight","gridTemplateColumns","imageIdx","maxHeight","wordBreak","left","bottom","accept","multiple","onChange","overflowX","paddingBottom","right","_fileInputRef$current","click","onKeyDown","placeholder","rows","resize","outline","fontFamily","onInput","inset","zIndex"],"sources":["/Users/eurocare/Downloads/barvihaluxury-main/frontend/src/components/MessagesTab.jsx"],"sourcesContent":["import React, { useState, useEffect, useRef } from \"react\";\nimport { apiFetchJson, getAccessToken } from \"../api\";\nimport { MessageIcon } from \"./Icons\";\n\nconst SEEN_STORAGE_KEY = \"kl_messages_seen_v1\";\nconst THREAD_CACHE_TTL_MS = 2 * 60 * 1000;\n\nconst detectMobileView = () => {\n  if (typeof window === \"undefined\") return false;\n  const viewportWidth = window.innerWidth || document.documentElement.clientWidth || 0;\n  const screenWidth = typeof window.screen?.width === \"number\" ? window.screen.width : viewportWidth;\n  const effectiveWidth = Math.min(viewportWidth || screenWidth, screenWidth || viewportWidth);\n  const mobileUa = /Android|webOS|iPhone|iPad|iPod|Opera Mini|IEMobile/i.test(\n    (typeof navigator !== \"undefined\" && navigator.userAgent) || \"\"\n  );\n  const hasCoarsePointer = typeof window.matchMedia === \"function\"\n    ? window.matchMedia(\"(pointer: coarse)\").matches\n    : false;\n  const noHover = typeof window.matchMedia === \"function\"\n    ? window.matchMedia(\"(hover: none)\").matches\n    : false;\n  const touchPoints = typeof navigator !== \"undefined\" ? Number(navigator.maxTouchPoints || 0) : 0;\n  const touchLikeDevice = hasCoarsePointer || noHover || touchPoints > 1;\n  return effectiveWidth <= 768 || (touchLikeDevice && effectiveWidth <= 1024) || (mobileUa && effectiveWidth <= 1180);\n};\n\nconst normalizePreviewImageUrl = (value) => {\n  const raw = String(value || \"\").trim();\n  if (!raw) return \"\";\n  if (/^data:/i.test(raw)) {\n    // Kleinanzeigen message attachments can be inlined (data:image/*). Keep small payloads so\n    // sent/received photos still render when we fall back to DOM parsing.\n    if (/^data:image\\\\//i.test(raw) && raw.length <= 250000) return raw;\n    return \"\";\n  }\n  const normalizeRuleForKleinanzeigen = (parsed) => {\n    const host = String(parsed.hostname || \"\").toLowerCase();\n    const isProdAdsImage = host === \"img.kleinanzeigen.de\"\n      && parsed.pathname.startsWith(\"/api/v1/prod-ads/images/\");\n    if (!isProdAdsImage) return parsed;\n    const ruleParam = String(parsed.searchParams.get(\"rule\") || \"\");\n    const malformedRule = /(imageid|\\$\\{.*\\}|\\$_\\{.*\\})/i.test(ruleParam);\n    const validRule = /^\\$_[a-z0-9_.-]+$/i.test(ruleParam);\n    if (!validRule || malformedRule) {\n      parsed.searchParams.set(\"rule\", \"$_57.JPG\");\n    }\n    return parsed;\n  };\n  if (/^(https?:)?\\/\\//i.test(raw)) {\n    try {\n      const parsed = normalizeRuleForKleinanzeigen(new URL(raw.startsWith(\"//\") ? `https:${raw}` : raw));\n      return parsed.href;\n    } catch {\n      return raw.startsWith(\"//\") ? `https:${raw}` : raw;\n    }\n  }\n  if (/^img\\.kleinanzeigen\\.de/i.test(raw)) return normalizePreviewImageUrl(`https://${raw}`);\n  if (/^\\/api\\/v1\\/prod-ads\\/images\\//i.test(raw)) return normalizePreviewImageUrl(`https://img.kleinanzeigen.de${raw}`);\n  try {\n    const parsed = normalizeRuleForKleinanzeigen(new URL(raw, \"https://www.kleinanzeigen.de\"));\n    return parsed.href;\n  } catch {\n    return \"\";\n  }\n};\n\nconst toMessageImageSrc = (value, accountId) => {\n  const normalized = normalizePreviewImageUrl(value);\n  if (!normalized) return \"\";\n  const accountToken = accountId !== undefined && accountId !== null && String(accountId).trim()\n    ? String(accountId).trim()\n    : \"\";\n  const accessToken = getAccessToken();\n  if (normalized.startsWith(\"/api/messages/image?\")) {\n    let src = normalized;\n    if (accountToken && !/[?&]accountId=/i.test(src)) {\n      const separator = src.includes(\"?\") ? \"&\" : \"?\";\n      src = `${src}${separator}accountId=${encodeURIComponent(accountToken)}`;\n    }\n    if (accessToken && !/[?&](accessToken|token)=/i.test(src)) {\n      const separator = src.includes(\"?\") ? \"&\" : \"?\";\n      src = `${src}${separator}accessToken=${encodeURIComponent(accessToken)}`;\n    }\n    return src;\n  }\n  if (/^https?:\\/\\//i.test(normalized)) {\n    if (!accountToken) return normalized;\n    const params = new URLSearchParams();\n    params.set(\"url\", normalized);\n    params.set(\"accountId\", accountToken);\n    if (accessToken) {\n      params.set(\"accessToken\", accessToken);\n    }\n    return `/api/messages/image?${params.toString()}`;\n  }\n  return normalized;\n};\n\nconst getRawMessagePreviewImage = (message) => {\n  if (!message || typeof message !== \"object\") return \"\";\n  const candidates = [\n    message.adImage,\n    message.adImageUrl,\n    message.adImageURL,\n    message.imageUrl,\n    message.image,\n    message.thumbnailUrl,\n    message.thumbnail,\n    message.previewImage,\n    message.ad?.image,\n    message.ad?.imageUrl,\n    message.ad?.thumbnailUrl\n  ];\n  for (const candidate of candidates) {\n    const normalized = normalizePreviewImageUrl(candidate);\n    if (normalized) return normalized;\n  }\n  return \"\";\n};\n\nconst getMessagePreviewImage = (message) =>\n  toMessageImageSrc(getRawMessagePreviewImage(message), message?.accountId);\n\nconst hasMessagePreviewImage = (message) => Boolean(getRawMessagePreviewImage(message));\n\nconst isPaymentAndShippingMessage = (message) => {\n  if (!message || typeof message !== \"object\") return false;\n  const type = String(message.type || \"\").toUpperCase();\n  return type === \"PAYMENT_AND_SHIPPING_MESSAGE\" || Boolean(message.paymentAndShippingMessageType);\n};\n\nconst formatEuroFromCents = (value) => {\n  const cents = Number(value);\n  if (!Number.isFinite(cents)) return \"\";\n  return (cents / 100).toLocaleString(\"de-DE\", { style: \"currency\", currency: \"EUR\" });\n};\n\nconst pickOfferField = (message, key) => {\n  if (!message || typeof message !== \"object\") return null;\n  const direct = message[key];\n  if (direct !== undefined && direct !== null) return direct;\n  const actions = Array.isArray(message.actions) ? message.actions : [];\n  const withKey = actions.find((action) => action && action[key] !== undefined && action[key] !== null);\n  return withKey ? withKey[key] : null;\n};\n\nconst getOfferActionText = (message, actionType, fallback = \"\") => {\n  const actions = Array.isArray(message?.actions) ? message.actions : [];\n  const action = actions.find((item) => item?.actionType === actionType);\n  return action?.ctaText || fallback;\n};\n\nconst extractAttachmentUrls = (message) => {\n  const buckets = [\n    message?.attachments,\n    message?.images,\n    message?.imageUrls,\n    message?.media,\n    message?.pictures\n  ].filter((value) => Array.isArray(value));\n  const urls = [];\n  for (const bucket of buckets) {\n    for (const item of bucket) {\n      if (!item) continue;\n      if (typeof item === \"string\") {\n        urls.push(item);\n        continue;\n      }\n      if (typeof item === \"object\") {\n        // Kleinanzeigen message attachments often need the gateway URL (auth required),\n        // while the api.kleinanzeigen.de URL can return 401.\n        const candidate = item.gatewayUrl\n          || item.url\n          || item.href\n          || item.src\n          || item.imageUrl\n          || item.thumbnailUrl;\n        if (candidate) urls.push(candidate);\n      }\n    }\n  }\n  return urls.filter(Boolean);\n};\n\nconst getConversationKey = (message) => {\n  if (!message || typeof message !== \"object\") return \"\";\n  const accountId = message.accountId != null ? String(message.accountId) : \"\";\n  const convo = message.conversationId || message.conversationUrl || message.id || \"\";\n  const convoId = convo != null ? String(convo) : \"\";\n  if (!accountId || !convoId) return \"\";\n  return `${accountId}|${convoId}`;\n};\n\nconst getConversationFingerprint = (message) => {\n  if (!message || typeof message !== \"object\") return \"\";\n  const date = String(message.date || \"\").trim();\n  const time = String(message.time || \"\").trim();\n  const text = String(message.message || \"\").trim();\n  return `${date}|${time}|${text}`;\n};\n\nconst loadSeenMap = () => {\n  if (typeof window === \"undefined\" || !window.localStorage) return {};\n  try {\n    const raw = window.localStorage.getItem(SEEN_STORAGE_KEY);\n    if (!raw) return {};\n    const parsed = JSON.parse(raw);\n    return parsed && typeof parsed === \"object\" ? parsed : {};\n  } catch {\n    return {};\n  }\n};\n\nconst saveSeenMap = (next) => {\n  if (typeof window === \"undefined\" || !window.localStorage) return;\n  try {\n    window.localStorage.setItem(SEEN_STORAGE_KEY, JSON.stringify(next || {}));\n  } catch {\n    // ignore quota / serialization issues\n  }\n};\n\nconst MessagesTab = () => {\n  const [messages, setMessages] = useState([]);\n  const [selectedMessage, setSelectedMessage] = useState(null);\n  const [replyText, setReplyText] = useState(\"\");\n  const [replyImages, setReplyImages] = useState([]);\n  const [sending, setSending] = useState(false);\n  const [loading, setLoading] = useState(false);\n  const [loadingThread, setLoadingThread] = useState(false);\n  const [error, setError] = useState(null);\n  const [isMobileView, setIsMobileView] = useState(() => detectMobileView());\n  const [translationByMessageId, setTranslationByMessageId] = useState({});\n  const [declineConfirmOpen, setDeclineConfirmOpen] = useState(false);\n  const [decliningOffer, setDecliningOffer] = useState(false);\n  const chatScrollRef = useRef(null);\n  const fileInputRef = useRef(null);\n  const previewHydrationInFlight = useRef(new Set());\n  const messagesRefreshInFlight = useRef(false);\n  const translateInFlight = useRef(new Set());\n  const threadCacheRef = useRef(new Map());\n\n  const clearComposerImages = () => {\n    setReplyImages((prev) => {\n      const existing = Array.isArray(prev) ? prev : [];\n      existing.forEach((item) => {\n        if (item?.previewUrl) {\n          URL.revokeObjectURL(item.previewUrl);\n        }\n      });\n      return [];\n    });\n  };\n\n  const getThreadCacheKeyForMessage = (message) => {\n    if (!message || typeof message !== \"object\") return \"\";\n    const accountId = message.accountId != null ? String(message.accountId) : \"\";\n    const conversationId = message.conversationId != null ? String(message.conversationId) : \"\";\n    const conversationUrl = message.conversationUrl != null ? String(message.conversationUrl) : \"\";\n    if (!accountId) return \"\";\n    if (conversationId) return `${accountId}|cid:${conversationId}`;\n    if (conversationUrl) return `${accountId}|url:${conversationUrl}`;\n    return \"\";\n  };\n\n  const readThreadCacheEntry = (message) => {\n    const key = getThreadCacheKeyForMessage(message);\n    if (!key) return null;\n    const entry = threadCacheRef.current.get(key);\n    if (!entry || typeof entry !== \"object\") return null;\n    if (!entry.expiresAt || entry.expiresAt < Date.now()) {\n      threadCacheRef.current.delete(key);\n      return null;\n    }\n    return entry;\n  };\n\n  const writeThreadCacheEntry = (message, payload) => {\n    const key = getThreadCacheKeyForMessage(message);\n    if (!key || !payload || typeof payload !== \"object\") return;\n    threadCacheRef.current.set(key, {\n      expiresAt: Date.now() + THREAD_CACHE_TTL_MS,\n      payload: {\n        adTitle: payload.adTitle || \"\",\n        adImage: payload.adImage || \"\",\n        sender: payload.sender || \"\",\n        messages: Array.isArray(payload.messages) ? payload.messages : [],\n        conversationId: payload.conversationId || message?.conversationId || \"\",\n        conversationUrl: payload.conversationUrl || message?.conversationUrl || \"\"\n      }\n    });\n  };\n\n  useEffect(() => {\n    loadMessages();\n  }, []);\n\n  useEffect(() => {\n    const intervalId = window.setInterval(() => {\n      // Avoid background polling when the tab is hidden (mobile data / lower load).\n      if (typeof document !== \"undefined\" && document.visibilityState !== \"visible\") return;\n      loadMessages({ silent: true });\n    }, 3 * 60 * 1000);\n\n    return () => window.clearInterval(intervalId);\n  }, []);\n\n  useEffect(() => {\n    if (!selectedMessage) return;\n    const container = chatScrollRef.current;\n    if (!container) return;\n    container.scrollTo({ top: container.scrollHeight, behavior: \"smooth\" });\n  }, [selectedMessage?.id, selectedMessage?.messages]);\n\n  useEffect(() => {\n    // Reset composer state when switching conversations.\n    setReplyText(\"\");\n    clearComposerImages();\n    setDeclineConfirmOpen(false);\n    setDecliningOffer(false);\n  }, [selectedMessage?.id]);\n\n  useEffect(() => {\n    const handleResize = () => {\n      setIsMobileView(detectMobileView());\n    };\n\n    window.addEventListener(\"resize\", handleResize);\n    return () => window.removeEventListener(\"resize\", handleResize);\n  }, []);\n\n  const hydrateMissingPreviewImages = async (list) => {\n    if (!Array.isArray(list) || !list.length) return;\n\n    const candidates = list\n      .filter((item) => item && !hasMessagePreviewImage(item))\n      .slice(0, 10);\n\n    for (const item of candidates) {\n      const key = String(item.conversationId || item.conversationUrl || item.id || \"\");\n      if (!key || previewHydrationInFlight.current.has(key)) continue;\n      previewHydrationInFlight.current.add(key);\n\n      try {\n        const params = new URLSearchParams();\n        if (item.accountId != null) params.set(\"accountId\", String(item.accountId));\n        if (item.conversationId) params.set(\"conversationId\", String(item.conversationId));\n        if (item.conversationUrl) params.set(\"conversationUrl\", String(item.conversationUrl));\n        if (!item.conversationId && !item.conversationUrl) {\n          if (item.sender) params.set(\"participant\", String(item.sender));\n          if (item.adTitle) params.set(\"adTitle\", String(item.adTitle));\n        }\n        if (!params.get(\"accountId\")) continue;\n\n        const data = await apiFetchJson(`/api/messages/thread?${params.toString()}`);\n        const adImage = normalizePreviewImageUrl(data?.adImage);\n        if (!adImage) continue;\n\n        setMessages((prev) => prev.map((msg) => {\n          const sameConversation = (\n            (item.conversationId && msg.conversationId && String(item.conversationId) === String(msg.conversationId))\n            || (item.conversationUrl && msg.conversationUrl && String(item.conversationUrl) === String(msg.conversationUrl))\n            || String(msg.id) === String(item.id)\n          );\n          if (!sameConversation) return msg;\n          return {\n            ...msg,\n            adImage,\n            adTitle: data?.adTitle || msg.adTitle,\n            conversationId: data?.conversationId || msg.conversationId,\n            conversationUrl: data?.conversationUrl || msg.conversationUrl\n          };\n        }));\n      } catch (error) {\n        console.error(\"Не удалось догрузить превью диалога:\", error);\n      } finally {\n        previewHydrationInFlight.current.delete(key);\n      }\n    }\n  };\n\n  const rememberConversationSeen = (message) => {\n    const key = getConversationKey(message);\n    if (!key) return;\n    const fingerprint = getConversationFingerprint(message);\n    if (!fingerprint) return;\n\n    const seen = loadSeenMap();\n    seen[key] = { fingerprint, seenAt: Date.now() };\n    saveSeenMap(seen);\n\n    // Immediately update UI so the badge doesn't come back on refresh.\n    setMessages((prev) => prev.map((msg) => {\n      const msgKey = getConversationKey(msg);\n      if (!msgKey || msgKey !== key) return msg;\n      return { ...msg, unread: false };\n    }));\n  };\n\n  const loadMessages = async (opts = {}) => {\n    const silent = Boolean(opts && typeof opts === \"object\" && opts.silent);\n    if (messagesRefreshInFlight.current) return;\n    messagesRefreshInFlight.current = true;\n\n    if (!silent) {\n      setLoading(true);\n      setError(null);\n    }\n    try {\n      const data = await apiFetchJson(\"/api/messages\");\n      const list = Array.isArray(data) ? data : [];\n      const seen = new Set();\n      const deduped = [];\n      for (const item of list) {\n        const key = item.conversationId\n          || item.conversationUrl\n          || item.id\n          || `${item.accountId || \"\"}|${item.sender || \"\"}|${item.adTitle || \"\"}|${item.message || \"\"}|${item.time || \"\"}`;\n        if (seen.has(key)) continue;\n        seen.add(key);\n        deduped.push(item);\n      }\n      const seenMap = loadSeenMap();\n      const merged = deduped.map((item) => {\n        const key = getConversationKey(item);\n        if (!key) return item;\n        const entry = seenMap[key];\n        if (!entry || typeof entry !== \"object\") return item;\n        const currentFingerprint = getConversationFingerprint(item);\n        if (entry.fingerprint && entry.fingerprint === currentFingerprint) {\n          return { ...item, unread: false };\n        }\n        return item;\n      });\n\n      setMessages(merged);\n      hydrateMissingPreviewImages(merged);\n    } catch (err) {\n      console.error(\"Ошибка загрузки сообщений:\", err);\n      if (!silent) setError(err.message || \"Не удалось загрузить сообщения\");\n    } finally {\n      if (!silent) setLoading(false);\n      messagesRefreshInFlight.current = false;\n    }\n  };\n\n  // NOTE: Backend does not guarantee a \"mark read\" API (and Kleinanzeigen state may lag).\n  // We persist \"seen\" locally so a refresh won't resurrect the \"new\" badge.\n  const markAsRead = (message) => rememberConversationSeen(message);\n\n  const handleReplyImageSelect = (event) => {\n    const files = Array.from(event?.target?.files || []);\n    if (event?.target) event.target.value = \"\";\n    if (!files.length) return;\n\n    const nextItems = files\n      .filter((file) => String(file?.type || \"\").toLowerCase().startsWith(\"image/\"))\n      .slice(0, 10)\n      .map((file) => ({\n        id: `img-${Date.now()}-${Math.random().toString(16).slice(2)}`,\n        file,\n        previewUrl: URL.createObjectURL(file)\n      }));\n\n    if (!nextItems.length) return;\n    setReplyImages((prev) => {\n      const existing = Array.isArray(prev) ? prev : [];\n      return [...existing, ...nextItems].slice(0, 10);\n    });\n  };\n\n  const removeReplyImage = (id) => {\n    setReplyImages((prev) => {\n      const existing = Array.isArray(prev) ? prev : [];\n      const target = existing.find((item) => item?.id === id);\n      if (target?.previewUrl) {\n        URL.revokeObjectURL(target.previewUrl);\n      }\n      return existing.filter((item) => item?.id !== id);\n    });\n  };\n\n  const formatRequestError = (error, fallbackText) => {\n    const baseMessage = String(error?.message || fallbackText || \"Ошибка запроса\").trim();\n    const debugId = error?.data?.debugId || error?.debugId || \"\";\n    const requestId = error?.data?.requestId || error?.requestId || \"\";\n    if (debugId) {\n      return `${baseMessage} (debugId: ${debugId})`;\n    }\n    if (requestId) {\n      return `${baseMessage} (requestId: ${requestId})`;\n    }\n    return baseMessage;\n  };\n\n  const confirmDeclineOffer = async () => {\n    if (!selectedMessage || decliningOffer) return;\n    if (!selectedMessage.conversationId && !selectedMessage.conversationUrl) {\n      alert(\"Не найден идентификатор диалога.\");\n      return;\n    }\n    setDecliningOffer(true);\n    try {\n      const result = await apiFetchJson(\"/api/messages/offer/decline\", {\n        method: \"POST\",\n        timeoutMs: 240000,\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          accountId: selectedMessage.accountId,\n          conversationId: selectedMessage.conversationId,\n          conversationUrl: selectedMessage.conversationUrl\n        })\n      });\n\n      const serverMessages = Array.isArray(result.messages) ? result.messages : [];\n      if (serverMessages.length) {\n        const lastMessage = serverMessages[serverMessages.length - 1];\n        const nextConversationId = result.conversationId || selectedMessage.conversationId;\n        const nextConversationUrl = result.conversationUrl || selectedMessage.conversationUrl;\n        setMessages((prev) => prev.map((msg) => (\n          msg.id === selectedMessage.id\n            ? {\n              ...msg,\n              message: lastMessage?.text || msg.message,\n              date: lastMessage?.date || msg.date,\n              time: lastMessage?.time || msg.time,\n              conversationId: nextConversationId || msg.conversationId,\n              conversationUrl: nextConversationUrl || msg.conversationUrl,\n              unread: false\n            }\n            : msg\n        )));\n        setSelectedMessage((prev) => ({\n          ...prev,\n          messages: serverMessages,\n          conversationId: nextConversationId || prev.conversationId,\n          conversationUrl: nextConversationUrl || prev.conversationUrl\n        }));\n        writeThreadCacheEntry(selectedMessage, {\n          adTitle: selectedMessage.adTitle,\n          adImage: selectedMessage.adImage,\n          sender: selectedMessage.sender,\n          messages: serverMessages,\n          conversationId: nextConversationId,\n          conversationUrl: nextConversationUrl\n        });\n      } else {\n        // Fallback: refresh thread when backend doesn't return messages.\n        fetchThread(selectedMessage, { force: true });\n      }\n      setDeclineConfirmOpen(false);\n    } catch (error) {\n      console.error(\"Ошибка отклонения заявки:\", error, {\n        status: error?.status,\n        code: error?.code,\n        data: error?.data || null\n      });\n      alert(formatRequestError(error, \"Не удалось отклонить заявку\"));\n    } finally {\n      setDecliningOffer(false);\n    }\n  };\n\n  const sendReply = async () => {\n    if (!selectedMessage) return;\n    if (!selectedMessage.conversationId && !selectedMessage.conversationUrl\n      && !selectedMessage.sender && !selectedMessage.adTitle) {\n      alert(\"Не найден идентификатор диалога.\");\n      return;\n    }\n\n    const textToSend = replyText.trim();\n    const imagesToSend = Array.isArray(replyImages) ? replyImages : [];\n    if (imagesToSend.length && !selectedMessage.conversationId && !selectedMessage.conversationUrl) {\n      alert(\"Для отправки фото нужен conversationId диалога. Откройте диалог и попробуйте снова.\");\n      return;\n    }\n    if (!textToSend && imagesToSend.length === 0) return;\n    const now = new Date();\n    const optimisticId = `local-${now.getTime()}-${Math.random().toString(16).slice(2)}`;\n    const optimisticAttachments = imagesToSend.map((item) => ({\n      url: item?.previewUrl || \"\",\n      name: item?.file?.name || \"\",\n      type: item?.file?.type || \"\",\n      local: true\n    })).filter((item) => item?.url);\n    const previewText = textToSend || (optimisticAttachments.length ? \"Фото\" : \"\");\n    const optimisticMessage = {\n      id: optimisticId,\n      text: textToSend,\n      date: now.toISOString().slice(0, 10),\n      time: now.toTimeString().slice(0, 5),\n      direction: \"outgoing\",\n      sender: \"Вы\",\n      pending: true,\n      ...(optimisticAttachments.length ? { attachments: optimisticAttachments } : {})\n    };\n\n    // Optimistic UI: show message immediately in the thread and conversation list.\n    setReplyText(\"\");\n    setReplyImages([]);\n    setSelectedMessage((prev) => {\n      if (!prev) return prev;\n      const existing = Array.isArray(prev.messages) && prev.messages.length\n        ? prev.messages\n        : prev.message\n          ? [{\n            id: prev.id,\n            text: prev.message,\n            sender: prev.sender,\n            date: prev.date,\n            time: prev.time,\n            direction: \"incoming\"\n          }]\n          : [];\n      return {\n        ...prev,\n        messages: [...existing, optimisticMessage]\n      };\n    });\n    setMessages((prev) => prev.map((msg) => (\n      msg.id === selectedMessage.id\n        ? {\n          ...msg,\n          message: previewText,\n          date: optimisticMessage.date,\n          time: optimisticMessage.time,\n          unread: false\n        }\n        : msg\n    )));\n\n    setSending(true);\n    try {\n      const result = optimisticAttachments.length\n        ? await (() => {\n          const form = new FormData();\n          form.append(\"accountId\", String(selectedMessage.accountId));\n          if (selectedMessage.conversationId) form.append(\"conversationId\", String(selectedMessage.conversationId));\n          if (selectedMessage.conversationUrl) form.append(\"conversationUrl\", String(selectedMessage.conversationUrl));\n          if (textToSend) form.append(\"text\", textToSend);\n          imagesToSend.forEach((item) => {\n            if (!item?.file) return;\n            form.append(\"images\", item.file, item.file.name || \"image.jpg\");\n          });\n          return apiFetchJson(\"/api/messages/send-media\", {\n            method: \"POST\",\n            timeoutMs: 240000,\n            body: form\n          });\n        })()\n        : await apiFetchJson(\"/api/messages/send\", {\n          method: \"POST\",\n          timeoutMs: 180000,\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({\n            accountId: selectedMessage.accountId,\n            conversationId: selectedMessage.conversationId,\n            conversationUrl: selectedMessage.conversationUrl,\n            participant: selectedMessage.sender,\n            adTitle: selectedMessage.adTitle,\n            text: textToSend\n          })\n        });\n      if (result.success) {\n        const resolvedConversationId = result.conversationId || selectedMessage.conversationId;\n        const resolvedConversationUrl = result.conversationUrl || selectedMessage.conversationUrl;\n        const serverMessages = Array.isArray(result.messages) ? result.messages : [];\n        const hasSameOutgoing = optimisticAttachments.length\n          ? serverMessages.some((m) => (\n            String(m?.direction || \"\").toLowerCase() === \"outgoing\"\n            && (\n              (Array.isArray(m?.attachments) && m.attachments.length > 0)\n              || (textToSend && String(m?.text || \"\") === textToSend)\n            )\n          ))\n          : serverMessages.some((m) => (\n            String(m?.direction || \"\").toLowerCase() === \"outgoing\"\n            && String(m?.text || \"\") === textToSend\n          ));\n        const nextMessages = serverMessages.length\n          ? (hasSameOutgoing ? serverMessages : [...serverMessages, { ...optimisticMessage, pending: false }])\n          : null;\n\n        if (nextMessages) {\n          const lastMessage = nextMessages[nextMessages.length - 1];\n          setMessages((prev) => prev.map((msg) => (\n            msg.id === selectedMessage.id\n              ? {\n                ...msg,\n                message: lastMessage?.text || msg.message,\n                date: lastMessage?.date || msg.date,\n                time: lastMessage?.time || msg.time,\n                conversationId: resolvedConversationId || msg.conversationId,\n                conversationUrl: resolvedConversationUrl || msg.conversationUrl\n              }\n              : msg\n          )));\n          setSelectedMessage((prev) => ({\n            ...prev,\n            messages: nextMessages,\n            conversationId: resolvedConversationId,\n            conversationUrl: resolvedConversationUrl\n          }));\n          writeThreadCacheEntry(selectedMessage, {\n            adTitle: selectedMessage.adTitle,\n            adImage: selectedMessage.adImage,\n            sender: selectedMessage.sender,\n            messages: nextMessages,\n            conversationId: resolvedConversationId,\n            conversationUrl: resolvedConversationUrl\n          });\n        } else {\n          // Backend may respond without thread messages. Keep optimistic entry and mark it as sent.\n          setSelectedMessage((prev) => {\n            if (!prev) return prev;\n            const updated = Array.isArray(prev.messages) ? prev.messages : [];\n            return {\n              ...prev,\n              messages: updated.map((m) => (m?.id === optimisticId ? { ...m, pending: false } : m)),\n              conversationId: resolvedConversationId,\n              conversationUrl: resolvedConversationUrl\n            };\n          });\n          setMessages((prev) => prev.map((msg) => (\n            msg.id === selectedMessage.id\n              ? {\n                ...msg,\n                conversationId: resolvedConversationId || msg.conversationId,\n                conversationUrl: resolvedConversationUrl || msg.conversationUrl\n              }\n              : msg\n          )));\n        }\n      } else {\n        // Revert optimistic update on logical failure.\n        setSelectedMessage((prev) => {\n          if (!prev) return prev;\n          const updated = Array.isArray(prev.messages) ? prev.messages : [];\n          return { ...prev, messages: updated.filter((m) => m?.id !== optimisticId) };\n        });\n        setReplyText(textToSend);\n        setReplyImages(imagesToSend);\n        const debugId = result?.debugId ? ` (debugId: ${result.debugId})` : \"\";\n        alert(\"Ошибка: \" + (result.error || \"Не удалось отправить\") + debugId);\n      }\n    } catch (err) {\n      console.error(\"Ошибка отправки:\", err, {\n        status: err?.status,\n        code: err?.code,\n        data: err?.data || null\n      });\n      setSelectedMessage((prev) => {\n        if (!prev) return prev;\n        const updated = Array.isArray(prev.messages) ? prev.messages : [];\n        return { ...prev, messages: updated.filter((m) => m?.id !== optimisticId) };\n      });\n      setReplyText(textToSend);\n      setReplyImages(imagesToSend);\n      alert(formatRequestError(err, \"Ошибка при отправке сообщения\"));\n    } finally {\n      setSending(false);\n    }\n  };\n\n  const getTimeAgo = (date, time) => {\n    if (!date && !time) return \"\";\n    const now = new Date();\n    try {\n      const messageDate = new Date(date + \"T\" + (time || \"00:00\"));\n      if (isNaN(messageDate.getTime())) return time || date || \"\";\n      const diffHours = Math.floor((now - messageDate) / (1000 * 60 * 60));\n      if (diffHours < 1) return time || \"Только что\";\n      if (diffHours < 24) return time;\n      if (diffHours < 48) return \"Вчера\";\n      return date;\n    } catch {\n      return time || date || \"\";\n    }\n  };\n\n  const formatMessageDate = (date, time) => {\n    if (!date && !time) return \"\";\n    const parts = [];\n    if (date) {\n      try {\n        const d = new Date(date + \"T00:00\");\n        if (!isNaN(d.getTime())) {\n          const now = new Date();\n          const diffDays = Math.floor((now - d) / (1000 * 60 * 60 * 24));\n          if (diffDays === 0) parts.push(\"Сегодня\");\n          else if (diffDays === 1) parts.push(\"Вчера\");\n          else parts.push(d.toLocaleDateString(\"ru-RU\", { day: \"numeric\", month: \"short\" }));\n        } else {\n          parts.push(date);\n        }\n      } catch {\n        parts.push(date);\n      }\n    }\n    if (time) parts.push(time);\n    return parts.join(\", \");\n  };\n\n  const threadMessages = selectedMessage?.messages?.length\n    ? selectedMessage.messages\n    : selectedMessage\n      ? [{\n        id: selectedMessage.id,\n        text: selectedMessage.message,\n        sender: selectedMessage.sender,\n        date: selectedMessage.date,\n        time: selectedMessage.time,\n        direction: \"incoming\"\n      }]\n      : [];\n\n  const fetchThread = async (message, { force = false } = {}) => {\n    const cached = !force ? readThreadCacheEntry(message) : null;\n    if (cached?.payload) {\n      const cachedPayload = cached.payload;\n      const updatedFromCache = {\n        ...message,\n        adTitle: cachedPayload.adTitle || message.adTitle,\n        adImage: cachedPayload.adImage || message.adImage,\n        sender: message.sender || cachedPayload.sender || \"\",\n        messages: Array.isArray(cachedPayload.messages) ? cachedPayload.messages : [],\n        conversationId: cachedPayload.conversationId || message.conversationId,\n        conversationUrl: cachedPayload.conversationUrl || message.conversationUrl\n      };\n      setMessages((prev) => prev.map((msg) => (\n        String(msg.id) === String(message.id)\n          ? {\n            ...msg,\n            adTitle: updatedFromCache.adTitle,\n            adImage: updatedFromCache.adImage,\n            conversationId: updatedFromCache.conversationId,\n            conversationUrl: updatedFromCache.conversationUrl\n          }\n          : msg\n      )));\n      setSelectedMessage(updatedFromCache);\n      return;\n    }\n\n    setLoadingThread(true);\n    try {\n      const params = new URLSearchParams();\n      params.set(\"accountId\", message.accountId);\n      if (message.conversationId) params.set(\"conversationId\", message.conversationId);\n      if (message.conversationUrl) params.set(\"conversationUrl\", message.conversationUrl);\n      if (!message.conversationId && !message.conversationUrl) {\n        if (message.sender) params.set(\"participant\", message.sender);\n        if (message.adTitle) params.set(\"adTitle\", message.adTitle);\n      }\n      const data = await apiFetchJson(`/api/messages/thread?${params.toString()}`);\n      if (data.success) {\n        const adImage = normalizePreviewImageUrl(data.adImage || message.adImage);\n        const updated = {\n          ...message,\n          adTitle: data.adTitle || message.adTitle,\n          adImage,\n          sender: message.sender || data.participant || \"\",\n          messages: data.messages || [],\n          conversationId: data.conversationId || message.conversationId,\n          conversationUrl: data.conversationUrl || message.conversationUrl\n        };\n        setMessages((prev) => prev.map((msg) => (\n          String(msg.id) === String(message.id)\n            ? {\n              ...msg,\n              adTitle: updated.adTitle,\n              adImage: updated.adImage,\n              conversationId: updated.conversationId,\n              conversationUrl: updated.conversationUrl\n            }\n            : msg\n        )));\n        setSelectedMessage(updated);\n        writeThreadCacheEntry(updated, updated);\n      }\n    } catch (err) {\n      console.error(\"Ошибка загрузки диалога:\", err);\n    } finally {\n      setLoadingThread(false);\n    }\n  };\n\n  const handleKeyDown = (e) => {\n    if (e.key === \"Enter\" && !e.shiftKey) {\n      e.preventDefault();\n      sendReply();\n    }\n  };\n\n  const unreadCount = messages.filter(m => m.unread).length;\n  const showConversationList = !isMobileView || !selectedMessage;\n  const showChatPanel = !isMobileView || Boolean(selectedMessage);\n  const selectedRawPreviewImage = selectedMessage ? getRawMessagePreviewImage(selectedMessage) : \"\";\n  const selectedPreviewImage = selectedMessage\n    ? toMessageImageSrc(selectedRawPreviewImage, selectedMessage?.accountId)\n    : \"\";\n  const selectedDirectPreviewImage = normalizePreviewImageUrl(selectedRawPreviewImage);\n  const hasReplyPayload = Boolean(replyText.trim()) || replyImages.length > 0;\n  const canSendReply = !sending && hasReplyPayload;\n\n  // Spinner SVG for loading states\n  const Spinner = ({ size = 20, color = \"#7dd3fc\" }) => (\n    <svg width={size} height={size} viewBox=\"0 0 24 24\" style={{ animation: \"spin 1s linear infinite\" }}>\n      <circle cx=\"12\" cy=\"12\" r=\"10\" stroke={color} strokeWidth=\"3\" fill=\"none\" strokeDasharray=\"31.4\" strokeDashoffset=\"10\" strokeLinecap=\"round\" />\n    </svg>\n  );\n\n  return (\n    <>\n      <style>{`\n        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }\n        @keyframes pulse { 0%, 100% { opacity: 0.4; } 50% { opacity: 0.8; } }\n        @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }\n        .msg-conv-item:hover { background: rgba(59,130,246,0.12) !important; }\n        .msg-send-btn:hover:not(:disabled) { background: #16a34a !important; }\n        .msg-refresh-btn:hover:not(:disabled) { background: #0284c7 !important; transform: scale(1.02); }\n        .msg-refresh-btn:active:not(:disabled) { transform: scale(0.98); }\n        .msg-translate-btn:hover { opacity: 1 !important; transform: translateY(-1px) scale(1.02) !important; }\n        .msg-translate-btn:active { transform: translateY(0px) scale(0.98) !important; }\n      `}</style>\n\n      <div className=\"section-header\" style={{\n        display: \"flex\",\n        alignItems: \"center\",\n        justifyContent: \"space-between\",\n        gap: \"12px\",\n        marginBottom: \"20px\",\n        flexWrap: \"wrap\"\n      }}>\n        <h2 style={{\n          margin: 0,\n          color: \"#f8fafc\",\n          display: \"flex\",\n          alignItems: \"center\",\n          gap: \"14px\",\n          fontWeight: 700\n        }}>\n          <span style={{\n            width: \"42px\",\n            height: \"42px\",\n            borderRadius: \"14px\",\n            background: \"linear-gradient(135deg, rgba(249, 115, 22, 0.25), rgba(194, 65, 12, 0.2))\",\n            border: \"1px solid rgba(251, 146, 60, 0.4)\",\n            boxShadow: \"0 4px 15px rgba(251, 146, 60, 0.28)\",\n            display: \"flex\",\n            alignItems: \"center\",\n            justifyContent: \"center\"\n          }}>\n            <MessageIcon size={22} color=\"#fdba74\" />\n          </span>\n          Сообщения\n        </h2>\n      </div>\n\n      <div className=\"messages-layout\" style={{ display: \"flex\", gap: \"20px\", height: \"calc(100vh - 220px)\", minHeight: \"500px\" }}>\n        {/* Conversation List */}\n        <div className=\"messages-list\" style={{\n          width: \"400px\",\n          minWidth: \"340px\",\n          background: \"linear-gradient(145deg, rgba(30, 41, 59, 0.6) 0%, rgba(15, 23, 42, 0.95) 100%)\",\n          borderRadius: \"20px\",\n          overflow: \"hidden\",\n          boxShadow: \"0 20px 50px rgba(0,0,0,0.4), 0 0 30px rgba(0,0,0,0.2)\",\n          border: \"1px solid rgba(148,163,184,0.12)\",\n          color: \"#e2e8f0\",\n          display: \"flex\",\n          flexDirection: \"column\",\n          backdropFilter: \"blur(10px)\",\n          ...(showConversationList ? {} : { display: \"none\" })\n        }}>\n          {/* Header */}\n          <div style={{\n            padding: \"16px 20px\",\n            borderBottom: \"1px solid rgba(148,163,184,0.15)\",\n            background: \"rgba(15,23,42,0.5)\"\n          }}>\n            <div style={{ display: \"flex\", justifyContent: \"space-between\", alignItems: \"center\", marginBottom: \"12px\" }}>\n              <h3 style={{ margin: 0, fontSize: \"18px\", fontWeight: 700 }}>Диалоги</h3>\n              {unreadCount > 0 && (\n                <span style={{\n                  padding: \"5px 14px\",\n                  background: \"linear-gradient(135deg, #10b981, #059669)\",\n                  color: \"white\",\n                  borderRadius: \"9999px\",\n                  fontSize: \"12px\",\n                  fontWeight: 600,\n                  boxShadow: \"0 0 12px rgba(16, 185, 129, 0.4)\",\n                  border: \"1px solid rgba(16, 185, 129, 0.3)\"\n                }}>\n                  {unreadCount} {unreadCount === 1 ? \"новое\" : \"новых\"}\n                </span>\n              )}\n            </div>\n            <button\n              className=\"msg-refresh-btn\"\n              onClick={loadMessages}\n              disabled={loading}\n              style={{\n                width: \"100%\",\n                padding: \"10px 16px\",\n                background: loading ? \"rgba(14,165,233,0.3)\" : \"linear-gradient(135deg, #0ea5e9, #0284c7)\",\n                color: \"white\",\n                border: \"none\",\n                borderRadius: \"10px\",\n                fontSize: \"13px\",\n                fontWeight: 600,\n                cursor: loading ? \"not-allowed\" : \"pointer\",\n                display: \"flex\",\n                alignItems: \"center\",\n                justifyContent: \"center\",\n                gap: \"8px\",\n                transition: \"all 0.15s ease\"\n              }}\n            >\n              {loading ? (\n                <>\n                  <Spinner size={16} color=\"#fff\" />\n                  Загрузка сообщений...\n                </>\n              ) : (\n                <>\n                  <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                    <polyline points=\"23 4 23 10 17 10\" />\n                    <path d=\"M20.49 15a9 9 0 1 1-2.12-9.36L23 10\" />\n                  </svg>\n                  Обновить сообщения\n                </>\n              )}\n            </button>\n          </div>\n\n          {/* Error state */}\n          {error && (\n            <div style={{\n              margin: \"12px\",\n              padding: \"12px 16px\",\n              background: \"rgba(239,68,68,0.15)\",\n              border: \"1px solid rgba(239,68,68,0.3)\",\n              borderRadius: \"10px\",\n              fontSize: \"13px\",\n              color: \"#fca5a5\"\n            }}>\n              <div style={{ fontWeight: 600, marginBottom: \"4px\" }}>Ошибка загрузки</div>\n              <div>{error}</div>\n              <button\n                onClick={loadMessages}\n                style={{\n                  marginTop: \"8px\",\n                  padding: \"4px 12px\",\n                  background: \"rgba(239,68,68,0.3)\",\n                  color: \"#fca5a5\",\n                  border: \"1px solid rgba(239,68,68,0.4)\",\n                  borderRadius: \"6px\",\n                  fontSize: \"12px\",\n                  cursor: \"pointer\"\n                }}\n              >\n                Попробовать снова\n              </button>\n            </div>\n          )}\n\n          {/* Conversation list */}\n          <div style={{ flex: 1, overflow: \"auto\" }}>\n            {loading && messages.length === 0 ? (\n              // Loading skeleton\n              <div style={{ padding: \"8px 0\" }}>\n                {[1, 2, 3, 4, 5].map(i => (\n                  <div key={i} style={{\n                    padding: \"14px 20px\",\n                    display: \"flex\",\n                    gap: \"12px\",\n                    alignItems: \"center\",\n                    borderBottom: \"1px solid rgba(148,163,184,0.08)\"\n                  }}>\n                    <div style={{\n                      width: \"52px\",\n                      height: \"52px\",\n                      borderRadius: \"12px\",\n                      background: \"rgba(148,163,184,0.1)\",\n                      flexShrink: 0,\n                      animation: \"pulse 1.5s ease-in-out infinite\"\n                    }} />\n                    <div style={{ flex: 1 }}>\n                      <div style={{\n                        height: \"14px\",\n                        width: \"60%\",\n                        background: \"rgba(148,163,184,0.1)\",\n                        borderRadius: \"4px\",\n                        marginBottom: \"8px\",\n                        animation: \"pulse 1.5s ease-in-out infinite\"\n                      }} />\n                      <div style={{\n                        height: \"12px\",\n                        width: \"80%\",\n                        background: \"rgba(148,163,184,0.08)\",\n                        borderRadius: \"4px\",\n                        marginBottom: \"6px\",\n                        animation: \"pulse 1.5s ease-in-out infinite\",\n                        animationDelay: \"0.1s\"\n                      }} />\n                      <div style={{\n                        height: \"10px\",\n                        width: \"40%\",\n                        background: \"rgba(148,163,184,0.06)\",\n                        borderRadius: \"4px\",\n                        animation: \"pulse 1.5s ease-in-out infinite\",\n                        animationDelay: \"0.2s\"\n                      }} />\n                    </div>\n                  </div>\n                ))}\n              </div>\n            ) : messages.length === 0 && !loading ? (\n              <div style={{\n                padding: \"60px 20px\",\n                textAlign: \"center\",\n                color: \"#64748b\"\n              }}>\n                <div style={{ fontSize: \"40px\", marginBottom: \"12px\", opacity: 0.5 }}>\n                  <svg width=\"48\" height=\"48\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\" style={{ margin: \"0 auto\", display: \"block\", color: \"#475569\" }}>\n                    <path d=\"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z\" />\n                  </svg>\n                </div>\n                <div style={{ fontSize: \"15px\", fontWeight: 600, marginBottom: \"4px\" }}>Нет сообщений</div>\n                <div style={{ fontSize: \"13px\" }}>Нажмите \"Обновить\" для загрузки</div>\n              </div>\n            ) : (\n              messages.map((message) => {\n                const rawPreviewImage = getRawMessagePreviewImage(message);\n                const previewImage = toMessageImageSrc(rawPreviewImage, message?.accountId);\n                const directPreviewImage = normalizePreviewImageUrl(rawPreviewImage);\n                return (\n                <div\n                  key={message.id}\n                  className=\"msg-conv-item\"\n                  onClick={() => {\n                    markAsRead(message);\n                    setSelectedMessage(message);\n                    fetchThread(message);\n                  }}\n                  style={{\n                    padding: \"14px 20px\",\n                    borderBottom: \"1px solid rgba(148,163,184,0.08)\",\n                    cursor: \"pointer\",\n                    background: selectedMessage?.id === message.id\n                      ? \"rgba(59,130,246,0.15)\"\n                      : message.unread\n                        ? \"rgba(34,197,94,0.08)\"\n                        : \"transparent\",\n                    borderLeft: selectedMessage?.id === message.id\n                      ? \"3px solid #3b82f6\"\n                      : message.unread\n                        ? \"3px solid #22c55e\"\n                        : \"3px solid transparent\",\n                    display: \"flex\",\n                    alignItems: \"flex-start\",\n                    gap: \"12px\",\n                    transition: \"background 0.15s ease\",\n                    animation: \"fadeIn 0.2s ease\"\n                  }}\n                >\n                  {/* Product image / avatar */}\n                  <div style={{\n                    width: \"52px\",\n                    height: \"52px\",\n                    borderRadius: \"50%\",\n                    overflow: \"hidden\",\n                    background: \"rgba(15,23,42,0.6)\",\n                    border: \"1px solid rgba(148,163,184,0.15)\",\n                    display: \"flex\",\n                    alignItems: \"center\",\n                    justifyContent: \"center\",\n                    flexShrink: 0\n                  }}>\n                    {previewImage ? (\n                      <img\n                        src={previewImage}\n                        data-direct-src={directPreviewImage || \"\"}\n                        data-fallback-tried=\"0\"\n                        alt=\"\"\n                        style={{ width: \"100%\", height: \"100%\", objectFit: \"cover\" }}\n                        loading=\"lazy\"\n                        referrerPolicy=\"no-referrer\"\n                        onError={(e) => {\n                          const imageNode = e.currentTarget;\n                          const directSrc = String(imageNode.dataset?.directSrc || \"\").trim();\n                          const fallbackTried = imageNode.dataset?.fallbackTried === \"1\";\n                          const currentSrc = String(imageNode.getAttribute(\"src\") || \"\").trim();\n                          if (!fallbackTried && directSrc && directSrc !== currentSrc) {\n                            imageNode.dataset.fallbackTried = \"1\";\n                            imageNode.setAttribute(\"src\", directSrc);\n                            return;\n                          }\n                          imageNode.style.display = \"none\";\n                          const fallbackNode = imageNode.nextElementSibling;\n                          if (fallbackNode) fallbackNode.style.display = \"flex\";\n                        }}\n                      />\n                    ) : null}\n                    <div style={{\n                      width: \"100%\",\n                      height: \"100%\",\n                      background: message.unread\n                        ? \"linear-gradient(135deg, #22c55e, #16a34a)\"\n                        : \"linear-gradient(135deg, #3b82f6, #2563eb)\",\n                      color: \"white\",\n                      display: previewImage ? \"none\" : \"flex\",\n                      alignItems: \"center\",\n                      justifyContent: \"center\",\n                      fontSize: \"20px\",\n                      fontWeight: 700\n                    }}>\n                      {(message.sender || \"?\").charAt(0).toUpperCase()}\n                    </div>\n                  </div>\n\n                  {/* Content */}\n                  <div style={{ flex: 1, minWidth: 0 }}>\n                    {/* Top row: sender + time */}\n                    <div style={{ display: \"flex\", justifyContent: \"space-between\", alignItems: \"center\", marginBottom: \"3px\" }}>\n                      <span style={{\n                        fontWeight: 700,\n                        fontSize: \"14px\",\n                        color: \"#f1f5f9\",\n                        overflow: \"hidden\",\n                        textOverflow: \"ellipsis\",\n                        whiteSpace: \"nowrap\",\n                        maxWidth: \"65%\"\n                      }}>\n                        {message.sender || \"Неизвестный\"}\n                      </span>\n                      <span style={{\n                        fontSize: \"11px\",\n                        color: \"#64748b\",\n                        whiteSpace: \"nowrap\",\n                        flexShrink: 0\n                      }}>\n                        {getTimeAgo(message.date, message.time)}\n                      </span>\n                    </div>\n\n                    {/* Ad title */}\n                    <div style={{\n                      fontSize: \"13px\",\n                      color: \"#94a3b8\",\n                      fontWeight: 600,\n                      overflow: \"hidden\",\n                      textOverflow: \"ellipsis\",\n                      whiteSpace: \"nowrap\",\n                      marginBottom: \"3px\"\n                    }}>\n                      {message.adTitle || \"Без названия\"}\n                    </div>\n\n                    {/* Last message preview */}\n                    <div style={{\n                      fontSize: \"12px\",\n                      color: \"#64748b\",\n                      overflow: \"hidden\",\n                      textOverflow: \"ellipsis\",\n                      whiteSpace: \"nowrap\",\n                      marginBottom: \"4px\"\n                    }}>\n                      {message.message || \"\"}\n                    </div>\n\n                    {/* Account label + unread badge */}\n                    <div style={{\n                      display: \"flex\",\n                      alignItems: \"center\",\n                      gap: \"6px\"\n                    }}>\n                      <span style={{\n                        fontSize: \"11px\",\n                        color: \"#475569\",\n                        background: \"rgba(148,163,184,0.1)\",\n                        padding: \"1px 6px\",\n                        borderRadius: \"4px\"\n                      }}>\n                        {message.accountName}\n                      </span>\n                      {message.unread && (\n                        <span style={{\n                          padding: \"3px 10px\",\n                          background: \"linear-gradient(135deg, #8b5cf6, #7c3aed)\",\n                          color: \"white\",\n                          borderRadius: \"9999px\",\n                          fontSize: \"10px\",\n                          fontWeight: 700,\n                          textTransform: \"uppercase\",\n                          letterSpacing: \"0.5px\",\n                          boxShadow: \"0 0 10px rgba(139, 92, 246, 0.4)\",\n                          border: \"1px solid rgba(139, 92, 246, 0.3)\"\n                        }}>\n                          new\n                        </span>\n                      )}\n                    </div>\n                  </div>\n                </div>\n                );\n              })\n            )}\n          </div>\n\n          {/* Message count footer */}\n          {messages.length > 0 && (\n            <div style={{\n              padding: \"8px 20px\",\n              borderTop: \"1px solid rgba(148,163,184,0.1)\",\n              fontSize: \"11px\",\n              color: \"#475569\",\n              textAlign: \"center\",\n              background: \"rgba(15,23,42,0.3)\"\n            }}>\n              {messages.length} {messages.length === 1 ? \"диалог\" : messages.length < 5 ? \"диалога\" : \"диалогов\"}\n            </div>\n          )}\n        </div>\n\n        {/* Chat Panel */}\n        <div className=\"messages-chat\" style={{\n          flex: 1,\n          position: \"relative\",\n          background: \"linear-gradient(145deg, rgba(30, 41, 59, 0.6) 0%, rgba(15, 23, 42, 0.95) 100%)\",\n          borderRadius: \"20px\",\n          overflow: \"hidden\",\n          boxShadow: \"0 20px 50px rgba(0,0,0,0.4), 0 0 30px rgba(0,0,0,0.2)\",\n          border: \"1px solid rgba(148,163,184,0.12)\",\n          display: \"flex\",\n          flexDirection: \"column\",\n          color: \"#e2e8f0\",\n          backdropFilter: \"blur(10px)\",\n          ...(showChatPanel ? {} : { display: \"none\" })\n        }}>\n          {selectedMessage ? (\n            <>\n              {/* Chat header */}\n              <div style={{\n                padding: \"14px 20px\",\n                borderBottom: \"1px solid rgba(148,163,184,0.15)\",\n                background: \"rgba(15,23,42,0.6)\"\n              }}>\n                <div style={{ display: \"flex\", justifyContent: \"space-between\", alignItems: \"center\" }}>\n                  <div style={{ display: \"flex\", gap: \"14px\", alignItems: \"center\", flex: 1, minWidth: 0 }}>\n                    {/* Product image in header */}\n                    <div style={{\n                      width: \"50px\",\n                      height: \"50px\",\n                      borderRadius: \"10px\",\n                      overflow: \"hidden\",\n                      border: \"1px solid rgba(148,163,184,0.15)\",\n                      background: \"rgba(15,23,42,0.8)\",\n                      flexShrink: 0,\n                      display: \"flex\",\n                      alignItems: \"center\",\n                      justifyContent: \"center\"\n                    }}>\n                      {selectedPreviewImage ? (\n                        <img\n                          src={selectedPreviewImage}\n                          data-direct-src={selectedDirectPreviewImage || \"\"}\n                          data-fallback-tried=\"0\"\n                          alt=\"\"\n                          style={{ width: \"100%\", height: \"100%\", objectFit: \"cover\" }}\n                          onError={(e) => {\n                            const imageNode = e.currentTarget;\n                            const directSrc = String(imageNode.dataset?.directSrc || \"\").trim();\n                            const fallbackTried = imageNode.dataset?.fallbackTried === \"1\";\n                            const currentSrc = String(imageNode.getAttribute(\"src\") || \"\").trim();\n                            if (!fallbackTried && directSrc && directSrc !== currentSrc) {\n                              imageNode.dataset.fallbackTried = \"1\";\n                              imageNode.setAttribute(\"src\", directSrc);\n                              return;\n                            }\n                            imageNode.style.display = \"none\";\n                          }}\n                        />\n                      ) : (\n                        <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#475569\" strokeWidth=\"1.5\">\n                          <rect x=\"3\" y=\"3\" width=\"18\" height=\"18\" rx=\"2\" ry=\"2\" />\n                          <circle cx=\"8.5\" cy=\"8.5\" r=\"1.5\" />\n                          <polyline points=\"21 15 16 10 5 21\" />\n                        </svg>\n                      )}\n                    </div>\n\n                    <div style={{ minWidth: 0 }}>\n                      <div style={{\n                        fontWeight: 700,\n                        fontSize: \"15px\",\n                        color: \"#f1f5f9\",\n                        overflow: \"hidden\",\n                        textOverflow: \"ellipsis\",\n                        whiteSpace: \"nowrap\"\n                      }}>\n                        {selectedMessage.sender || \"Неизвестный\"}\n                      </div>\n                      <div style={{\n                        fontSize: \"13px\",\n                        color: \"#94a3b8\",\n                        fontWeight: 500,\n                        overflow: \"hidden\",\n                        textOverflow: \"ellipsis\",\n                        whiteSpace: \"nowrap\",\n                        marginTop: \"2px\"\n                      }}>\n                        {selectedMessage.adTitle || \"Без названия\"}\n                      </div>\n                      <div style={{\n                        fontSize: \"11px\",\n                        color: \"#475569\",\n                        marginTop: \"2px\"\n                      }}>\n                        {selectedMessage.accountName}\n                      </div>\n                    </div>\n                  </div>\n\n                  <button\n                    onClick={() => setSelectedMessage(null)}\n                    style={{\n                      background: \"rgba(148,163,184,0.1)\",\n                      border: \"none\",\n                      width: isMobileView ? \"auto\" : \"32px\",\n                      height: \"32px\",\n                      padding: isMobileView ? \"0 10px\" : 0,\n                      borderRadius: \"8px\",\n                      cursor: \"pointer\",\n                      color: \"#94a3b8\",\n                      display: \"flex\",\n                      alignItems: \"center\",\n                      justifyContent: \"center\",\n                      fontSize: \"16px\",\n                      fontWeight: 600,\n                      flexShrink: 0\n                    }}\n                  >\n                    {isMobileView ? (\n                      \"← Назад\"\n                    ) : (\n                      <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\">\n                        <line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\" />\n                        <line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\" />\n                      </svg>\n                    )}\n                  </button>\n                </div>\n              </div>\n\n              {/* Messages area */}\n              <div ref={chatScrollRef} style={{\n                flex: 1,\n                padding: \"20px\",\n                overflow: \"auto\",\n                background: \"rgba(8,12,24,0.4)\"\n              }}>\n                {loadingThread ? (\n                  <div style={{\n                    display: \"flex\",\n                    flexDirection: \"column\",\n                    alignItems: \"center\",\n                    justifyContent: \"center\",\n                    height: \"100%\",\n                    gap: \"12px\",\n                    color: \"#64748b\"\n                  }}>\n                    <Spinner size={32} color=\"#3b82f6\" />\n                    <span style={{ fontSize: \"14px\" }}>Загрузка диалога...</span>\n                  </div>\n                ) : threadMessages.length === 0 ? (\n                  <div style={{ color: \"#64748b\", textAlign: \"center\", paddingTop: \"40px\" }}>\n                    <div style={{ fontSize: \"14px\" }}>Нет сообщений в этом диалоге</div>\n                  </div>\n                ) : (\n                  <>\n\t                    {threadMessages.map((messageItem, idx) => {\n\t                      const isOutgoing = messageItem.direction === \"outgoing\";\n\t                      const isPending = Boolean(messageItem.pending);\n\t                      const isOffer = isPaymentAndShippingMessage(messageItem);\n\t                      const messageKey = String(messageItem.id || `idx-${idx}`);\n\t                      const translation = translationByMessageId[messageKey] || null;\n\t                      const hasText = Boolean(String(messageItem.text || \"\").trim());\n\t                      const attachmentSrcs = extractAttachmentUrls(messageItem)\n\t                        .map((url) => toMessageImageSrc(url, selectedMessage?.accountId))\n\t                        .filter(Boolean);\n\t                      const canTranslate = !isOffer && !isOutgoing && hasText;\n\n\t                      const toggleTranslate = async () => {\n\t                        if (!canTranslate) return;\n\n                        // Toggle off when already shown.\n                        if (translation?.shown && translation?.translatedText) {\n                          setTranslationByMessageId((prev) => ({\n                            ...prev,\n                            [messageKey]: { ...prev[messageKey], shown: false }\n                          }));\n                          return;\n                        }\n\n                        // Toggle on when already fetched.\n                        if (translation?.translatedText && !translation?.loading) {\n                          setTranslationByMessageId((prev) => ({\n                            ...prev,\n                            [messageKey]: { ...prev[messageKey], shown: true, error: \"\" }\n                          }));\n                          return;\n                        }\n\n                        if (translateInFlight.current.has(messageKey)) return;\n                        translateInFlight.current.add(messageKey);\n                        setTranslationByMessageId((prev) => ({\n                          ...prev,\n                          [messageKey]: {\n                            ...prev[messageKey],\n                            loading: true,\n                            shown: true,\n                            error: \"\"\n                          }\n                        }));\n\n                        try {\n                          const result = await apiFetchJson(\"/api/translate\", {\n                            method: \"POST\",\n                            headers: { \"Content-Type\": \"application/json\" },\n                            body: JSON.stringify({\n                              text: String(messageItem.text || \"\"),\n                              to: \"ru\",\n                              accountId: selectedMessage?.accountId\n                            })\n                          });\n                          setTranslationByMessageId((prev) => ({\n                            ...prev,\n                            [messageKey]: {\n                              loading: false,\n                              shown: true,\n                              error: \"\",\n                              translatedText: result?.translatedText || \"\"\n                            }\n                          }));\n                        } catch (error) {\n                          console.error(\"Ошибка перевода:\", error);\n                          setTranslationByMessageId((prev) => ({\n                            ...prev,\n                            [messageKey]: {\n                              loading: false,\n                              shown: true,\n                              translatedText: \"\",\n                              error: error?.message || \"Не удалось перевести\"\n                            }\n                          }));\n                        } finally {\n                          translateInFlight.current.delete(messageKey);\n                        }\n\t                      };\n\t                      const offerTitle = String(messageItem?.title || \"Anfrage erhalten\").trim() || \"Anfrage erhalten\";\n\t                      const offerItemCents = pickOfferField(messageItem, \"itemPriceInEuroCent\");\n\t                      const offerShippingCents = pickOfferField(messageItem, \"shippingCostInEuroCent\");\n\t                      const offerTotalCents = pickOfferField(messageItem, \"sellerTotalInEuroCent\");\n\t                      const offerCarrierName = pickOfferField(messageItem, \"carrierName\");\n\t                      const offerOptionName = pickOfferField(messageItem, \"shippingOptionName\");\n\t                      const offerOptionDesc = pickOfferField(messageItem, \"shippingOptionDescription\");\n\t                      const offerLiabilityCents = pickOfferField(messageItem, \"liabilityLimitInEuroCent\");\n\n\t                      const acceptCta = getOfferActionText(\n\t                        messageItem,\n\t                        \"ACCEPT_BUYER_OFFER_LEARN_MORE_ACTION\",\n\t                        \"Anfrage akzeptieren\"\n\t                      );\n\t                      const declineCta = getOfferActionText(\n\t                        messageItem,\n\t                        \"CANCEL_OFFER_ACTION\",\n\t                        \"Anfrage ablehnen\"\n\t                      );\n\t                      const counterCta = getOfferActionText(\n\t                        messageItem,\n\t                        \"MAKE_COUNTER_OFFER_ACTION\",\n\t                        \"Gegenangebot machen\"\n\t                      );\n\t                      return (\n\t                        <div\n\t                          key={messageItem.id || idx}\n\t                          style={{\n                            marginBottom: \"12px\",\n                            display: \"flex\",\n                            justifyContent: isOutgoing ? \"flex-end\" : \"flex-start\",\n                            animation: \"fadeIn 0.2s ease\"\n                          }}\n\t                        >\n\t                          <div style={{\n\t                            maxWidth: isOffer ? \"520px\" : \"70%\",\n\t                            minWidth: isOffer ? \"240px\" : \"120px\"\n\t                          }}>\n\t                            {/* Sender name */}\n\t                            <div style={{\n\t                              fontSize: \"11px\",\n\t                              color: isOutgoing ? \"#86efac\" : \"#7dd3fc\",\n                              fontWeight: 600,\n                              marginBottom: \"4px\",\n                              paddingLeft: isOutgoing ? \"0\" : \"12px\",\n                              paddingRight: isOutgoing ? \"12px\" : \"0\",\n                              textAlign: isOutgoing ? \"right\" : \"left\"\n                            }}>\n\t                              {messageItem.sender || (isOutgoing ? \"Вы\" : selectedMessage.sender || \"\")}\n\t                            </div>\n\n\t                            {isOffer ? (\n\t                              <div style={{\n\t                                borderRadius: \"18px\",\n\t                                padding: \"14px 14px 12px 14px\",\n\t                                background: \"linear-gradient(145deg, rgba(2,6,23,0.55) 0%, rgba(15,23,42,0.95) 58%, rgba(6,78,59,0.22) 100%)\",\n\t                                border: \"1px solid rgba(34,197,94,0.22)\",\n\t                                boxShadow: \"0 18px 40px rgba(0,0,0,0.45)\"\n\t                              }}>\n\t                                <div style={{\n\t                                  display: \"flex\",\n\t                                  justifyContent: \"space-between\",\n\t                                  alignItems: \"flex-start\",\n\t                                  gap: \"12px\",\n\t                                  marginBottom: \"12px\"\n\t                                }}>\n\t                                  <div style={{ display: \"flex\", gap: \"10px\", alignItems: \"center\", minWidth: 0 }}>\n\t                                    <div style={{\n\t                                      width: \"36px\",\n\t                                      height: \"36px\",\n\t                                      borderRadius: \"12px\",\n\t                                      background: \"rgba(34,197,94,0.18)\",\n\t                                      border: \"1px solid rgba(34,197,94,0.25)\",\n\t                                      display: \"flex\",\n\t                                      alignItems: \"center\",\n\t                                      justifyContent: \"center\",\n\t                                      flexShrink: 0\n\t                                    }}>\n\t                                      <span style={{ color: \"#4ade80\", fontWeight: 900, fontSize: \"16px\" }}>€</span>\n\t                                    </div>\n\t                                    <div style={{ minWidth: 0 }}>\n\t                                      <div style={{\n\t                                        fontSize: \"14px\",\n\t                                        fontWeight: 800,\n\t                                        color: \"#bbf7d0\",\n\t                                        overflow: \"hidden\",\n\t                                        textOverflow: \"ellipsis\",\n\t                                        whiteSpace: \"nowrap\"\n\t                                      }}>\n\t                                        {offerTitle}\n\t                                      </div>\n\t                                      <div style={{\n\t                                        fontSize: \"12px\",\n\t                                        color: \"rgba(148,163,184,0.9)\",\n\t                                        marginTop: \"1px\"\n\t                                      }}>\n\t                                        Sicher bezahlen\n\t                                      </div>\n\t                                    </div>\n\t                                  </div>\n\t                                  <div style={{\n\t                                    fontSize: \"20px\",\n\t                                    fontWeight: 900,\n\t                                    color: \"#4ade80\",\n\t                                    whiteSpace: \"nowrap\"\n\t                                  }}>\n\t                                    {formatEuroFromCents(offerTotalCents)}\n\t                                  </div>\n\t                                </div>\n\n\t                                <div style={{ display: \"flex\", flexDirection: \"column\", gap: \"8px\" }}>\n\t                                  <div style={{ display: \"flex\", justifyContent: \"space-between\", color: \"rgba(226,232,240,0.92)\", fontSize: \"13px\" }}>\n\t                                    <span style={{ color: \"rgba(148,163,184,0.95)\" }}>Betrag</span>\n\t                                    <span style={{ fontWeight: 700 }}>{formatEuroFromCents(offerItemCents)}</span>\n\t                                  </div>\n\t                                  <div style={{ display: \"flex\", justifyContent: \"space-between\", color: \"rgba(226,232,240,0.92)\", fontSize: \"13px\" }}>\n\t                                    <span style={{ color: \"rgba(148,163,184,0.95)\" }}>Versand</span>\n\t                                    <span style={{ fontWeight: 700 }}>{formatEuroFromCents(offerShippingCents)}</span>\n\t                                  </div>\n\t                                  <div style={{\n\t                                    display: \"flex\",\n\t                                    justifyContent: \"space-between\",\n\t                                    fontSize: \"13px\",\n\t                                    paddingTop: \"6px\",\n\t                                    borderTop: \"1px solid rgba(148,163,184,0.12)\"\n\t                                  }}>\n\t                                    <span style={{ color: \"rgba(148,163,184,0.95)\", fontWeight: 800 }}>Gesamt</span>\n\t                                    <span style={{ fontWeight: 900, color: \"#e2e8f0\" }}>{formatEuroFromCents(offerTotalCents)}</span>\n\t                                  </div>\n\t                                </div>\n\n\t                                {(offerCarrierName || offerOptionName || offerOptionDesc) ? (\n\t                                  <div style={{\n\t                                    marginTop: \"12px\",\n\t                                    padding: \"12px\",\n\t                                    borderRadius: \"14px\",\n\t                                    background: \"rgba(2,6,23,0.25)\",\n\t                                    border: \"1px solid rgba(148,163,184,0.14)\"\n\t                                  }}>\n\t                                    <div style={{ fontSize: \"13px\", fontWeight: 800, color: \"#e2e8f0\" }}>\n\t                                      Inkl. {offerCarrierName || \"Versand\"} {offerOptionName || \"\"}\n\t                                    </div>\n\t                                    {offerOptionDesc ? (\n\t                                      <div style={{ marginTop: \"4px\", fontSize: \"12px\", color: \"rgba(148,163,184,0.95)\" }}>\n\t                                        {offerOptionDesc}\n\t                                      </div>\n\t                                    ) : null}\n\t                                    {offerLiabilityCents ? (\n\t                                      <div style={{ marginTop: \"6px\", fontSize: \"12px\", color: \"rgba(148,163,184,0.95)\" }}>\n\t                                        Mit Sendungsverfolgung und Haftung bis {formatEuroFromCents(offerLiabilityCents)}\n\t                                      </div>\n\t                                    ) : null}\n\t                                  </div>\n\t                                ) : null}\n\n\t                                {hasText ? (\n\t                                  <div style={{\n\t                                    marginTop: \"12px\",\n\t                                    fontSize: \"13px\",\n\t                                    lineHeight: \"1.5\",\n\t                                    color: \"rgba(226,232,240,0.92)\"\n\t                                  }}>\n\t                                    {messageItem.text}\n\t                                  </div>\n\t                                ) : null}\n\n\t                                <div style={{ marginTop: \"12px\", display: \"flex\", flexDirection: \"column\", gap: \"10px\" }}>\n\t                                  <button\n\t                                    type=\"button\"\n\t                                    disabled\n\t                                    style={{\n\t                                      width: \"100%\",\n\t                                      padding: \"10px 14px\",\n\t                                      borderRadius: \"9999px\",\n\t                                      border: \"1px solid rgba(34,197,94,0.32)\",\n\t                                      background: \"linear-gradient(135deg, rgba(34,197,94,0.55), rgba(22,163,74,0.45))\",\n\t                                      color: \"rgba(255,255,255,0.95)\",\n\t                                      fontWeight: 900,\n\t                                      cursor: \"not-allowed\",\n\t                                      opacity: 0.75\n\t                                    }}\n\t                                    title=\"Скоро\"\n\t                                  >\n\t                                    {acceptCta}\n\t                                  </button>\n\t                                  <div style={{ display: \"flex\", gap: \"10px\" }}>\n\t                                    <button\n\t                                      type=\"button\"\n\t                                      onClick={() => setDeclineConfirmOpen(true)}\n\t                                      disabled={decliningOffer}\n\t                                      style={{\n\t                                        flex: 1,\n\t                                        padding: \"10px 14px\",\n\t                                        borderRadius: \"9999px\",\n\t                                        border: \"1px solid rgba(148,163,184,0.28)\",\n\t                                        background: \"rgba(2,6,23,0.35)\",\n\t                                        color: \"rgba(226,232,240,0.95)\",\n\t                                        fontWeight: 800,\n\t                                        cursor: decliningOffer ? \"not-allowed\" : \"pointer\",\n\t                                        opacity: decliningOffer ? 0.7 : 1\n\t                                      }}\n\t                                    >\n\t                                      {declineCta}\n\t                                    </button>\n\t                                    <button\n\t                                      type=\"button\"\n\t                                      disabled\n\t                                      style={{\n\t                                        flex: 1,\n\t                                        padding: \"10px 14px\",\n\t                                        borderRadius: \"9999px\",\n\t                                        border: \"1px solid rgba(148,163,184,0.22)\",\n\t                                        background: \"rgba(2,6,23,0.25)\",\n\t                                        color: \"rgba(148,163,184,0.95)\",\n\t                                        fontWeight: 800,\n\t                                        cursor: \"not-allowed\",\n\t                                        opacity: 0.75\n\t                                      }}\n\t                                      title=\"Скоро\"\n\t                                    >\n\t                                      {counterCta}\n\t                                    </button>\n\t                                  </div>\n\t                                </div>\n\n\t                                <div style={{\n\t                                  fontSize: \"10px\",\n\t                                  color: \"rgba(148,163,184,0.8)\",\n\t                                  marginTop: \"10px\",\n\t                                  textAlign: \"right\"\n\t                                }}>\n\t                                  {isPending ? \"Отправка...\" : formatMessageDate(\n\t                                    messageItem.date || selectedMessage.date,\n\t                                    messageItem.time || selectedMessage.time\n\t                                  )}\n\t                                </div>\n\t                              </div>\n\t                            ) : (\n\t                              <div style={{\n\t                                position: \"relative\",\n\t                                padding: canTranslate ? \"10px 14px 18px 14px\" : \"10px 14px\",\n\t                                borderRadius: isOutgoing ? \"14px 14px 4px 14px\" : \"14px 14px 14px 4px\",\n\t                                background: isOutgoing\n\t                                  ? \"linear-gradient(135deg, #1a4731, #14532d)\"\n\t                                  : \"rgba(15,23,42,0.8)\",\n\t                                border: isOutgoing\n\t                                  ? \"1px solid rgba(34,197,94,0.25)\"\n\t                                  : \"1px solid rgba(148,163,184,0.15)\"\n\t                              }}>\n\t                                {attachmentSrcs.length > 0 && (\n\t                                  <div style={{\n\t                                    display: \"grid\",\n\t                                    gridTemplateColumns: \"repeat(auto-fit, minmax(120px, 1fr))\",\n\t                                    gap: \"8px\",\n\t                                    marginBottom: hasText ? \"8px\" : \"0\"\n\t                                  }}>\n\t                                    {attachmentSrcs.map((src, imageIdx) => (\n\t                                      <img\n\t                                        key={`${messageKey}-img-${imageIdx}`}\n\t                                        src={src}\n\t                                        alt=\"\"\n\t                                        loading=\"lazy\"\n\t                                        referrerPolicy=\"no-referrer\"\n\t                                        style={{\n\t                                          width: \"100%\",\n\t                                          maxHeight: \"220px\",\n\t                                          objectFit: \"cover\",\n\t                                          borderRadius: \"12px\",\n\t                                          border: \"1px solid rgba(148,163,184,0.14)\"\n\t                                        }}\n\t                                      />\n\t                                    ))}\n\t                                  </div>\n\t                                )}\n\n\t                                {hasText ? (\n\t                                  <div style={{\n\t                                    fontSize: \"14px\",\n\t                                    lineHeight: \"1.5\",\n\t                                    whiteSpace: \"pre-wrap\",\n\t                                    wordBreak: \"break-word\",\n\t                                    color: \"#e2e8f0\"\n\t                                  }}>\n\t                                    {messageItem.text}\n\t                                  </div>\n\t                                ) : null}\n\n\t                                {/* Translate button */}\n\t                                {canTranslate && (\n\t                                  <button\n\t                                    type=\"button\"\n\t                                    className=\"msg-translate-btn\"\n\t                                    onClick={toggleTranslate}\n\t                                    title=\"Перевести на русский\"\n\t                                    style={{\n\t                                      position: \"absolute\",\n\t                                      left: \"8px\",\n\t                                      bottom: \"6px\",\n\t                                      width: \"22px\",\n\t                                      height: \"22px\",\n\t                                      borderRadius: \"8px\",\n\t                                      border: \"1px solid rgba(148,163,184,0.18)\",\n\t                                      background: \"rgba(2,6,23,0.25)\",\n\t                                      color: \"#94a3b8\",\n\t                                      display: \"inline-flex\",\n\t                                      alignItems: \"center\",\n\t                                      justifyContent: \"center\",\n\t                                      cursor: \"pointer\",\n\t                                      opacity: 0.75,\n\t                                      transition: \"transform 0.12s ease, opacity 0.12s ease, background 0.12s ease\"\n\t                                    }}\n\t                                  >\n\t                                    <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n\t                                      <path d=\"M5 5h6\" />\n\t                                      <path d=\"M8 5c0 6-3 10-6 12\" />\n\t                                      <path d=\"M7 13c2 2 4 4 7 6\" />\n\t                                      <path d=\"M14 19h7\" />\n\t                                      <path d=\"M17 4l4 15\" />\n\t                                      <path d=\"M20 19l-3-9-3 9\" />\n\t                                    </svg>\n\t                                  </button>\n\t                                )}\n\n\t                                {/* Translation result */}\n\t                                {translation?.shown && (\n\t                                  <div style={{\n\t                                    marginTop: \"10px\",\n\t                                    paddingTop: \"8px\",\n\t                                    borderTop: \"1px dashed rgba(148,163,184,0.18)\",\n\t                                    fontSize: \"13px\",\n\t                                    lineHeight: \"1.45\",\n\t                                    color: translation?.error ? \"#fb7185\" : \"#cbd5e1\",\n\t                                    opacity: 0.95\n\t                                  }}>\n\t                                    {translation?.loading ? (\n\t                                      <span style={{ color: \"#94a3b8\" }}>Перевод...</span>\n\t                                    ) : translation?.error ? (\n\t                                      <span>{translation.error}</span>\n\t                                    ) : (\n\t                                      <span>{translation.translatedText}</span>\n\t                                    )}\n\t                                  </div>\n\t                                )}\n\n\t                                {/* Timestamp */}\n\t                                <div style={{\n\t                                  fontSize: \"10px\",\n\t                                  color: \"#64748b\",\n\t                                  marginTop: \"6px\",\n\t                                  textAlign: \"right\"\n\t                                }}>\n\t                                  {isPending ? \"Отправка...\" : formatMessageDate(\n\t                                    messageItem.date || selectedMessage.date,\n\t                                    messageItem.time || selectedMessage.time\n\t                                  )}\n\t                                </div>\n\t                              </div>\n\t                            )}\n\t                          </div>\n\t                        </div>\n\t                      );\n\t                    })}\n                  </>\n                )}\n              </div>\n\n              {/* Reply input */}\n              <div style={{\n                padding: \"14px 20px\",\n                borderTop: \"1px solid rgba(148,163,184,0.15)\",\n                background: \"rgba(15,23,42,0.6)\"\n              }}>\n                <input\n                  ref={fileInputRef}\n                  type=\"file\"\n                  accept=\"image/*\"\n                  multiple\n                  onChange={handleReplyImageSelect}\n                  style={{ display: \"none\" }}\n                />\n\n                {replyImages.length > 0 && (\n                  <div style={{\n                    marginBottom: \"10px\",\n                    display: \"flex\",\n                    gap: \"8px\",\n                    overflowX: \"auto\",\n                    paddingBottom: \"2px\"\n                  }}>\n                    {replyImages.map((item) => (\n                      <div\n                        key={item.id}\n                        style={{\n                          position: \"relative\",\n                          width: \"72px\",\n                          height: \"72px\",\n                          borderRadius: \"10px\",\n                          border: \"1px solid rgba(148,163,184,0.2)\",\n                          overflow: \"hidden\",\n                          flexShrink: 0\n                        }}\n                      >\n                        <img\n                          src={item.previewUrl}\n                          alt=\"\"\n                          style={{ width: \"100%\", height: \"100%\", objectFit: \"cover\" }}\n                        />\n                        <button\n                          type=\"button\"\n                          onClick={() => removeReplyImage(item.id)}\n                          style={{\n                            position: \"absolute\",\n                            top: \"4px\",\n                            right: \"4px\",\n                            width: \"20px\",\n                            height: \"20px\",\n                            borderRadius: \"9999px\",\n                            border: \"none\",\n                            background: \"rgba(2,6,23,0.72)\",\n                            color: \"#f8fafc\",\n                            fontSize: \"12px\",\n                            cursor: \"pointer\",\n                            display: \"flex\",\n                            alignItems: \"center\",\n                            justifyContent: \"center\"\n                          }}\n                          title=\"Удалить\"\n                        >\n                          ×\n                        </button>\n                      </div>\n                    ))}\n                  </div>\n                )}\n\n                <div style={{ display: \"flex\", gap: \"10px\", alignItems: \"flex-end\" }}>\n                  <button\n                    type=\"button\"\n                    onClick={() => fileInputRef.current?.click()}\n                    disabled={sending}\n                    aria-label=\"Bilder hochladen\"\n                    style={{\n                      width: \"42px\",\n                      height: \"42px\",\n                      borderRadius: \"12px\",\n                      border: \"1px solid rgba(148,163,184,0.25)\",\n                      background: \"rgba(15,23,42,0.7)\",\n                      color: \"#cbd5e1\",\n                      cursor: sending ? \"not-allowed\" : \"pointer\",\n                      display: \"flex\",\n                      alignItems: \"center\",\n                      justifyContent: \"center\",\n                      flexShrink: 0\n                    }}\n                  >\n                    <svg viewBox=\"0 0 24 24\" width=\"18\" height=\"18\" fill=\"currentColor\" aria-hidden=\"true\">\n                      <path d=\"M12.0004 8.54376C9.72753 8.54376 7.88501 10.4042 7.88501 12.6991C7.88501 14.994 9.72753 16.8544 12.0004 16.8544C14.2733 16.8544 16.1158 14.994 16.1158 12.6991C16.1158 10.4042 14.2733 8.54376 12.0004 8.54376ZM9.88501 12.6991C9.88501 11.5195 10.8321 10.5632 12.0004 10.5632C13.1687 10.5632 14.1158 11.5195 14.1158 12.6991C14.1158 13.8787 13.1687 14.835 12.0004 14.835C10.8321 14.835 9.88501 13.8787 9.88501 12.6991Z\" />\n                      <path d=\"M9.23077 4C8.91601 4 8.61962 4.14963 8.43077 4.40388L6.65385 6.79612H4.38462C3.75218 6.79612 3.14564 7.04979 2.69844 7.50134C2.25124 7.95288 2 8.5653 2 9.20388V17.5922C2 18.2308 2.25124 18.8432 2.69844 19.2948C3.14564 19.7463 3.75218 20 4.38462 20H19.6154C20.2478 20 20.8544 19.7463 21.3016 19.2948C21.7488 18.8432 22 18.2308 22 17.5922V9.20388C22 8.5653 21.7488 7.95288 21.3016 7.50134C20.8544 7.04979 20.2478 6.79612 19.6154 6.79612H17.3462L15.5692 4.40388C15.3804 4.14963 15.084 4 14.7692 4H9.23077ZM7.95385 8.41165L9.73077 6.01942H14.2692L16.0462 8.41165C16.235 8.6659 16.5314 8.81553 16.8462 8.81553H19.6154C19.7179 8.81553 19.8163 8.85665 19.8888 8.9292C19.9614 9.00175 20.0025 9.10014 20.0025 9.20263V17.5909C20.0025 17.6934 19.9614 17.7918 19.8888 17.8644C19.8163 17.9369 19.7179 17.978 19.6154 17.978H4.38462C4.28208 17.978 4.1837 17.9369 4.11115 17.8644C4.0386 17.7918 3.99748 17.6934 3.99748 17.5909V9.20263C3.99748 9.10014 4.0386 9.00175 4.11115 8.9292C4.1837 8.85665 4.28208 8.81553 4.38462 8.81553H7.15385C7.4686 8.81553 7.765 8.6659 7.95385 8.41165Z\" />\n                    </svg>\n                  </button>\n\n                  <textarea\n                    value={replyText}\n                    onChange={(e) => setReplyText(e.target.value)}\n                    onKeyDown={handleKeyDown}\n                    placeholder=\"Nachricht schreiben...\"\n                    rows={1}\n                    style={{\n                      flex: 1,\n                      padding: \"10px 14px\",\n                      border: \"1px solid rgba(148,163,184,0.2)\",\n                      borderRadius: \"12px\",\n                      resize: \"none\",\n                      minHeight: \"42px\",\n                      maxHeight: \"120px\",\n                      background: \"rgba(15,23,42,0.6)\",\n                      color: \"#e2e8f0\",\n                      fontSize: \"14px\",\n                      lineHeight: \"1.4\",\n                      outline: \"none\",\n                      fontFamily: \"inherit\"\n                    }}\n                    onInput={(e) => {\n                      e.target.style.height = \"42px\";\n                      e.target.style.height = Math.min(e.target.scrollHeight, 120) + \"px\";\n                    }}\n                  />\n\n                  <button\n                    className=\"msg-send-btn\"\n                    onClick={sendReply}\n                    disabled={!canSendReply}\n                    style={{\n                      padding: \"10px 20px\",\n                      background: sending\n                        ? \"rgba(34,197,94,0.4)\"\n                        : !hasReplyPayload\n                          ? \"rgba(148,163,184,0.15)\"\n                          : \"linear-gradient(135deg, #22c55e, #16a34a)\",\n                      color: !hasReplyPayload ? \"#64748b\" : \"white\",\n                      border: \"none\",\n                      borderRadius: \"12px\",\n                      cursor: !canSendReply ? \"not-allowed\" : \"pointer\",\n                      whiteSpace: \"nowrap\",\n                      fontSize: \"14px\",\n                      fontWeight: 600,\n                      display: \"flex\",\n                      alignItems: \"center\",\n                      gap: \"6px\",\n                      height: \"42px\",\n                      transition: \"all 0.15s ease\"\n                    }}\n                  >\n                    {sending ? (\n                      <>\n                        <Spinner size={14} color=\"#fff\" />\n                        <span>Отправка</span>\n                      </>\n                    ) : (\n                      <>\n                        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                          <line x1=\"22\" y1=\"2\" x2=\"11\" y2=\"13\" />\n                          <polygon points=\"22 2 15 22 11 13 2 9 22 2\" />\n                        </svg>\n                        <span>Отправить</span>\n                      </>\n                    )}\n                  </button>\n                </div>\n                <div style={{ fontSize: \"11px\", color: \"#475569\", marginTop: \"6px\" }}>\n                  Enter для отправки, Shift+Enter для новой строки\n                </div>\n              </div>\n\n              {declineConfirmOpen && (\n                <div style={{\n                  position: \"absolute\",\n                  inset: 0,\n                  background: \"rgba(2,6,23,0.65)\",\n                  backdropFilter: \"blur(2px)\",\n                  display: \"flex\",\n                  alignItems: \"center\",\n                  justifyContent: \"center\",\n                  zIndex: 40,\n                  padding: \"16px\"\n                }}>\n                  <div style={{\n                    width: \"100%\",\n                    maxWidth: \"420px\",\n                    borderRadius: \"16px\",\n                    border: \"1px solid rgba(148,163,184,0.2)\",\n                    background: \"linear-gradient(145deg, rgba(15,23,42,0.96), rgba(2,6,23,0.98))\",\n                    boxShadow: \"0 18px 60px rgba(0,0,0,0.5)\",\n                    padding: \"18px\"\n                  }}>\n                    <div style={{ fontSize: \"16px\", fontWeight: 700, color: \"#f8fafc\", marginBottom: \"8px\" }}>\n                      Anfrage ablehnen\n                    </div>\n                    <div style={{ fontSize: \"13px\", lineHeight: \"1.5\", color: \"#94a3b8\", marginBottom: \"16px\" }}>\n                      Möchtest du diese Anfrage wirklich ablehnen?\n                    </div>\n                    <div style={{ display: \"flex\", gap: \"10px\", justifyContent: \"flex-end\" }}>\n                      <button\n                        type=\"button\"\n                        onClick={() => setDeclineConfirmOpen(false)}\n                        disabled={decliningOffer}\n                        style={{\n                          padding: \"10px 14px\",\n                          borderRadius: \"10px\",\n                          border: \"1px solid rgba(148,163,184,0.22)\",\n                          background: \"rgba(15,23,42,0.65)\",\n                          color: \"#cbd5e1\",\n                          cursor: decliningOffer ? \"not-allowed\" : \"pointer\"\n                        }}\n                      >\n                        Abbrechen\n                      </button>\n                      <button\n                        type=\"button\"\n                        onClick={confirmDeclineOffer}\n                        disabled={decliningOffer}\n                        style={{\n                          padding: \"10px 14px\",\n                          borderRadius: \"10px\",\n                          border: \"1px solid rgba(239,68,68,0.35)\",\n                          background: \"linear-gradient(135deg, rgba(239,68,68,0.78), rgba(185,28,28,0.82))\",\n                          color: \"#fff\",\n                          fontWeight: 700,\n                          cursor: decliningOffer ? \"not-allowed\" : \"pointer\",\n                          display: \"inline-flex\",\n                          alignItems: \"center\",\n                          gap: \"6px\",\n                          minWidth: \"158px\",\n                          justifyContent: \"center\"\n                        }}\n                      >\n                        {decliningOffer ? (\n                          <>\n                            <Spinner size={14} color=\"#fff\" />\n                            <span>Bitte warten</span>\n                          </>\n                        ) : (\n                          \"Anfrage ablehnen\"\n                        )}\n                      </button>\n                    </div>\n                  </div>\n                </div>\n              )}\n            </>\n          ) : (\n            // Empty state\n            <div style={{\n              flex: 1,\n              display: \"flex\",\n              alignItems: \"center\",\n              justifyContent: \"center\",\n              color: \"#475569\"\n            }}>\n              <div style={{ textAlign: \"center\", maxWidth: \"280px\" }}>\n                <svg width=\"64\" height=\"64\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1\" style={{ margin: \"0 auto 16px\", display: \"block\", color: \"#334155\" }}>\n                  <path d=\"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z\" />\n                </svg>\n                <h3 style={{ margin: \"0 0 8px\", fontSize: \"16px\", color: \"#64748b\" }}>\n                  Выберите диалог\n                </h3>\n                <p style={{ margin: 0, fontSize: \"13px\", lineHeight: \"1.5\" }}>\n                  Выберите диалог из списка слева для просмотра сообщений и ответа\n                </p>\n              </div>\n            </div>\n          )}\n        </div>\n      </div>\n    </>\n  );\n};\n\nexport default MessagesTab;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}