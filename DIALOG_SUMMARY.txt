Барвиха / Kleinanzeigen Manager — краткая сводка диалога (sanitized, обновлено 2026-02-09)

Контекст
- Проект: менеджер для работы с kleinanzeigen.de (сообщения + публикации + аккаунты).
- Локально: /Users/eurocare/Downloads/barvihaluxury-main
- На VDS: /opt/barvikha
- Стек: frontend (React), backend (Node/Express + puppeteer), nginx reverse-proxy, systemd.

Что просили сделать (функционал)
1) Сообщения (Meine Nachrichten)
- Оформление “предложение на покупку / Sicher bezahlen” как на Kleinanzeigen (карточка с суммами/доставкой и кнопками).
- Кнопка отклонения предложения: “Anfrage ablehnen” с подтверждениями (в итоге выяснилось: 3 последовательные кнопки в разных модалках).
- Отправка фото в сообщениях (кнопка-камера, как на Kleinanzeigen).
- Исправить превью диалогов на мобильных: вместо “буквы-аватарки” показывать фото товара.
- Автообновление списка диалогов (обсуждали период ~3 минуты), корректное “прочитано”.

2) Публикация объявлений
- Возможность удалять добавленные фото.
- Возможность менять порядок фото (drag&drop по зажатию правой кнопки мыши).
- Заменить строку выбора файла на “плашку-дропзону” (как в меню “Добавить аккаунт”).
- Ускорение загрузки списка объявлений (идея: кэш/предзагрузка).

3) UI/навигация
- Desktop: горизонтальные разделы, активный раздел с тонким подчёркиванием, hover.
- Mobile: адекватная верстка/меню.

Деплой/гит: что пошло не так
- Команда вида `git fetch origin && git reset --hard origin/main` откатывает ВЕСЬ репозиторий (и backend, и frontend). Из-за этого “нормальный фронт” мог “слетать”, если на main был старый UI.
- На сервере был кейс с невозможностью push/pull из-под root из-за read-only SSH key (“marked as read only”).
- Nginx reload падал из-за дубля директивы `proxy_connect_timeout` в /etc/nginx/conf.d/kl-timeouts.conf.

Что делали по дебагу “Failed to fetch” и почему это важно
- На UI “Failed to fetch” соответствовало backend-ошибкам 5xx/таймаутам и прокси-ошибкам внутри puppeteer.
- Добавили/использовали сопоставление requestId из UI с логом backend:
  - backend/data/debug/message-actions.log (clientRequestId/debugId, start/payload/service-start/service-error/response-close).
- Добавили артефакты по действиям в сообщениях:
  - backend/data/debug/message-action-artifacts/<debugId>/*.html/*.png/*.json
  - Цель: понимать, что реально видит страница (cookie/GDPR модалки, skeleton/spinner, отсутствие нужных кнопок/инпутов).

Основные ошибки, которые всплыли в логах сообщений
- PROXY_TUNNEL_CONNECTION_FAILED (например: net::ERR_TUNNEL_CONNECTION_FAILED / ERR_NO_SUPPORTED_PROXIES) -> UI “Failed to fetch”.
- MESSAGE_ACTION_TIMEOUT (55s/90s route deadline). Часто были “late-service-error” спустя минуты: это означало, что puppeteer зависал/долго ждал, даже после ответа роутера.
- MESSAGE_FILE_INPUT_NOT_FOUND при отправке фото (инпут/кнопка камеры не найдены; часто на фоне skeleton/вечной загрузки).
- MESSAGE_MEDIA_SEND_NOT_CONFIRMED (нет подтверждения, что медиа реально отправилось).
- DECLINE_BUTTON_NOT_FOUND / DECLINE_NOT_APPLIED при отклонении предложения (селекторы/порядок модалок/проверка результата).
- AUTH_REQUIRED и “detached Frame” (страница/фрейм перезагрузились или ушли на экран логина/consent).

Гипотеза, которую подтвердили артефакты
- Cookie/GDPR/consent модалка (и вообще “первый экран” после goto) может блокировать клики/поиск элементов.
- Требование: принимать cookies/consent перед любыми действиями (переходы, клики, загрузка композера сообщений).

Где смотреть логи/артефакты
- backend/data/debug/message-actions.log
- backend/data/debug/message-action-artifacts/
- (публикация) backend/data/debug/publish-steps.log и backend/data/debug/publish-requests.log

Текущее состояние на момент последнего шага
- Отправка фото и отклонение предложения остаются нестабильными: часть ошибок ушла, но регулярно воспроизводятся таймауты/consent/поиск элементов.
- Задача дальше: стабилизировать принятие cookies/consent, корректно детектить готовность UI сообщения (без “вечных ожиданий”), и сделать детерминированный flow отклонения (3 модалки) + корректный upload через “камера/инпут”.
